<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Hub | V20.0 Coin Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <style>
        :root { --primary: #6366f1; --accent: #f472b6; }
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #312e81, #be185d, #0f766e);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff; min-height: 100vh; overflow-x: hidden; cursor: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #cursor { position: fixed; width: 20px; height: 20px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .glass-card:hover { transform: translateY(-5px); }
        nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 6px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; justify-content: center; width: 90%; max-width: 600px; }
        .nav-btn { padding: 10px 16px; border-radius: 18px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; color: #94a3b8; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.5s forwards; padding-bottom: 120px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .glow-green { box-shadow: 0 0 40px #22c55e !important; border-color: #22c55e !important; }
        .glow-red { box-shadow: 0 0 40px #ef4444 !important; border-color: #ef4444 !important; }
        .mic-ripple { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--primary); opacity: 0; animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }
        .song-item { display: flex; gap: 12px; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; align-items: center; }
        .song-item:hover { background: rgba(255,255,255,0.15); }
        .song-item img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        #progress-bar { width: 0%; height: 4px; background: #22c55e; transition: width 0.1s linear; position: absolute; bottom: 0; left: 0; }
        
        /* READING MODE STYLES */
        .reading-text { line-height: 1.8; letter-spacing: 1px; text-align: justify; }
        textarea:focus { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }

        /* COIN HUD ANIMATION */
        @keyframes coinPop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        .coin-pop-green { animation: coinPop 0.3s ease; color: #4ade80 !important; }
        .coin-pop-red { animation: coinPop 0.3s ease; color: #f87171 !important; }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="cursor"></div>

<div class="fixed top-6 right-6 z-[2000] flex items-center gap-3 bg-black/40 backdrop-blur-xl px-5 py-2 rounded-full border border-yellow-500/30 shadow-2xl transition hover:scale-105">
    <div class="w-10 h-10">
        <model-viewer src="./coin.glb" 
                      alt="Coin" 
                      auto-rotate 
                      rotation-per-second="30deg"
                      disable-zoom
                      style="width: 100%; height: 100%; --poster-color: transparent;">
        </model-viewer>
    </div>
    <div class="flex flex-col items-end">
        <span class="text-[9px] font-bold text-yellow-500/80 uppercase tracking-widest">Balance</span>
        <span id="coin-display" class="text-2xl font-black text-yellow-400 leading-none tabular-nums">0</span>
    </div>
</div>

<nav>
    <button onclick="switchTab('home')" class="nav-btn active" id="n-home">Sảnh</button>
    <button onclick="switchTab('vocab')" class="nav-btn" id="n-vocab">Học Từ</button>
    <button onclick="switchTab('reading')" class="nav-btn" id="n-reading">Đọc Hiểu</button>
    <button onclick="switchTab('speaking')" class="nav-btn" id="n-speaking">Luyện Nói</button>
    <button onclick="switchTab('grammar')" class="nav-btn" id="n-grammar">Ngữ Pháp</button>
    <button onclick="switchTab('music')" class="nav-btn" id="n-music">Nhạc</button>
</nav>

<div id="home" class="tab-content active">
    <div class="h-screen flex items-center justify-center">
        <div class="glass-card p-12 text-center max-w-md mx-4">
            <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SKYREIGN</h1>
            <p class="text-xs tracking-[0.5em] text-gray-400 uppercase mb-10">Lưu Thiết Hoa • V20.0 Coin Master</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('vocab')" class="py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs uppercase tracking-widest transition">Luyện Từ</button>
                <button onclick="switchTab('reading')" class="py-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-bold text-xs uppercase tracking-widest transition shadow-lg shadow-indigo-500/30">Đọc Hiểu</button>
            </div>
        </div>
    </div>
</div>

<div id="reading" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-8 w-full max-w-3xl mx-4 relative" id="reading-card">
            <div class="flex justify-between items-center mb-6">
                <div class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest">Đoạn Văn Ngẫu Nhiên</div>
                <button onclick="nextParagraph()" class="text-[10px] font-bold text-gray-400 hover:text-white uppercase tracking-widest transition">Đổi bài khác ↻</button>
            </div>
            <div class="bg-black/20 p-6 rounded-2xl mb-6 border border-white/10">
                <p id="r-text" class="text-xl md:text-2xl font-medium text-gray-100 reading-text">...</p>
            </div>
            <p class="text-xs text-gray-400 mb-2 italic">Hãy dịch đoạn văn trên sang Tiếng Việt (Đúng ý là có tiền):</p>
            <textarea id="r-input" rows="4" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white placeholder-gray-600 outline-none focus:border-indigo-500 transition mb-6" placeholder="Gõ bản dịch của bạn vào đây..."></textarea>
            <button onclick="checkReading()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-indigo-400 hover:text-white transition mb-4 shadow-lg">Kiểm Tra Bản Dịch</button>
            <div id="r-feedback" class="text-center min-h-[60px]">
                <p id="r-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></p>
                <div id="r-hint" class="text-[12px] text-green-300 hidden text-left bg-black/40 p-4 rounded-xl mt-2 border border-green-500/30"></div>
            </div>
        </div>
    </div>
</div>

<div id="vocab" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-lg mx-4 relative" id="vocab-card">
            <div class="flex justify-between items-center mb-8">
                <button onclick="changeVocabMode()" id="v-mode-btn" class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition">Mode: Hán ➔ Việt</button>
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">HSK 1 FULL</div>
            </div>
            <div id="v-question" class="text-7xl font-black text-center mb-8 tracking-tighter min-h-[100px] flex items-center justify-center">?</div>
            <input type="text" id="v-input" placeholder="Nhập đáp án..." class="w-full bg-transparent border-b-2 border-white/20 py-3 text-center font-bold text-2xl outline-none focus:border-indigo-500 transition text-white placeholder-gray-600 mb-8" autocomplete="off">
            <button onclick="checkVocab()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-gray-200 transition mb-4">Kiểm Tra</button>
            <div id="v-feedback" class="text-center h-10">
                <p id="v-msg" class="text-[11px] font-bold uppercase tracking-widest"></p>
                <p id="v-hint" class="text-[10px] text-gray-400 mt-1"></p>
            </div>
        </div>
    </div>
</div>

<div id="speaking" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-md mx-4 text-center relative overflow-hidden" id="speak-card">
            <div class="text-[10px] uppercase tracking-widest text-indigo-400 font-black mb-8">V18.0 - Fast Catch</div>
            <div class="mb-8 relative group">
                <div id="s-hz" class="text-9xl font-black mb-2 tracking-tighter cursor-pointer transition hover:text-indigo-400" onclick="speakText(document.getElementById('s-hz').innerText)">我</div>
                <div id="s-py" class="text-2xl text-gray-500 mb-1">wǒ</div>
                <div id="s-mn" class="text-xs font-bold bg-white/10 px-3 py-1 rounded-full inline-block">TÔI</div>
            </div>
            <div class="flex justify-center items-center gap-6 mb-8">
                <button onclick="changeSpeakWord(-1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">←</button>
                <div class="relative">
                    <div id="mic-ring" class="hidden mic-ripple"></div>
                    <button id="mic-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl relative z-10 transition hover:scale-110 active:scale-90 text-white">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    </button>
                </div>
                <button onclick="changeSpeakWord(1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">→</button>
            </div>
            <div id="s-feedback" class="text-[11px] font-bold uppercase tracking-widest text-gray-400 h-16 flex flex-col items-center justify-center px-4">
                <span id="s-status">Bấm mic và nói ngay</span>
                <span id="s-sub" class="text-[9px] text-gray-500 mt-1"></span>
            </div>
            <div id="s-live-text" class="absolute bottom-1 w-full text-center text-[9px] text-indigo-300/50 uppercase tracking-widest"></div>
            <div id="progress-bar"></div>
        </div>
    </div>
</div>

<div id="grammar" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden" id="grammar-card">
            <div class="flex justify-between items-center mb-10">
                <button onclick="toggleGrammarMode()" id="g-mode-badge" class="text-[10px] font-black bg-indigo-600 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-110 transition shadow-lg shadow-indigo-500/50">Trung ➔ Việt</button>
                <div class="text-[9px] font-bold text-gray-400">HSK1 GRAMMAR</div>
            </div>
            <div class="text-center mb-10 min-h-[120px] flex flex-col justify-center items-center">
                <div id="g-question" class="text-4xl md:text-5xl font-bold tracking-tight mb-4 leading-tight drop-shadow-lg cursor-pointer hover:text-indigo-300 transition" onclick="readGrammarQuestion()">...</div>
                <p id="g-instruction" class="text-gray-500 text-sm italic">Hãy dịch câu trên</p>
            </div>
            <input type="text" id="g-input" placeholder="Nhập câu trả lời..." class="w-full bg-transparent border-b-2 border-white/10 py-4 text-center text-xl font-medium outline-none focus:border-indigo-500 transition mb-6 text-white placeholder-gray-600" autocomplete="off">
            <div class="grid grid-cols-4 gap-4 mb-6">
                <button onclick="nextGrammar()" class="col-span-1 py-4 bg-white/5 hover:bg-white/10 rounded-2xl font-bold text-[10px] uppercase tracking-widest text-gray-400 hover:text-white transition">Bỏ qua</button>
                <button onclick="checkGrammar()" class="col-span-3 py-4 bg-white text-black hover:bg-indigo-400 hover:text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] transition shadow-lg">Kiểm tra</button>
            </div>
            <div id="g-feedback" class="text-center h-20">
                <div id="g-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></div>
                <div id="g-note" class="text-[11px] text-pink-400 font-medium"></div>
            </div>
        </div>
    </div>
</div>

<div id="music" class="tab-content">
    <div class="min-h-screen flex flex-col items-center justify-center pt-20 pb-20">
        <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-6xl px-4">
            <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto">
                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-indigo-400 border-b border-white/10 pb-2">V-Pop Hits</h3>
                <div id="v-list" class="space-y-2"></div>
            </div>
            <div class="w-full max-w-md flex flex-col items-center">
                <h4 class="text-4xl font-black text-white tracking-tighter uppercase mb-4 drop-shadow-lg">Music Pod</h4>
                <div class="relative w-full h-[300px]">
                     <model-viewer src="./airpods.glb" alt="My Airpods" auto-rotate camera-controls shadow-intensity="1" exposure="0.8" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                </div>
                <div class="w-full aspect-video bg-black rounded-2xl overflow-hidden border-2 border-white/20 shadow-2xl mt-[-40px] relative z-10">
                    <div id="player"></div> 
                    <video id="mp4-player" controls playsinline class="hidden w-full h-full object-cover"></video>
                </div>
            </div>
            <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto">
                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-pink-400 border-b border-white/10 pb-2">Chinese Hits</h3>
                <div id="c-list" class="space-y-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- COIN SYSTEM ---
    let userCoins = parseInt(localStorage.getItem('skyCoins')) || 0;
    const coinDisplay = document.getElementById('coin-display');
    coinDisplay.innerText = userCoins;

    function updateCoins(amount) {
        userCoins += amount;
        localStorage.setItem('skyCoins', userCoins);
        coinDisplay.innerText = userCoins;
        
        // Animation effect
        coinDisplay.classList.remove('coin-pop-green', 'coin-pop-red');
        void coinDisplay.offsetWidth; // Trigger reflow
        if(amount > 0) coinDisplay.classList.add('coin-pop-green');
        else coinDisplay.classList.add('coin-pop-red');
    }

    function speakText(text) {
        if(!text) return; window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text); msg.lang = 'zh-CN'; msg.rate = 0.8; 
        window.speechSynthesis.speak(msg);
    }

    const homophones = { "他": ["她", "它"], "做": ["作", "座", "坐"], "那": ["哪"], "是": ["事", "市", "试"], "一": ["衣", "医"], "有": ["友", "又"] };

    // ... (Giữ nguyên DATA HSK1 VOCABULARY LIST của bạn) ...
    const vocabData = [
        { hz: "我", py: "wǒ", mn: "tôi" }, { hz: "你", py: "nǐ", mn: "bạn" }, { hz: "他", py: "tā", mn: "anh ấy" }, { hz: "她", py: "tā", mn: "cô ấy" }, { hz: "我们", py: "wǒmen", mn: "chúng tôi" }, { hz: "谁", py: "shéi", mn: "ai" },
        { hz: "爸爸", py: "bàba", mn: "bố" }, { hz: "妈妈", py: "māma", mn: "mẹ" }, { hz: "儿子", py: "érzi", mn: "con trai" }, { hz: "女儿", py: "nǚér", mn: "con gái" }, { hz: "老师", py: "lǎoshī", mn: "thầy cô" }, { hz: "学生", py: "xuésheng", mn: "học sinh" }, { hz: "同学", py: "tóngxué", mn: "bạn học" }, { hz: "朋友", py: "péngyou", mn: "bạn bè" }, { hz: "人", py: "rén", mn: "người" }, { hz: "先生", py: "xiānsheng", mn: "ngài/ông" }, { hz: "小姐", py: "xiǎojiě", mn: "cô/chị" },
        { hz: "零", py: "líng", mn: "không" }, { hz: "一", py: "yī", mn: "một" }, { hz: "二", py: "èr", mn: "hai" }, { hz: "三", py: "sān", mn: "ba" }, { hz: "四", py: "sì", mn: "bốn" }, { hz: "五", py: "wǔ", mn: "năm" }, { hz: "六", py: "liù", mn: "sáu" }, { hz: "七", py: "qī", mn: "bảy" }, { hz: "八", py: "bā", mn: "tám" }, { hz: "九", py: "jiǔ", mn: "chín" }, { hz: "十", py: "shí", mn: "mười" },
        { hz: "现在", py: "xiànzài", mn: "bây giờ" }, { hz: "点", py: "diǎn", mn: "giờ" }, { hz: "分", py: "fēn", mn: "phút" }, { hz: "今天", py: "jīntiān", mn: "hôm nay" }, { hz: "明天", py: "míngtiān", mn: "ngày mai" }, { hz: "昨天", py: "zuótiān", mn: "hôm qua" }, { hz: "年", py: "nián", mn: "năm" }, { hz: "月", py: "yuè", mn: "tháng" }, { hz: "日", py: "rì", mn: "ngày" }, { hz: "号", py: "hào", mn: "ngày (số)" }, { hz: "星期", py: "xīngqī", mn: "tuần/thứ" }, { hz: "上午", py: "shàngwǔ", mn: "buổi sáng" }, { hz: "中午", py: "zhōngwǔ", mn: "buổi trưa" }, { hz: "下午", py: "xiàwǔ", mn: "buổi chiều" }, { hz: "时候", py: "shíhou", mn: "lúc/khi" },
        { hz: "是", py: "shì", mn: "là" }, { hz: "有", py: "yǒu", mn: "có" }, { hz: "在", py: "zài", mn: "ở/đang" }, { hz: "要", py: "yào", mn: "muốn/cần" }, { hz: "喜欢", py: "xǐhuan", mn: "thích" }, { hz: "爱", py: "ài", mn: "yêu" }, { hz: "吃", py: "chī", mn: "ăn" }, { hz: "喝", py: "hē", mn: "uống" }, { hz: "去", py: "qù", mn: "đi" }, { hz: "来", py: "lái", mn: "đến" }, { hz: "想", py: "xiǎng", mn: "muốn/nghĩ" }, { hz: "看", py: "kàn", mn: "xem/nhìn" }, { hz: "听", py: "tīng", mn: "nghe" }, { hz: "说", py: "shuō", mn: "nói" }, { hz: "读", py: "dú", mn: "đọc" }, { hz: "写", py: "xiě", mn: "viết" }, { hz: "做", py: "zuò", mn: "làm" }, { hz: "买", py: "mǎi", mn: "mua" }, { hz: "给", py: "gěi", mn: "cho" }, { hz: "回", py: "huí", mn: "về" }, { hz: "住", py: "zhù", mn: "sống/ở" }, { hz: "认识", py: "rènshi", mn: "quen biết" }, { hz: "会", py: "huì", mn: "biết (kỹ năng)" }, { hz: "能", py: "néng", mn: "có thể" },
        { hz: "好", py: "hǎo", mn: "tốt" }, { hz: "多", py: "duō", mn: "nhiều" }, { hz: "少", py: "shǎo", mn: "ít" }, { hz: "大", py: "dà", mn: "to/lớn" }, { hz: "小", py: "xiǎo", mn: "nhỏ/bé" }, { hz: "冷", py: "lěng", mn: "lạnh" }, { hz: "热", py: "rè", mn: "nóng" }, { hz: "高兴", py: "gāoxìng", mn: "vui vẻ" }, { hz: "漂亮", py: "piàoliang", mn: "xinh đẹp" }, { hz: "对", py: "duì", mn: "đúng" }, { hz: "错", py: "cuò", mn: "sai" }, { hz: "忙", py: "máng", mn: "bận" }, { hz: "累", py: "lèi", mn: "mệt" },
        { hz: "水", py: "shuǐ", mn: "nước" }, { hz: "饭", py: "fàn", mn: "cơm" }, { hz: "菜", py: "cài", mn: "món ăn/rau" }, { hz: "茶", py: "chá", mn: "trà" }, { hz: "苹果", py: "píngguǒ", mn: "táo" }, { hz: "钱", py: "qián", mn: "tiền" }, { hz: "东西", py: "dōngxi", mn: "đồ đạc" }, { hz: "杯子", py: "bēizi", mn: "cốc/ly" }, { hz: "衣服", py: "yīfu", mn: "quần áo" }, { hz: "书", py: "shū", mn: "sách" }, { hz: "桌子", py: "zhuōzi", mn: "bàn" }, { hz: "椅子", py: "yǐzi", mn: "ghế" }, { hz: "电脑", py: "diànnǎo", mn: "máy tính" }, { hz: "电视", py: "diànshì", mn: "tivi" }, { hz: "家", py: "jiā", mn: "nhà" }, { hz: "学校", py: "xuéxiào", mn: "trường học" }, { hz: "饭店", py: "fàndiàn", mn: "nhà hàng" }, { hz: "商店", py: "shāngdiàn", mn: "cửa hàng" }, { hz: "北京", py: "běijīng", mn: "Bắc Kinh" }, { hz: "中国", py: "zhōngguó", mn: "Trung Quốc" },
        { hz: "不", py: "bù", mn: "không (phủ định)" }, { hz: "没", py: "méi", mn: "không có/chưa" }, { hz: "很", py: "hěn", mn: "rất" }, { hz: "太", py: "tài", mn: "quá/lắm" }, { hz: "都", py: "dōu", mn: "đều" }, { hz: "和", py: "hé", mn: "và" }, { hz: "的", py: "de", mn: "của/trợ từ" }, { hz: "吗", py: "ma", mn: "không (hỏi)" }, { hz: "呢", py: "ne", mn: "thì sao/nhỉ" }, { hz: "了", py: "le", mn: "rồi" }, { hz: "什么", py: "shénme", mn: "cái gì" }, { hz: "哪儿", py: "nǎr", mn: "ở đâu" }, { hz: "怎么", py: "zěnme", mn: "thế nào" }, { hz: "多少", py: "duōshao", mn: "bao nhiêu" }, { hz: "几", py: "jǐ", mn: "mấy" }
    ];

    const grammarBank = [
        { zh: "我是学生。", vi: "tôi là học sinh", note: "Câu chữ 是 (Là): S + 是 + O" },
        { zh: "这是什么？", vi: "đây là cái gì", note: "Câu hỏi với 什么 (Cái gì)" },
        { zh: "他在家吗？", vi: "anh ấy có ở nhà không", note: "Câu hỏi 吗 (Có... không)" },
        { zh: "你去哪儿？", vi: "bạn đi đâu", note: "Hỏi địa điểm 哪儿 (Ở đâu)" },
        { zh: "这个多少钱？", vi: "cái này bao nhiêu tiền", note: "Hỏi giá 多少钱" },
        { zh: "你是哪国人？", vi: "bạn là người nước nào", note: "Hỏi quốc tịch" },
        { zh: "现在几点？", vi: "bây giờ là mấy giờ", note: "Hỏi giờ: 几点" },
        { zh: "你会说汉语吗？", vi: "bạn biết nói tiếng trung không", note: "Động từ năng nguyện 会 (Biết)" },
        { zh: "他的个子很高。", vi: "dáng người anh ấy rất cao", note: "Tính từ làm vị ngữ (Không dùng 是)" },
        { zh: "我没钱了。", vi: "tôi hết tiền rồi", note: "Chữ 了 chỉ sự thay đổi trạng thái" },
        { zh: "我和他是同学。", vi: "tôi và anh ấy là bạn học", note: "Liên từ 和 (Và)" },
        { zh: "太热了！", vi: "nóng quá", note: "Cấu trúc cảm thán: 太...了" },
        { zh: "这本书是谁的？", vi: "quyển sách này là của ai", note: "Câu sở hữu với 的" },
        { zh: "你怎么去学校？", vi: "bạn đi đến trường bằng cách nào", note: "Hỏi phương thức: 怎么 + Động từ" },
        { zh: "我不喜欢吃苹果。", vi: "tôi không thích ăn táo", note: "Phủ định dùng 不" }
    ];

    const readingData = [
        { id: 1, zh: "你好！我叫刘铁花。我是学生。我家有五口人：爸爸、妈妈、哥哥、女儿和我。我爸爸是老师，他在学校工作。我妈妈不工作，她在家。我有一个好朋友，他是我的同学。认识你很高兴！", key: "xin chào tôi tên lưu thiết hoa tôi là học sinh nhà tôi có năm người bố mẹ anh trai con gái và tôi bố tôi là giáo viên ông ấy làm việc ở trường mẹ tôi không đi làm bà ấy ở nhà tôi có một người bạn tốt cậu ấy là bạn học của tôi rất vui được làm quen" },
        { id: 2, zh: "今天星期六。现在上午九点，我在家看书。中午十二点，我去饭店吃饭。我喜欢吃中国菜，喝茶。下午我要去商店买东西。我买了一个杯子和几件衣服。明天是星期日，我不工作，我想在家睡觉。", key: "hôm nay là thứ bảy bây giờ là chín giờ sáng tôi ở nhà đọc sách mười hai giờ trưa tôi đi nhà hàng ăn cơm tôi thích ăn món trung quốc uống trà buổi chiều tôi muốn đi cửa hàng mua đồ tôi đã mua một cái cốc và vài bộ quần áo ngày mai là chủ nhật tôi không làm việc tôi muốn ở nhà ngủ" },
        { id: 3, zh: "先生，你好！请问，现在几点了？现在三点十分。谢谢！不客气。你去哪儿？我去学校看老师。你的老师是谁？我的老师是王先生。他很好，也很忙。", key: "chào ông xin hỏi bây giờ là mấy giờ rồi bây giờ là ba giờ mười phút cảm ơn không có gì bạn đi đâu tôi đi đến trường thăm giáo viên giáo viên của bạn là ai giáo viên của tôi là thầy vương ông ấy rất tốt cũng rất bận" },
        { id: 4, zh: "你会说汉语吗？我会说一点儿。你喜欢做什么？我喜欢看电视和听老师说话。我不喜欢喝水，我喜欢喝茶。今天天气很热，我想吃苹果。你呢？我也一样。", key: "bạn biết nói tiếng trung không tôi biết nói một chút bạn thích làm gì tôi thích xem tivi và nghe thầy giáo nói chuyện tôi không thích uống nước tôi thích uống trà hôm nay thời tiết rất nóng tôi muốn ăn táo còn bạn thì sao tôi cũng vậy" },
        { id: 5, zh: "这个电脑多少钱？这个电脑八千块钱。太贵了！那个桌子和椅子呢？那个桌子不贵。你要买什么？我要买一个小杯子。给你钱。谢谢。", key: "cái máy tính này bao nhiêu tiền cái máy tính này tám nghìn tệ đắt quá cái bàn và ghế kia thì sao cái bàn đó không đắt bạn muốn mua gì tôi muốn mua một cái cốc nhỏ gửi bạn tiền cảm ơn" },
        { id: 6, zh: "今天是星期五，天气很热。现在上午八点，我不在家，我在学校。我是这里的学生，我也认识很多同学和老师。我的老师是位先生，他很好，但是他今天很忙。", key: "hôm nay là thứ sáu thời tiết rất nóng bây giờ là tám giờ sáng tôi không ở nhà tôi ở trường tôi là học sinh ở đây tôi cũng quen biết rất nhiều bạn học và thầy cô giáo viên của tôi là một quý ông ông ấy rất tốt nhưng hôm nay ông ấy rất bận" },
        { id: 7, zh: "你好！请问你是谁？我是王小姐，我是你爸爸的朋友。噢！王小姐，快请进，请坐在这儿的椅子上。你认识我的女儿吗？我不认识她，她是谁？她是我的大女儿，他在北京读大学，现在在家里看电视。", key: "xin chào xin hỏi cô là ai tôi là cô vương tôi là bạn của bố bạn ồ cô vương mau mời vào mời ngồi trên cái ghế ở đây cô có biết con gái tôi không tôi không biết cô ấy cô ấy là ai cô ấy là con gái lớn của tôi nó đang học đại học ở bắc kinh bây giờ đang ở nhà xem tivi" },
        { id: 8, zh: "我是一个喜欢学习的人。现在我不在工作，我在学习。我会说汉语，也会读汉语书，但是我不会写很多字。我的同学太多了，他们都很努力。今天上午，老师说我们要做很多作业。这些作业不大也不小，但是很难。", key: "tôi là một người thích học tập bây giờ tôi không làm việc tôi đang học tôi biết nói tiếng trung cũng biết đọc sách tiếng trung nhưng tôi không biết viết nhiều chữ bạn học của tôi đông quá họ đều rất nỗ lực sáng nay thầy giáo nói chúng tôi phải làm rất nhiều bài tập những bài tập này không lớn cũng không nhỏ nhưng rất khó" }
    ];

    let vMode = 0; let vIdx = 0; let sIdx = 0; let gIdx = 0; let gMode = 0; let rIdx = 0;

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-' + id).classList.add('active');
        if(id === 'vocab') nextVocab(false);
        if(id === 'speaking') updateSpeakUI();
        if(id === 'grammar') nextGrammar();
        if(id === 'reading') nextParagraph();
    }

    // --- READING LOGIC (WITH COINS) ---
    function nextParagraph() {
        let newIdx; do { newIdx = Math.floor(Math.random() * readingData.length); } while (newIdx === rIdx && readingData.length > 1);
        rIdx = newIdx;
        const item = readingData[rIdx];
        document.getElementById('r-text').innerText = item.zh;
        document.getElementById('r-input').value = "";
        document.getElementById('r-msg').innerText = "";
        document.getElementById('r-hint').innerText = "";
        document.getElementById('r-hint').classList.add('hidden');
        document.getElementById('reading-card').className = "glass-card p-8 w-full max-w-3xl mx-4 relative";
    }

    function checkReading() {
        const input = document.getElementById('r-input').value.trim().toLowerCase();
        const target = readingData[rIdx].key;
        const card = document.getElementById('reading-card');
        const hint = document.getElementById('r-hint');

        const inputWords = input.split(/\s+/);
        const targetWords = target.split(/\s+/);
        let matchCount = 0;
        inputWords.forEach(word => { if(target.includes(word)) matchCount++; });
        const score = matchCount / targetWords.length;

        if (score > 0.5) { 
            updateCoins(1); // COIN +1
            document.getElementById('r-msg').innerText = `RẤT TỐT! (ĐỘ CHÍNH XÁC: ${Math.round(score*100)}%)`;
            document.getElementById('r-msg').style.color = "#4ade80";
            card.classList.add('glow-green');
            hint.classList.add('hidden');
        } else {
            updateCoins(-1); // COIN -1
            document.getElementById('r-msg').innerText = `CHƯA ĐẠT (ĐỘ CHÍNH XÁC: ${Math.round(score*100)}%)`;
            document.getElementById('r-msg').style.color = "#f87171";
            card.classList.add('glow-red');
            hint.innerHTML = `<strong class="text-white">BẢN DỊCH THAM KHẢO:</strong><br>${target}`;
            hint.classList.remove('hidden');
        }
    }

    // --- OTHER LOGIC (WITH COINS) ---
    function changeVocabMode() { vMode = (vMode + 1) % 3; const labels = ["Hán ➔ Việt", "Việt ➔ Hán", "Hán ➔ Pinyin"]; document.getElementById('v-mode-btn').innerText = "Mode: " + labels[vMode]; document.getElementById('v-mode-btn').className = `text-[10px] font-black ${["bg-pink-500", "bg-indigo-500", "bg-teal-500"][vMode]} px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition`; nextVocab(false); }
    function nextVocab(random = true) { if(random) vIdx = Math.floor(Math.random() * vocabData.length); const item = vocabData[vIdx]; const qDiv = document.getElementById('v-question'); document.getElementById('v-input').value = ""; document.getElementById('v-msg').innerText = ""; document.getElementById('v-hint').innerText = ""; document.getElementById('vocab-card').classList.remove('glow-green', 'glow-red'); if(vMode === 0) qDiv.innerText = item.hz; else if(vMode === 1) qDiv.innerText = item.mn.toUpperCase(); else qDiv.innerText = item.hz; }
    
    function checkVocab() { 
        const item = vocabData[vIdx]; 
        const val = document.getElementById('v-input').value.trim().toLowerCase(); 
        let correct = false; let answer = ""; 
        if(vMode === 0) { correct = val === item.mn.toLowerCase(); answer = item.mn; } 
        else if(vMode === 1) { correct = val === item.hz; answer = item.hz; } 
        else { correct = val === item.py.toLowerCase() || val === item.py.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); answer = item.py; } 
        const feedback = document.getElementById('v-msg'); 
        if(correct) { 
            updateCoins(1); // COIN +1
            feedback.innerText = "CHÍNH XÁC!"; feedback.style.color = "#4ade80"; document.getElementById('vocab-card').classList.add('glow-green'); speakText(item.hz); setTimeout(() => nextVocab(true), 1200); 
        } else { 
            updateCoins(-1); // COIN -1
            feedback.innerText = "SAI RỒI"; feedback.style.color = "#f87171"; document.getElementById('v-hint').innerText = `Đáp án: ${answer}`; document.getElementById('vocab-card').classList.add('glow-red'); speakText(item.hz); 
        } 
    }

    function updateSpeakUI() { const item = vocabData[sIdx]; document.getElementById('s-hz').innerText = item.hz; document.getElementById('s-py').innerText = item.py; document.getElementById('s-mn').innerText = item.mn.toUpperCase(); document.getElementById('speak-card').classList.remove('glow-green', 'glow-red'); document.getElementById('s-status').innerText = "Bấm mic và nói ngay"; document.getElementById('s-sub').innerText = ""; document.getElementById('progress-bar').style.width = '0%'; document.getElementById('s-live-text').innerText = ""; }
    function changeSpeakWord(dir) { sIdx = (sIdx + dir + vocabData.length) % vocabData.length; updateSpeakUI(); }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition; let timer;
    if(SpeechRecognition) {
        recognition = new SpeechRecognition(); recognition.lang = 'zh-CN'; recognition.interimResults = true; recognition.continuous = true;
        const btn = document.getElementById('mic-btn'); const status = document.getElementById('s-status'); const sub = document.getElementById('s-sub'); const ring = document.getElementById('mic-ring'); const progressBar = document.getElementById('progress-bar'); const card = document.getElementById('speak-card'); const liveText = document.getElementById('s-live-text');
        let isListening = false;
        btn.onclick = () => { if(isListening) return; startSession(); };
        function startSession() { isListening = true; card.classList.remove('glow-green', 'glow-red'); status.innerText = "ĐANG NGHE..."; status.className = "text-indigo-400 font-bold animate-pulse"; sub.innerText = "Nói to rõ ràng..."; ring.classList.remove('hidden'); liveText.innerText = ""; progressBar.style.width = '100%'; progressBar.style.transition = "width 5s linear"; try { recognition.start(); } catch(e) {} timer = setTimeout(() => { finishSession("TIMEOUT"); }, 5000); }
        recognition.onresult = (e) => { let interim = ""; for (let i = e.resultIndex; i < e.results.length; ++i) { interim += e.results[i][0].transcript; } liveText.innerText = "Nghe: " + interim; const target = vocabData[sIdx].hz; const clean = interim.replace(/[.,?。？!！]/g, ""); if(clean.includes(target) || (homophones[target] && homophones[target].some(h => clean.includes(h)))) { finishSession("WIN", clean); } };
        recognition.onerror = () => { finishSession("ERROR"); }; recognition.onend = () => { if(isListening) { try{recognition.start()}catch(e){} } };
        function finishSession(type, word = "") { 
            if(!isListening) return; isListening = false; clearTimeout(timer); recognition.stop(); ring.classList.add('hidden'); progressBar.style.transition = "none"; progressBar.style.width = '0%'; 
            if(type === "WIN") { 
                updateCoins(1); // COIN +1
                status.innerText = "CHÍNH XÁC! (CORRECT)"; sub.innerText = "Bắt dính ngay lập tức!"; status.className = "text-green-500 font-black"; card.classList.add('glow-green'); 
            } else if (type === "TIMEOUT") { 
                if(liveText.innerText.length > 5) { 
                    updateCoins(-1); // COIN -1
                    status.innerText = "SAI RỒI!"; sub.innerText = `Nghe được: ${liveText.innerText.replace("Nghe: ", "")}`; status.className = "text-red-500 font-black"; card.classList.add('glow-red'); 
                } else { 
                    status.innerText = "KHÔNG NGHE RÕ"; sub.innerText = "Nói to hơn hoặc mic bị lỗi"; status.className = "text-pink-500 font-black"; card.classList.add('glow-red'); 
                } 
            } else { status.innerText = "LỖI MIC"; status.className = "text-gray-500"; } 
        }
    } else { alert("Trình duyệt không hỗ trợ Web Speech API."); }

    function toggleGrammarMode() { gMode = 1 - gMode; document.getElementById('g-mode-badge').innerText = gMode === 0 ? "Trung ➔ Việt" : "Việt ➔ Trung"; nextGrammar(); }
    function nextGrammar() { let newIdx; do { newIdx = Math.floor(Math.random() * grammarBank.length); } while (newIdx === gIdx && grammarBank.length > 1); gIdx = newIdx; const item = grammarBank[gIdx]; document.getElementById('g-question').innerText = gMode === 0 ? item.zh : item.vi.toUpperCase(); document.getElementById('g-instruction').innerText = gMode === 0 ? "Dịch câu này sang Tiếng Việt" : "Dịch câu này sang Tiếng Trung"; document.getElementById('g-input').value = ""; document.getElementById('g-msg').innerText = ""; document.getElementById('g-note').innerText = ""; document.getElementById('grammar-card').className = "glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden"; if(gMode === 0) speakText(item.zh); }
    function checkGrammar() { 
        const val = document.getElementById('g-input').value.trim().toLowerCase(); const item = grammarBank[gIdx]; const target = gMode === 0 ? item.vi : item.zh; const card = document.getElementById('grammar-card'); let isCorrect = false; 
        if (gMode === 0) isCorrect = val === target.toLowerCase() || (target.toLowerCase().includes(val) && val.length > 5); else isCorrect = val === target || val === target.replace(/？|。/g, ""); 
        speakText(item.zh); 
        if(isCorrect) { 
            updateCoins(1); // COIN +1
            document.getElementById('g-msg').innerText = "RẤT TỐT!"; document.getElementById('g-msg').style.color = "#4ade80"; document.getElementById('g-note').innerText = item.note; card.classList.add('glow-green'); setTimeout(nextGrammar, 2000); 
        } else { 
            updateCoins(-1); // COIN -1
            document.getElementById('g-msg').innerText = "CHƯA CHÍNH XÁC"; document.getElementById('g-msg').style.color = "#f87171"; document.getElementById('g-note').innerText = `Đáp án đúng: ${target}`; card.classList.add('glow-red'); 
        } 
    }
    document.getElementById('g-input').addEventListener("keypress", function(event) { if (event.key === "Enter") checkGrammar(); });
    function readGrammarQuestion() { const item = grammarBank[gIdx]; speakText(item.zh); }

    const vPop = [{name:"Hôn vào đây",type:"mp4",id:"https://files.catbox.moe/kos9gw.mp4",thumb:"https://img.youtube.com/vi/vs-hsW6I63I/mqdefault.jpg"},{name:"Hà Nội",type:"mp4",id:"https://files.catbox.moe/1ygyge.mp4",thumb:"https://img.youtube.com/vi/OerAX-zKyvg/mqdefault.jpg"}];
    const cPop = [{name:"Sứ Thanh Hoa",type:"yt",id:"Z7vlR53_qNM",thumb:"https://img.youtube.com/vi/Z7vlR53_qNM/mqdefault.jpg"},{name:"Đáy Biển",type:"yt",id:"rJjQ4w-B3cE",thumb:"https://img.youtube.com/vi/rJjQ4w-B3cE/mqdefault.jpg"}];
    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player; function onYouTubeIframeAPIReady() { player = new YT.Player('player', { height: '100%', width: '100%', videoId: '' }); }
    function playMedia(source, type) { const ytDiv = document.getElementById('player'); const mp4Div = document.getElementById('mp4-player'); if(player && player.stopVideo) player.stopVideo(); mp4Div.pause(); if (type === 'mp4') { ytDiv.style.display = 'none'; mp4Div.style.display = 'block'; mp4Div.src = source; mp4Div.play(); } else { mp4Div.style.display = 'none'; ytDiv.style.display = 'block'; player.loadVideoById(source); } }
    function renderMusic() { const tpl = (s) => `<div class="song-item" onclick="playMedia('${s.id}', '${s.type}')"><img src="${s.thumb}"><div><h4 class="text-[10px] font-bold uppercase">${s.name}</h4><p class="text-[9px] text-gray-400">${s.type === 'mp4' ? 'NO ADS' : 'Youtube'}</p></div></div>`; document.getElementById('v-list').innerHTML = vPop.map(tpl).join(''); document.getElementById('c-list').innerHTML = cPop.map(tpl).join(''); }
    const cursor = document.getElementById('cursor'); document.addEventListener('mousemove', e => { cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; }); function handleGlobalClick() { cursor.style.transform = "scale(2)"; setTimeout(() => cursor.style.transform = "scale(1)", 150); }
    window.onload = () => { renderMusic(); switchTab('home'); };
</script>
</body>
</html>
