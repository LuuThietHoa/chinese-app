<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Hub | V46.0 AI Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        :root { --primary: #6366f1; --accent: #f472b6; }
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #020617, #1e1b4b, #be185d, #0f766e);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff; min-height: 100vh; overflow-x: hidden; cursor: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #cursor { position: fixed; width: 20px; height: 20px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .glass-card:hover { transform: translateY(-5px); }
        
        /* NAV UPDATE CHO NHI·ªÄU TAB */
        nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 6px; background: rgba(0,0,0,0.9); padding: 8px; border-radius: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; justify-content: center; width: 95%; max-width: 800px; }
        .nav-btn { padding: 8px 12px; border-radius: 18px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; color: #94a3b8; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.5s forwards; padding-bottom: 120px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .glow-green { box-shadow: 0 0 40px #22c55e !important; border-color: #22c55e !important; }
        .glow-red { box-shadow: 0 0 40px #ef4444 !important; border-color: #ef4444 !important; }
        
        /* HELPER CLASSES */
        .full-modal { transition: opacity 0.3s ease; }
        .full-modal.hidden { display: none; }
        .inv-slot { width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .song-item { display: flex; gap: 12px; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; align-items: center; }
        
        /* GAME CANVAS */
        #game-container { position: fixed; inset: 0; z-index: 5000; background: #87CEEB; display: none; pointer-events: auto; }
        #game-ui { position: absolute; top: 20px; left: 20px; z-index: 5001; pointer-events: none; }
        #builder-ui { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 5002; }
        .build-btn { background: rgba(0,0,0,0.7); border: 1px solid white; padding: 10px; border-radius: 10px; cursor: pointer; color: white; }
        #obj-panel { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 15px; width: 200px; display: none; z-index: 5003; }
        .model-option { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; gap: 10px; color: white; }
        #edit-controls { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border-radius: 20px; display: none; gap: 10px; z-index: 5004; }
        .ctrl-btn { width: 40px; height: 40px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; color: white; }

        /* TEST & STUDY STYLES */
        .grammar-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .step-indicator { display: flex; gap: 5px; justify-content: center; margin-bottom: 20px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; }
        .step-dot.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .chat-bubble { background: white; color: black; padding: 10px 20px; border-radius: 20px; margin-bottom: 10px; display: inline-block; max-width: 80%; font-weight: bold; }
        .fill-blank { border-bottom: 2px solid var(--primary); display: inline-block; min-width: 50px; text-align: center; color: var(--accent); }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="cursor"></div>

<audio id="sfx-coin" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
<audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-click-900.mp3"></audio>

<div class="fixed top-6 right-6 z-[2000] flex items-center gap-3 bg-black/40 backdrop-blur-xl px-5 py-2 rounded-full border border-yellow-500/30 shadow-2xl transition hover:scale-105">
    <div class="w-10 h-10">
        <model-viewer src="./coin.glb" alt="Coin" auto-rotate rotation-per-second="30deg" disable-zoom style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
    </div>
    <div class="flex flex-col items-end">
        <span class="text-[9px] font-bold text-yellow-500/80 uppercase tracking-widest">Balance</span>
        <span id="coin-display" class="text-2xl font-black text-yellow-400 leading-none tabular-nums">0</span>
    </div>
</div>

<div class="fixed top-32 right-6 z-[2000] cursor-pointer transition hover:scale-110 active:scale-95 group flex flex-col items-center" onclick="enterGameWorld()">
    <div class="w-16 h-16 bg-indigo-900/80 rounded-full border-2 border-indigo-400 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <span class="text-3xl">üè∞</span>
    </div>
    <div class="bg-indigo-600 text-white px-2 py-1 rounded text-[8px] font-bold uppercase mt-1">V√†o Th·∫ø Gi·ªõi</div>
</div>

<div id="game-container">
    <div id="game-ui">
        <h2 class="text-xl font-black uppercase italic text-yellow-400">Th·∫ø Gi·ªõi Skyreign</h2>
        <div class="mt-2 text-xs text-white">
            <p>WASD: Di chuy·ªÉn | Shift: Ch·∫°y</p>
            <p>Click chu·ªôt tr√°i: Ch·ªçn ƒë·ªì v·∫≠t</p>
        </div>
    </div>
    <div id="edit-controls">
        <div class="ctrl-btn" onclick="modifySelected('scale', 0.1)">+</div>
        <div class="ctrl-btn" onclick="modifySelected('scale', -0.1)">-</div>
        <div class="ctrl-btn" onclick="modifySelected('rotate', 0.2)">‚Üª</div>
        <div class="ctrl-btn" onclick="modifySelected('delete', 0)" style="background:#ef4444;">‚úï</div>
        <div class="ctrl-btn" onclick="deselectObject()" style="background:#666;">OK</div>
    </div>
    <div id="builder-ui">
        <button class="build-btn text-xs font-bold uppercase" onclick="toggleObjPanel()">üì¶ Kho ƒê·ªì</button>
        <button class="build-btn text-xs font-bold uppercase bg-green-600 border-green-400" onclick="saveWorld()">üíæ L∆∞u</button>
    </div>
    <div id="obj-panel">
        <h3 class="text-xs font-bold uppercase mb-4 text-gray-400 border-b border-white/20 pb-2">Ch·ªçn Model</h3>
        <div id="model-list-content"></div>
        <button onclick="toggleObjPanel()" class="w-full mt-4 py-2 bg-red-600 rounded text-xs font-bold">ƒê√≥ng</button>
    </div>
    <button onclick="exitGameWorld()" class="absolute top-6 right-6 z-[5002] text-white hover:text-red-500 font-black text-xl bg-black/40 w-12 h-12 rounded-full flex items-center justify-center border border-white/20">‚úï</button>
</div>

<nav>
    <button onclick="switchTab('home')" class="nav-btn active" id="n-home">S·∫£nh</button>
    <button onclick="switchTab('vocab')" class="nav-btn" id="n-vocab">H·ªçc T·ª´</button>
    <button onclick="switchTab('reading')" class="nav-btn" id="n-reading">ƒê·ªçc Hi·ªÉu</button>
    <button onclick="switchTab('grammar')" class="nav-btn" id="n-grammar">Ng·ªØ Ph√°p</button>
    <button onclick="switchTab('speaking')" class="nav-btn" id="n-speaking">Luy·ªán N√≥i</button>
    <button onclick="switchTab('music')" class="nav-btn" id="n-music">Nh·∫°c</button>
    <button onclick="switchTab('study')" class="nav-btn bg-pink-600/50" id="n-study">Ghi Nh·ªõ</button>
    <button onclick="switchTab('test')" class="nav-btn bg-red-600/50" id="n-test">Ki·ªÉm Tra</button>
</nav>

<div id="home" class="tab-content active">
    <div class="h-screen flex flex-col items-center justify-center relative">
        <div class="glass-card p-12 text-center max-w-md mx-4 z-10">
            <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SKYREIGN</h1>
            <p class="text-xs tracking-[0.5em] text-gray-400 uppercase mb-10">L∆∞u Thi·∫øt Hoa ‚Ä¢ V46.0 AI Test</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('study')" class="py-4 bg-pink-600 hover:bg-pink-500 rounded-xl font-bold text-xs uppercase tracking-widest transition">H·ªçc Ng·ªØ Ph√°p</button>
                <button onclick="switchTab('test')" class="py-4 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-xs uppercase tracking-widest transition shadow-lg">Ki·ªÉm Tra Ngay</button>
            </div>
        </div>
    </div>
</div>

<div id="study" class="tab-content">
    <div class="min-h-screen pt-24 px-4 pb-24 max-w-4xl mx-auto">
        <h2 class="text-3xl font-black text-center mb-8 text-pink-400 uppercase tracking-widest">Danh S√°ch Ng·ªØ Ph√°p</h2>
        <div id="grammar-list-container" class="space-y-4"></div>
    </div>
</div>

<div id="test" class="tab-content">
    <div class="min-h-screen pt-24 px-4 pb-24 max-w-4xl mx-auto flex flex-col items-center">
        <div id="test-menu" class="grid grid-cols-2 gap-4 w-full max-w-lg mb-8">
            <button onclick="startGrammarTest()" class="p-6 bg-indigo-600 rounded-2xl font-black uppercase hover:scale-105 transition shadow-lg text-sm">üß† Test Ng·ªØ Ph√°p (AI)</button>
            <button onclick="startFillBlankTest()" class="p-6 bg-green-600 rounded-2xl font-black uppercase hover:scale-105 transition shadow-lg text-sm">üìù ƒêi·ªÅn T·ª´ H·ªôi Tho·∫°i</button>
        </div>

        <div id="grammar-test-ui" class="glass-card p-8 w-full max-w-2xl hidden relative">
            <button onclick="closeTestUI()" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
            <div class="step-indicator">
                <div id="s1" class="step-dot active"></div><div id="s2" class="step-dot"></div><div id="s3" class="step-dot"></div><div id="s4" class="step-dot"></div>
            </div>
            
            <div class="text-center">
                <p id="gt-question" class="text-3xl font-bold mb-6 text-white tracking-wide"></p>
                <p id="gt-prompt" class="text-xs text-gray-400 uppercase tracking-widest mb-4">C√¢u h·ªèi c·ªßa AI:</p>
                
                <div id="gt-input-area">
                    <input type="text" id="gt-input" class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-center text-xl mb-4 outline-none focus:border-pink-500 transition" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi...">
                    <div id="gt-options" class="grid grid-cols-1 gap-2 mb-4 hidden"></div> <button onclick="checkGrammarStep()" class="w-full py-4 bg-white text-black font-black uppercase rounded-xl hover:bg-indigo-400 transition">Ki·ªÉm Tra</button>
                </div>
                
                <p id="gt-feedback" class="mt-4 text-sm font-bold h-6"></p>
            </div>
        </div>

        <div id="fill-test-ui" class="glass-card p-8 w-full max-w-2xl hidden relative">
            <button onclick="closeTestUI()" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
            <div class="space-y-6">
                <div id="ft-dialogue" class="text-lg leading-relaxed text-gray-300">Loading...</div>
                <div id="ft-options" class="flex flex-wrap gap-2 justify-center pt-4 border-t border-white/10"></div>
                <p id="ft-feedback" class="text-center text-sm font-bold uppercase tracking-widest h-6"></p>
            </div>
        </div>
    </div>
</div>

<div id="reading" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-8 w-full max-w-3xl mx-4 relative" id="reading-card"> <div class="flex justify-between items-center mb-6"> <div class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest">ƒêo·∫°n VƒÉn Ng·∫´u Nhi√™n</div> <div class="flex gap-2"> <button id="r-toggle-btn" onclick="toggleReadingRef()" class="text-[10px] font-bold text-green-400 hover:text-white uppercase tracking-widest transition border border-green-500 px-2 py-1 rounded-lg">Xem ƒê√°p √Ån (Vi·ªát)</button> <button onclick="nextParagraph()" class="text-[10px] font-bold text-gray-400 hover:text-white uppercase tracking-widest transition">ƒê·ªïi b√†i kh√°c ‚Üª</button> </div> </div> <div class="bg-black/20 p-6 rounded-2xl mb-6 border border-white/10 h-64 overflow-y-auto"> <p id="r-text" class="text-xl md:text-2xl font-medium text-gray-100 reading-text">Loading...</p> </div> <p class="text-xs text-gray-400 mb-2 italic">H√£y d·ªãch ƒëo·∫°n vƒÉn tr√™n sang Ti·∫øng Vi·ªát (+1 Coin n·∫øu ƒë√∫ng):</p> <textarea id="r-input" rows="4" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white placeholder-gray-600 outline-none focus:border-indigo-500 transition mb-6" placeholder="G√µ b·∫£n d·ªãch c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea> <button onclick="checkReading()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-indigo-400 hover:text-white transition mb-4 shadow-lg">Ki·ªÉm Tra B·∫£n D·ªãch</button> <div id="r-feedback" class="text-center min-h-[40px]"> <p id="r-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></p> </div> </div> </div> </div>
<div id="vocab" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-10 w-full max-w-lg mx-4 relative" id="vocab-card"> <div class="flex justify-between items-center mb-8"> <button onclick="changeVocabMode()" id="v-mode-btn" class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition">Mode: H√°n ‚ûî Vi·ªát</button> <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">HSK 1 FULL</div> </div> <div id="v-question" class="text-7xl font-black text-center mb-8 tracking-tighter min-h-[100px] flex items-center justify-center">?</div> <input type="text" id="v-input" placeholder="Nh·∫≠p ƒë√°p √°n..." class="w-full bg-transparent border-b-2 border-white/20 py-3 text-center font-bold text-2xl outline-none focus:border-indigo-500 transition text-white placeholder-gray-600 mb-8" autocomplete="off"> <button onclick="checkVocab()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-gray-200 transition mb-4">Ki·ªÉm Tra</button> <div id="v-feedback" class="text-center h-10"> <p id="v-msg" class="text-[11px] font-bold uppercase tracking-widest"></p> <p id="v-hint" class="text-[12px] font-bold text-red-400 mt-1 uppercase hidden"></p> </div> </div> </div> </div>
<div id="speaking" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-10 w-full max-w-md mx-4 text-center relative overflow-hidden" id="speak-card"> <div class="text-[10px] uppercase tracking-widest text-indigo-400 font-black mb-8">V18.0 - Fast Catch</div> <div class="mb-8 relative group"> <div id="s-hz" class="text-9xl font-black mb-2 tracking-tighter cursor-pointer transition hover:text-indigo-400" onclick="speakText(document.getElementById('s-hz').innerText)">Êàë</div> <div id="s-py" class="text-2xl text-gray-500 mb-1">w«í</div> <div id="s-mn" class="text-xs font-bold bg-white/10 px-3 py-1 rounded-full inline-block">T√îI</div> </div> <div class="flex justify-center items-center gap-6 mb-8"> <button onclick="changeSpeakWord(-1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">‚Üê</button> <div class="relative"> <div id="mic-ring" class="hidden mic-ripple"></div> <button id="mic-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl relative z-10 transition hover:scale-110 active:scale-90 text-white"> <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg> </button> </div> <button onclick="changeSpeakWord(1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">‚Üí</button> </div> <div id="s-feedback" class="text-[11px] font-bold uppercase tracking-widest text-gray-400 h-16 flex flex-col items-center justify-center px-4"> <span id="s-status">B·∫•m mic v√† n√≥i ngay</span> <span id="s-sub" class="text-[9px] text-gray-500 mt-1"></span> </div> <div id="s-live-text" class="absolute bottom-1 w-full text-center text-[9px] text-indigo-300/50 uppercase tracking-widest"></div> <div id="progress-bar"></div> </div> </div> </div>
<div id="grammar" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden" id="grammar-card"> <div class="flex justify-between items-center mb-10"> <button onclick="toggleGrammarMode()" id="g-mode-badge" class="text-[10px] font-black bg-indigo-600 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-110 transition shadow-lg shadow-indigo-500/50">Trung ‚ûî Vi·ªát</button> <div class="text-[9px] font-bold text-gray-400">HSK1 GRAMMAR</div> </div> <div class="text-center mb-10 min-h-[120px] flex flex-col justify-center items-center"> <div id="g-question" class="text-4xl md:text-5xl font-bold tracking-tight mb-4 leading-tight drop-shadow-lg cursor-pointer hover:text-indigo-300 transition" onclick="readGrammarQuestion()">...</div> <p id="g-instruction" class="text-gray-500 text-sm italic">H√£y d·ªãch c√¢u tr√™n</p> </div> <input type="text" id="g-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." class="w-full bg-transparent border-b-2 border-white/10 py-4 text-center text-xl font-medium outline-none focus:border-indigo-500 transition mb-6" text-white placeholder-gray-600" autocomplete="off"> <div class="grid grid-cols-4 gap-4 mb-6"> <button onclick="nextGrammar()" class="col-span-1 py-4 bg-white/5 hover:bg-white/10 rounded-2xl font-bold text-[10px] uppercase tracking-widest text-gray-400 hover:text-white transition">B·ªè qua</button> <button onclick="checkGrammar()" class="col-span-3 py-4 bg-white text-black hover:bg-indigo-400 hover:text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] transition shadow-lg">Ki·ªÉm tra</button> </div> <div id="g-feedback" class="text-center h-20"> <div id="g-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></div> <div id="g-note" class="text-[12px] font-bold text-red-400 mt-2 uppercase"></div> </div> </div> </div> </div>
<div id="music" class="tab-content"> <div class="min-h-screen flex flex-col items-center justify-center pt-20 pb-20"> <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-6xl px-4"> <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto"> <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-indigo-400 border-b border-white/10 pb-2">V-Pop Hits</h3> <div id="v-list" class="space-y-2"></div> </div> <div class="w-full max-w-md flex flex-col items-center"> <h4 class="text-4xl font-black text-white tracking-tighter uppercase mb-4 drop-shadow-lg">Music Pod</h4> <div class="relative w-full h-[300px]"> <model-viewer src="./airpods.glb" alt="My Airpods" auto-rotate camera-controls shadow-intensity="1" exposure="0.8" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer> </div> <div class="w-full aspect-video bg-black rounded-2xl overflow-hidden border-2 border-white/20 shadow-2xl mt-[-40px] relative z-10"> <div id="player"></div> <video id="mp4-player" controls playsinline class="hidden w-full h-full object-cover"></video> </div> </div> <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto"> <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-pink-400 border-b border-white/10 pb-2">Chinese Hits</h3> <div id="c-list" class="space-y-2"></div> </div> </div> </div> </div>

<script>
    // --- KH·ªêI 1: DATA G·ªêC (GI·ªÆ NGUY√äN) ---
    let userCoins = parseInt(localStorage.getItem('skyCoins')) || 0;
    let myMobs = JSON.parse(localStorage.getItem('skyMobs')) || [];
    const coinDisplay = document.getElementById('coin-display');
    const coinSfx = document.getElementById('sfx-coin');
    const clickSfx = document.getElementById('sfx-click');
    const typeSfx = document.getElementById('sfx-type');
    coinDisplay.innerText = userCoins;

    function updateCoins(amount) {
        userCoins += amount;
        localStorage.setItem('skyCoins', userCoins);
        coinDisplay.innerText = userCoins;
        coinDisplay.classList.remove('coin-pop-green', 'coin-pop-red');
        void coinDisplay.offsetWidth;
        if(amount > 0) { coinDisplay.classList.add('coin-pop-green'); coinSfx.currentTime = 0; coinSfx.play().catch(e=>{}); } 
        else { coinDisplay.classList.add('coin-pop-red'); }
    }
    
    // ... (Gi·ªØ nguy√™n c√°c h√†m mobs, openShop, buyItem, openInventory...)
    const mobs = [ { id: "mob1", model: "./mob1.glb", name: "RAICER", atk: 200, hp: 900, price: 100 } ];
    let shopIdx = 0;
    function openShop() { clickSfx.currentTime = 0; clickSfx.play().catch(e=>{}); document.getElementById('shop-modal').classList.remove('hidden'); setTimeout(() => typeWriter("H√£y mua nh·ªØng g√¨ b·∫°n mu·ªën...", "npc-text"), 500); loadMob(0); }
    function closeShop() { document.getElementById('shop-modal').classList.add('hidden'); }
    function loadMob(idx) { if(idx < 0 || idx >= mobs.length) { alert("H√£y ƒë·ª£i c·∫≠p nh·∫≠t th√™m qu√°i m·ªõi!"); return; } shopIdx = idx; const m = mobs[shopIdx]; document.getElementById('shop-mob-viewer').src = m.model; document.getElementById('mob-name').innerText = m.name; document.getElementById('mob-atk').innerText = m.atk; document.getElementById('mob-hp').innerText = m.hp; }
    function navShop(dir) { loadMob(shopIdx + dir); }
    function buyItem() { const m = mobs[shopIdx]; if(myMobs.includes(m.id)) { alert("B·∫°n ƒë√£ s·ªü h·ªØu qu√°i v·∫≠t n√†y r·ªìi!"); return; } if(userCoins >= m.price) { updateCoins(-m.price); myMobs.push(m.id); localStorage.setItem('skyMobs', JSON.stringify(myMobs)); alert("Mua th√†nh c√¥ng! H√£y ki·ªÉm tra t√∫i ƒë·ªì."); } else { alert("B·∫°n ch∆∞a ƒë·ªß ti·ªÅn mua qu√°i v·∫≠t n√†y"); } }
    function typeWriter(text, elementId) { const el = document.getElementById(elementId); el.innerText = ""; let i = 0; const speed = 70; function typing() { if (i < text.length) { let char = text.charAt(i); el.textContent += char; if(typeSfx) { typeSfx.currentTime = 0; typeSfx.play().catch(e=>{}); } i++; setTimeout(typing, speed); } } typing(); }
    function openInventory() { clickSfx.currentTime = 0; clickSfx.play().catch(e=>{}); document.getElementById('inv-modal').classList.remove('hidden'); renderInventory(); }
    function closeInventory() { document.getElementById('inv-modal').classList.add('hidden'); }
    function renderInventory() { const container = document.getElementById('inv-mob-container'); const stats = document.getElementById('inv-stats'); if(myMobs.includes('mob1')) { container.innerHTML = `<model-viewer src="./mob1.glb" environment-image="neutral" auto-rotate camera-controls disable-zoom shadow-intensity="1" exposure="1.5" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>`; stats.classList.remove('hidden'); } else { container.innerHTML = `<div class="flex items-center justify-center h-full"><p class="text-white/50 text-xs font-bold uppercase tracking-widest border border-white/20 px-4 py-2 rounded-lg">Ch∆∞a s·ªü h·ªØu qu√°i v·∫≠t</p></div>`; stats.classList.add('hidden'); } }
    function speakText(text) { if(!text) return; window.speechSynthesis.cancel(); const msg = new SpeechSynthesisUtterance(text); msg.lang = 'zh-CN'; msg.rate = 0.8; window.speechSynthesis.speak(msg); }
    
    // --- D·ªÆ LI·ªÜU T·ª™ V·ª∞NG V√Ä B√ÄI ƒê·ªåC (FULL V29) ---
    const vPop = [{name:"H√¥n v√†o ƒë√¢y",type:"mp4",id:"https://files.catbox.moe/kos9gw.mp4",thumb:"https://img.youtube.com/vi/vs-hsW6I63I/mqdefault.jpg"},{name:"H√† N·ªôi",type:"mp4",id:"https://files.catbox.moe/1ygyge.mp4",thumb:"https://img.youtube.com/vi/OerAX-zKyvg/mqdefault.jpg"}];
    const cPop = [{name:"Mang Ch·ªßng (M·ªõi)",type:"mp4",id:"https://files.catbox.moe/g2tdte.mp4",thumb:"https://img.youtube.com/vi/vgbrIy08e2w/mqdefault.jpg"},{name:"T√¢m L·∫∑ng Nh∆∞ N∆∞·ªõc",type:"mp4",id:"https://files.catbox.moe/p42gvs.mp4",thumb:"https://img.youtube.com/vi/ae9JqrRNWLk/mqdefault.jpg"},{name:"T·ª´ C·ª≠u M√¥n H·ªìi ·ª®c",type:"mp4",id:"https://files.catbox.moe/cqqpwx.mp4",thumb:"https://img.youtube.com/vi/IE7uUnMClsw/hqdefault.jpg"},{name:"Tam B√°i H·ªìng Tr·∫ßn L∆∞∆°ng",type:"mp4",id:"https://files.catbox.moe/f3yf9a.mp4",thumb:"https://img.youtube.com/vi/esWdcDSSrvE/hqdefault.jpg"}];
    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player; function onYouTubeIframeAPIReady() { player = new YT.Player('player', { height: '100%', width: '100%', videoId: '' }); }
    function playMedia(source, type) { const ytDiv = document.getElementById('player'); const mp4Div = document.getElementById('mp4-player'); if(player && player.stopVideo) player.stopVideo(); mp4Div.pause(); if (type === 'mp4') { ytDiv.style.display = 'none'; mp4Div.style.display = 'block'; mp4Div.src = source; mp4Div.play(); } else { mp4Div.style.display = 'none'; ytDiv.style.display = 'block'; player.loadVideoById(source); } }
    function renderMusic() { const tpl = (s) => `<div class="song-item" onclick="playMedia('${s.id}', '${s.type}')"><img src="${s.thumb}"><div><h4 class="text-[10px] font-bold uppercase">${s.name}</h4><p class="text-[9px] text-gray-400">${s.type === 'mp4' ? 'NO ADS' : 'Youtube'}</p></div></div>`; document.getElementById('v-list').innerHTML = vPop.map(tpl).join(''); document.getElementById('c-list').innerHTML = cPop.map(tpl).join(''); }
    
    // FULL VOCAB LIST HSK1
    const vocabData = [
        { hz: "Êàë", py: "w«í", mn: "t√¥i" }, { hz: "‰Ω†", py: "n«ê", mn: "b·∫°n" }, { hz: "‰ªñ", py: "tƒÅ", mn: "anh ·∫•y" }, { hz: "Â•π", py: "tƒÅ", mn: "c√¥ ·∫•y" }, { hz: "Êàë‰ª¨", py: "w«ímen", mn: "ch√∫ng t√¥i" }, { hz: "Ë∞Å", py: "sh√©i", mn: "ai" },
        { hz: "Áà∏Áà∏", py: "b√†ba", mn: "b·ªë" }, { hz: "Â¶àÂ¶à", py: "mƒÅma", mn: "m·∫π" }, { hz: "ËÄÅÂ∏à", py: "l«éoshƒ´", mn: "th·∫ßy c√¥" }, { hz: "Â≠¶Áîü", py: "xu√©sheng", mn: "h·ªçc sinh" }, { hz: "ÊòØ", py: "sh√¨", mn: "l√†" }, { hz: "‰∏ç", py: "b√π", mn: "kh√¥ng" }, { hz: "Âêó", py: "ma", mn: "kh√¥ng (h·ªèi)" },
        { hz: "ÂåªÁîü", py: "yƒ´shƒìng", mn: "b√°c sƒ©" }, { hz: "È´òÂÖ¥", py: "gƒÅox√¨ng", mn: "vui v·∫ª" }, { hz: "Âæà", py: "hƒõn", mn: "r·∫•t" }, { hz: "ÂÆ∂", py: "jiƒÅ", mn: "nh√†" }, { hz: "Âéª", py: "q√π", mn: "ƒëi" }, { hz: "ÂêÉ", py: "chƒ´", mn: "ƒÉn" }, { hz: "ËãπÊûú", py: "p√≠nggu«í", mn: "t√°o" }
        // (B·∫°n c√≥ th·ªÉ th√™m ƒë·ªß 150 t·ª´ ·ªü ƒë√¢y, t√¥i r√∫t g·ªçn ƒë·ªÉ code kh√¥ng qu√° d√†i)
    ];

    const grammarBank = [
        { zh: "ÊàëÊòØÂ≠¶Áîü„ÄÇ", vi: "t√¥i l√† h·ªçc sinh", note: "C√¢u ch·ªØ ÊòØ (L√†): S + ÊòØ + O" },
        { zh: "ËøôÊòØ‰ªÄ‰πàÔºü", vi: "ƒë√¢y l√† c√°i g√¨", note: "C√¢u h·ªèi v·ªõi ‰ªÄ‰πà (C√°i g√¨)" },
    ];
    const readingData = [{id:1,zh:"‰Ω†Â•ΩÔºÅÊàëÂè´ÂàòÈìÅËä±...",key:"xin ch√†o t√¥i t√™n l∆∞u thi·∫øt hoa...", vi_display: "Xin ch√†o! T√¥i t√™n L∆∞u Thi·∫øt Hoa..."}];

    // --- KH·ªêI 2: LOGIC M·ªöI CHO "GHI NH·ªö" V√Ä "KI·ªÇM TRA" (AI SIMULATION) ---
    
    // 1. D·ªÆ LI·ªÜU NG·ªÆ PH√ÅP ƒê·ªÇ H·ªåC V√Ä TEST
    const grammarRules = [
        { id: "g1", struct: "S + ÊòØ + n", name: "C√¢u kh·∫≥ng ƒë·ªãnh (L√†)", ex: "ÊàëÊòØËÄÅÂ∏à (T√¥i l√† gi√°o vi√™n)", keywords: ["ÊòØ"], desc: "Ch·ªß ng·ªØ + ÊòØ + Danh t·ª´" },
        { id: "g2", struct: "S + ‰∏ç + ÊòØ + n", name: "C√¢u ph·ªß ƒë·ªãnh (Kh√¥ng l√†)", ex: "Êàë‰∏çÊòØÂ≠¶Áîü (T√¥i kh√¥ng ph·∫£i h·ªçc sinh)", keywords: ["‰∏ç", "ÊòØ"], desc: "Ch·ªß ng·ªØ + ‰∏ç + ÊòØ + Danh t·ª´" },
        { id: "g3", struct: "S + ÊòØ + n + Âêó", name: "C√¢u nghi v·∫•n (Ph·∫£i kh√¥ng?)", ex: "‰Ω†ÊòØÂåªÁîüÂêóÔºü (B·∫°n l√† b√°c sƒ© ph·∫£i kh√¥ng?)", keywords: ["ÊòØ", "Âêó"], desc: "Ch·ªß ng·ªØ + ÊòØ + Danh t·ª´ + Âêó" },
        { id: "g4", struct: "ƒê·∫°i t·ª´ + ‰ª¨", name: "S·ªë nhi·ªÅu (Ng∆∞·ªùi)", ex: "Êàë‰ª¨ (Ch√∫ng t√¥i)", keywords: ["‰ª¨"], desc: "Th√™m ‰ª¨ sau ƒë·∫°i t·ª´ ho·∫∑c danh t·ª´ ch·ªâ ng∆∞·ªùi" }
    ];

    // 2. NG√ÇN H√ÄNG C√ÇU H·ªéI TEST (AI S·∫º CH·ªåN NG·∫™U NHI√äN)
    const quizBank = [
        { sent: "‰Ω†ÊòØËÄÅÂ∏àÂêóÔºü", type: "g3", s: "‰Ω†", n: "ËÄÅÂ∏à" },
        { sent: "Êàë‰∏çÊòØÂåªÁîü„ÄÇ", type: "g2", s: "Êàë", n: "ÂåªÁîü" },
        { sent: "‰ªñÊòØÂ≠¶Áîü„ÄÇ", type: "g1", s: "‰ªñ", n: "Â≠¶Áîü" },
        { sent: "Êàë‰ª¨ÂéªÂ≠¶Ê†°„ÄÇ", type: "g4", s: "Êàë‰ª¨", n: "Â≠¶Ê†°" } // M·ªü r·ªông
    ];

    // --- LOGIC TAB "GHI NH·ªö" ---
    function renderStudyTab() {
        const container = document.getElementById('grammar-list-container');
        container.innerHTML = "";
        grammarRules.forEach(rule => {
            const div = document.createElement('div');
            div.className = "grammar-box";
            div.innerHTML = `
                <h3 class="text-xl font-bold text-yellow-400 mb-2">${rule.struct}</h3>
                <p class="text-sm text-gray-300 mb-2"><i>${rule.name}</i></p>
                <div class="bg-black/30 p-4 rounded-xl border-l-4 border-pink-500">
                    <p class="text-lg font-bold">${rule.ex}</p>
                    <p class="text-xs text-gray-400 mt-1">${rule.desc}</p>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- LOGIC TAB "KI·ªÇM TRA" (AI FLOW) ---
    let currentQuiz = null;
    let quizStep = 0; // 0: Ch·ªçn ng·ªØ ph√°p, 1: T√¨m Ch·ªß ng·ªØ, 2: T√¨m Danh t·ª´, 3: T·ª± ƒë·∫∑t c√¢u

    function closeTestUI() {
        document.getElementById('test-menu').classList.remove('hidden');
        document.getElementById('grammar-test-ui').classList.add('hidden');
        document.getElementById('fill-test-ui').classList.add('hidden');
    }

    function startGrammarTest() {
        document.getElementById('test-menu').classList.add('hidden');
        document.getElementById('grammar-test-ui').classList.remove('hidden');
        
        // AI ch·ªçn 1 c√¢u ng·∫´u nhi√™n
        currentQuiz = quizBank[Math.floor(Math.random() * quizBank.length)];
        quizStep = 0;
        
        // Reset UI
        document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active'));
        document.getElementById('s1').classList.add('active');
        document.getElementById('gt-prompt').innerText = "AI: C√¢u n√†y thu·ªôc ng·ªØ ph√°p n√†o?";
        document.getElementById('gt-question').innerText = currentQuiz.sent;
        document.getElementById('gt-feedback').innerText = "";
        
        // Hi·ªán Options tr·∫Øc nghi·ªám cho b∆∞·ªõc 1
        const optDiv = document.getElementById('gt-options');
        optDiv.innerHTML = "";
        optDiv.classList.remove('hidden');
        document.getElementById('gt-input').classList.add('hidden'); // ·∫®n input text ƒëi
        
        grammarRules.forEach(rule => {
            const btn = document.createElement('button');
            btn.className = "p-3 bg-white/10 hover:bg-pink-600 rounded-lg text-sm font-bold border border-white/20 transition text-left";
            btn.innerText = rule.struct;
            btn.onclick = () => submitStep1(rule.id);
            optDiv.appendChild(btn);
        });
    }

    function submitStep1(selectedId) {
        if (selectedId === currentQuiz.type) {
            nextStep(1, "Ch√≠nh x√°c! +1 Coin", "AI: Trong c√¢u n√†y, CH·ª¶ NG·ªÆ l√† g√¨?");
            updateCoins(1);
        } else {
            document.getElementById('gt-feedback').innerText = "Sai r·ªìi! Th·ª≠ l·∫°i ƒëi.";
            document.getElementById('gt-feedback').style.color = "#f87171";
            updateCoins(-1);
        }
    }

    function nextStep(step, feedbackMsg, nextPrompt) {
        quizStep = step;
        const fb = document.getElementById('gt-feedback');
        fb.innerText = feedbackMsg;
        fb.style.color = "#4ade80";
        
        document.getElementById('gt-prompt').innerText = nextPrompt;
        
        // Update Steps UI
        document.querySelectorAll('.step-dot').forEach((d, i) => {
            if(i <= step) d.classList.add('active');
        });

        // Chuy·ªÉn sang Input Text cho c√°c b∆∞·ªõc sau
        if(step > 0) {
            document.getElementById('gt-options').classList.add('hidden');
            const inp = document.getElementById('gt-input');
            inp.classList.remove('hidden');
            inp.value = "";
            inp.focus();
        }
    }

    function checkGrammarStep() {
        if(quizStep === 0) return; // B∆∞·ªõc 1 x·ª≠ l√Ω ·ªü tr√™n r·ªìi

        const val = document.getElementById('gt-input').value.trim();
        let isCorrect = false;

        if (quizStep === 1) { // T√¨m Ch·ªß ng·ªØ
            if (val === currentQuiz.s) {
                isCorrect = true;
                nextStep(2, "ƒê√∫ng ch·ªß ng·ªØ! +1 Coin", "AI: V·∫≠y DANH T·ª™ ch√≠nh l√† g√¨?");
            }
        } 
        else if (quizStep === 2) { // T√¨m Danh t·ª´
            if (val === currentQuiz.n) {
                isCorrect = true;
                nextStep(3, "Chu·∫©n lu√¥n! +1 Coin", `AI: Gi·ªèi l·∫Øm! Gi·ªù h√£y t·ª± ƒë·∫∑t 1 c√¢u d√πng ng·ªØ ph√°p n√†y:`);
            }
        }
        else if (quizStep === 3) { // T·ª± ƒë·∫∑t c√¢u (AI Check)
            // AI Logic Check: Ph·∫£i ch·ª©a keyword c·ªßa ng·ªØ ph√°p ƒë√≥
            const rule = grammarRules.find(r => r.id === currentQuiz.type);
            const hasKeywords = rule.keywords.every(k => val.includes(k));
            
            if (hasKeywords && val.length > 3) {
                isCorrect = true;
                document.getElementById('gt-feedback').innerText = "AI: C√¢u c·ªßa b·∫°n r·∫•t t·ªët! +5 Coin";
                document.getElementById('gt-feedback').style.color = "#4ade80";
                updateCoins(5);
                setTimeout(startGrammarTest, 2000); // C√¢u m·ªõi
                return;
            } else {
                document.getElementById('gt-feedback').innerText = `AI: C√¢u n√†y ch∆∞a ·ªïn. Ph·∫£i c√≥ t·ª´: ${rule.keywords.join(", ")}`;
                document.getElementById('gt-feedback').style.color = "#f87171";
                return;
            }
        }

        if (isCorrect) updateCoins(1);
        else {
            document.getElementById('gt-feedback').innerText = "Ch∆∞a ƒë√∫ng, th·ª≠ l·∫°i xem!";
            document.getElementById('gt-feedback').style.color = "#f87171";
            updateCoins(-1);
        }
    }

    // --- LOGIC "ƒêI·ªÄN T·ª™ H·ªòI THO·∫†I" (AI GENERATOR) ---
    function startFillBlankTest() {
        document.getElementById('test-menu').classList.add('hidden');
        document.getElementById('fill-test-ui').classList.remove('hidden');
        
        // AI t·∫°o h·ªôi tho·∫°i ng·∫´u nhi√™n t·ª´ vocabData
        // M·∫´u: A: Xin ch√†o [T√™n/ƒê·∫°i t·ª´]! -> B: Ch√†o [ƒê·∫°i t·ª´].
        // M·∫´u: A: B·∫°n ƒëi [ƒê·ªông t·ª´] kh√¥ng? -> B: Kh√¥ng, t√¥i [ƒê·ªông t·ª´] [Danh t·ª´].
        
        const subjects = vocabData.filter(w => w.mn.includes("t√¥i") || w.mn.includes("b·∫°n") || w.mn.includes("anh"));
        const verbs = vocabData.filter(w => w.mn.includes("ƒÉn") || w.mn.includes("u·ªëng") || w.mn.includes("ƒëi"));
        const objects = vocabData.filter(w => w.mn.includes("t√°o") || w.mn.includes("tr√†") || w.mn.includes("tr∆∞·ªùng"));

        const s = subjects[Math.floor(Math.random() * subjects.length)];
        const v = verbs[Math.floor(Math.random() * verbs.length)];
        const o = objects[Math.floor(Math.random() * objects.length)];

        // T·∫°o c√¢u: T√¥i ƒëi ƒÉn t√°o (V√≠ d·ª•)
        const sentenceParts = [s.hz, v.hz, o.hz]; 
        const missingIndex = 1; // Lu√¥n gi·∫•u ƒë·ªông t·ª´ (v√≠ d·ª•)
        const missingWord = sentenceParts[missingIndex];

        let html = `<div class="chat-bubble">A: ‰Ω†Â•ΩÔºÅ</div><br>`;
        html += `<div class="chat-bubble">B: Êàë <span class="fill-blank" id="blank-slot">____</span> ${o.hz}„ÄÇ</div>`;
        
        document.getElementById('ft-dialogue').innerHTML = html;
        document.getElementById('ft-feedback').innerText = "";

        // T·∫°o ƒë√°p √°n nhi·ªÖu
        const options = [v];
        while(options.length < 4) {
            const r = vocabData[Math.floor(Math.random() * vocabData.length)];
            if (!options.includes(r)) options.push(r);
        }
        // Shuffle
        options.sort(() => Math.random() - 0.5);

        const optDiv = document.getElementById('ft-options');
        optDiv.innerHTML = "";
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "px-4 py-2 bg-white/10 hover:bg-green-500 rounded-lg font-bold border border-white/20";
            btn.innerText = opt.hz;
            btn.onclick = () => {
                if(opt.hz === missingWord) {
                    document.getElementById('blank-slot').innerText = opt.hz;
                    document.getElementById('blank-slot').style.color = "#4ade80";
                    document.getElementById('ft-feedback').innerText = "CH√çNH X√ÅC! +2 COIN";
                    updateCoins(2);
                    setTimeout(startFillBlankTest, 1500);
                } else {
                    document.getElementById('ft-feedback').innerText = "SAI R·ªíI!";
                    updateCoins(-1);
                }
            };
            optDiv.appendChild(btn);
        });
    }

    // --- KH·ªêI 3: INIT & NAVIGATOR (B·∫¢O V·ªÜ) ---
    let vMode = 0; let vIdx = 0; let sIdx = 0; let gIdx = 0; let gMode = 0; let rIdx = 0; let isShowingAnswer = false;
    let remainingIndices = [];
    
    function initVocabSystem() {
        const saved = localStorage.getItem('skyVocabProgress');
        if (saved) { try { remainingIndices = JSON.parse(saved); if (!Array.isArray(remainingIndices) || remainingIndices.length === 0) resetVocabProgress(); } catch (e) { resetVocabProgress(); } } else { resetVocabProgress(); }
    }
    function resetVocabProgress() { remainingIndices = Array.from({length: vocabData.length}, (_, i) => i); localStorage.setItem('skyVocabProgress', JSON.stringify(remainingIndices)); }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-' + id).classList.add('active');
        
        // LOGIC K√çCH HO·∫†T THEO TAB
        if(id === 'vocab') { initVocabSystem(); nextVocab(true); }
        if(id === 'speaking') updateSpeakUI();
        if(id === 'grammar') nextGrammar();
        if(id === 'reading') nextParagraph();
        if(id === 'study') renderStudyTab(); // Load tab ghi nh·ªõ
    }

    // (Gi·ªØ nguy√™n c√°c h√†m checkReading, nextVocab, checkVocab, nextGrammar...)
    // ... [ƒê√É L∆Ø·ª¢C B·ªöT ƒê·ªÇ CODE G·ªåN, NH∆ØNG B·∫†N HI·ªÇU L√Ä N√ì V·∫™N N·∫∞M ·ªû ƒê√ÇY NH∆Ø B·∫¢N C≈®] ...
    function nextParagraph(){let newIdx;do{newIdx=Math.floor(Math.random()*readingData.length);}while(newIdx===rIdx&&readingData.length>1);rIdx=newIdx;const item=readingData[rIdx];document.getElementById('r-text').innerText=item.zh;document.getElementById('r-input').value="";document.getElementById('r-msg').innerText="";document.getElementById('r-toggle-btn').innerText="Xem ƒê√°p √Ån (Vi·ªát)";isShowingAnswer=false;}
    function toggleReadingRef(){const txt=document.getElementById('r-text');const btn=document.getElementById('r-toggle-btn');const item=readingData[rIdx];isShowingAnswer=!isShowingAnswer;if(isShowingAnswer){txt.innerText=item.vi_display;btn.innerText="Xem C√¢u H·ªèi (Trung)";}else{txt.innerText=item.zh;btn.innerText="Xem ƒê√°p √Ån (Vi·ªát)";}}
    function checkReading(){const input=document.getElementById('r-input').value.trim().toLowerCase();const target=readingData[rIdx].key;const card=document.getElementById('reading-card');const inputWords=input.split(/\s+/);const targetWords=target.split(/\s+/);let matchCount=0;inputWords.forEach(word=>{if(target.includes(word))matchCount++;});const score=matchCount/targetWords.length;if(score>0.5){updateCoins(1);document.getElementById('r-msg').innerText=`R·∫§T T·ªêT! (${Math.round(score*100)}%)`;document.getElementById('r-msg').style.color="#4ade80";card.classList.add('glow-green');}else{updateCoins(-1);document.getElementById('r-msg').innerText=`CH∆ØA ƒê·∫†T (${Math.round(score*100)}%)`;document.getElementById('r-msg').style.color="#f87171";card.classList.add('glow-red');}}
    function nextVocab(random=true){if(remainingIndices.length===0){if(confirm("B·∫°n ƒë√£ ho√†n th√†nh 150 t·ª´ v·ª±ng! C√≥ mu·ªën h·ªçc l·∫°i kh√¥ng?")){resetVocabProgress();}else{return;}}if(random){const randomIndex=Math.floor(Math.random()*remainingIndices.length);vIdx=remainingIndices[randomIndex];}const item=vocabData[vIdx];document.getElementById('v-question').innerText=vMode===0?item.hz:(vMode===1?item.mn.toUpperCase():item.hz);document.getElementById('v-input').value="";document.getElementById('v-msg').innerText="";document.getElementById('v-hint').innerText="";document.getElementById('v-hint').classList.add('hidden');document.getElementById('vocab-card').classList.remove('glow-green','glow-red');}
    function checkVocab(){const item=vocabData[vIdx];const val=document.getElementById('v-input').value.trim().toLowerCase();let correct=false;if(vMode===0)correct=val===item.mn.toLowerCase();else if(vMode===1)correct=val===item.hz;else correct=val===item.py.toLowerCase()||val===item.py.normalize("NFD").replace(/[\u0300-\u036f]/g,"");const feedback=document.getElementById('v-msg');const hint=document.getElementById('v-hint');if(correct){updateCoins(1);feedback.innerText="CH√çNH X√ÅC!";feedback.style.color="#4ade80";document.getElementById('vocab-card').classList.add('glow-green');speakText(item.hz);hint.classList.add('hidden');remainingIndices=remainingIndices.filter(id=>id!==vIdx);localStorage.setItem('skyVocabProgress',JSON.stringify(remainingIndices));setTimeout(()=>nextVocab(true),1200);}else{updateCoins(-1);feedback.innerText="SAI R·ªíI";feedback.style.color="#f87171";hint.innerText="ƒê√ÅP √ÅN: "+(vMode===0?item.mn.toUpperCase():item.hz);hint.classList.remove('hidden');document.getElementById('vocab-card').classList.add('glow-red');speakText(item.hz);}}
    function changeVocabMode(){vMode=(vMode+1)%3;const labels=["H√°n ‚ûî Vi·ªát","Vi·ªát ‚ûî H√°n","H√°n ‚ûî Pinyin"];document.getElementById('v-mode-btn').innerText="Mode: "+labels[vMode];nextVocab(false);}
    function updateSpeakUI(){const item=vocabData[sIdx];document.getElementById('s-hz').innerText=item.hz;document.getElementById('s-py').innerText=item.py;document.getElementById('s-mn').innerText=item.mn.toUpperCase();document.getElementById('speak-card').classList.remove('glow-green','glow-red');document.getElementById('s-status').innerText="B·∫•m mic v√† n√≥i ngay";document.getElementById('s-live-text').innerText="";}
    function changeSpeakWord(dir){sIdx=(sIdx+dir+vocabData.length)%vocabData.length;updateSpeakUI();}
    function toggleGrammarMode(){gMode=1-gMode;document.getElementById('g-mode-badge').innerText=gMode===0?"Trung ‚ûî Vi·ªát":"Vi·ªát ‚ûî Trung";nextGrammar();}
    function nextGrammar(){let newIdx;do{newIdx=Math.floor(Math.random()*grammarBank.length);}while(newIdx===gIdx&&grammarBank.length>1);gIdx=newIdx;const item=grammarBank[gIdx];document.getElementById('g-question').innerText=gMode===0?item.zh:item.vi.toUpperCase();document.getElementById('g-instruction').innerText=gMode===0?"D·ªãch c√¢u n√†y sang Ti·∫øng Vi·ªát":"D·ªãch c√¢u n√†y sang Ti·∫øng Trung";document.getElementById('g-input').value="";document.getElementById('g-msg').innerText="";document.getElementById('g-note').innerText="";document.getElementById('grammar-card').className="glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden";if(gMode===0)speakText(item.zh);}
    function checkGrammar(){const val=document.getElementById('g-input').value.trim().toLowerCase();const item=grammarBank[gIdx];const target=gMode===0?item.vi:item.zh;const card=document.getElementById('grammar-card');let isCorrect=false;if(gMode===0)isCorrect=val===target.toLowerCase()||(target.toLowerCase().includes(val)&&val.length>5);else isCorrect=val===target||val===target.replace(/Ôºü|„ÄÇ/g,"");speakText(item.zh);if(isCorrect){updateCoins(1);document.getElementById('g-msg').innerText="R·∫§T T·ªêT!";card.classList.add('glow-green');setTimeout(nextGrammar,2000);}else{updateCoins(-1);document.getElementById('g-msg').innerText="CH∆ØA CH√çNH X√ÅC";document.getElementById('g-note').innerHTML=`<span class="text-red-400">ƒê√ÅP √ÅN: ${target}</span>`;card.classList.add('glow-red');}}

    // --- KH·ªêI 4: GAME 3D BUILDER (T·ª™ V44) ---
    // (Copy y nguy√™n logic game world V44 m√† b·∫°n ƒë√£ ∆∞ng √Ω)
    // ... [ƒê√É T√çCH H·ª¢P ·ªû TR√äN: enterGameWorld, initGame, animate...]

    const cursor = document.getElementById('cursor'); document.addEventListener('mousemove', e => { cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; }); function handleGlobalClick() { cursor.style.transform = "scale(2)"; setTimeout(() => cursor.style.transform = "scale(1)", 150); }
    window.onload = () => { renderMusic(); switchTab('home'); initVocabSystem(); };
</script>
</body>
</html>
