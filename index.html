<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Chinese Hub | Debug Core v16.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <style>
        /* --- VISUAL CORE --- */
        :root { --primary: #6366f1; --accent: #f472b6; }
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #000000);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff; min-height: 100vh; overflow-x: hidden; cursor: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #cursor { position: fixed; width: 20px; height: 20px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .glass-card:hover { transform: translateY(-5px); }
        nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 8px; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { padding: 12px 24px; border-radius: 18px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; color: #94a3b8; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.5s forwards; padding-bottom: 100px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .glow-green { box-shadow: 0 0 40px #22c55e !important; border-color: #22c55e !important; }
        .glow-red { box-shadow: 0 0 40px #ef4444 !important; border-color: #ef4444 !important; }
        .mic-ripple { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--primary); opacity: 0; animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }
        .song-item { display: flex; gap: 12px; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; align-items: center; }
        .song-item:hover { background: rgba(255,255,255,0.15); }
        .song-item img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        
        /* DEBUG CONSOLE STYLE */
        .debug-console {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 10px;
            color: #00ff00;
            font-size: 10px;
            margin-top: 15px;
            min-height: 40px;
            text-align: left;
            overflow: hidden;
            width: 100%;
        }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="cursor"></div>

<nav>
    <button onclick="switchTab('home')" class="nav-btn active" id="n-home">Sảnh</button>
    <button onclick="switchTab('vocab')" class="nav-btn" id="n-vocab">Học Từ</button>
    <button onclick="switchTab('speaking')" class="nav-btn" id="n-speaking">Luyện Nói</button>
    <button onclick="switchTab('grammar')" class="nav-btn" id="n-grammar">Ngữ Pháp</button>
    <button onclick="switchTab('music')" class="nav-btn" id="n-music">Nhạc</button>
</nav>

<div id="home" class="tab-content active">
    <div class="h-screen flex items-center justify-center">
        <div class="glass-card p-12 text-center max-w-md mx-4">
            <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SKYREIGN</h1>
            <p class="text-xs tracking-[0.5em] text-gray-400 uppercase mb-10">Protocol v16.0 (Debug Mode)</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('vocab')" class="py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs uppercase tracking-widest transition">Luyện Từ</button>
                <button onclick="switchTab('speaking')" class="py-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-bold text-xs uppercase tracking-widest transition shadow-lg shadow-indigo-500/30">Luyện Nói</button>
            </div>
        </div>
    </div>
</div>

<div id="vocab" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-lg mx-4 relative" id="vocab-card">
            <div class="flex justify-between items-center mb-8">
                <button onclick="changeVocabMode()" id="v-mode-btn" class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition">Mode: Hán ➔ Việt</button>
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">HSK 1 & 2</div>
            </div>
            <div id="v-question" class="text-7xl font-black text-center mb-8 tracking-tighter min-h-[100px] flex items-center justify-center">?</div>
            <input type="text" id="v-input" placeholder="Nhập đáp án..." class="w-full bg-transparent border-b-2 border-white/20 py-3 text-center font-bold text-2xl outline-none focus:border-indigo-500 transition text-white placeholder-gray-600 mb-8" autocomplete="off">
            <button onclick="checkVocab()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-gray-200 transition mb-4">Kiểm Tra</button>
            <div id="v-feedback" class="text-center h-10">
                <p id="v-msg" class="text-[11px] font-bold uppercase tracking-widest"></p>
                <p id="v-hint" class="text-[10px] text-gray-400 mt-1"></p>
            </div>
        </div>
    </div>
</div>

<div id="speaking" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-md mx-4 text-center" id="speak-card">
            <div class="text-[10px] uppercase tracking-widest text-indigo-400 font-black mb-8">AI Voice Debugger</div>
            <div class="mb-8 relative group">
                <div id="s-hz" class="text-9xl font-black mb-2 tracking-tighter cursor-pointer transition hover:text-indigo-400" onclick="speakText(document.getElementById('s-hz').innerText)">我</div>
                <div id="s-py" class="text-2xl text-gray-500 mb-1">wǒ</div>
                <div id="s-mn" class="text-xs font-bold bg-white/10 px-3 py-1 rounded-full inline-block">TÔI</div>
            </div>
            
            <div class="flex justify-center items-center gap-6 mb-4">
                <button onclick="changeSpeakWord(-1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">←</button>
                <div class="relative">
                    <div id="mic-ring" class="hidden mic-ripple"></div>
                    <button id="mic-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl relative z-10 transition hover:scale-110 active:scale-90 text-white">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    </button>
                </div>
                <button onclick="changeSpeakWord(1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">→</button>
            </div>

            <div id="s-feedback" class="text-[11px] font-bold uppercase tracking-widest text-gray-400 h-8 flex items-center justify-center">
                Bấm mic và nói...
            </div>
            
            <div class="debug-console">
                <span class="text-gray-500">> RAW INPUT: </span><span id="s-debug-text" class="animate-pulse">...</span>
            </div>
        </div>
    </div>
</div>

<div id="grammar" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden" id="grammar-card">
            <div class="flex justify-between items-center mb-10">
                <button onclick="toggleGrammarMode()" id="g-mode-badge" class="text-[10px] font-black bg-indigo-600 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-110 transition shadow-lg shadow-indigo-500/50">Trung ➔ Việt</button>
                <div class="text-[9px] font-bold text-gray-400">AI AUDIO ENABLED</div>
            </div>
            <div class="text-center mb-10 min-h-[120px] flex flex-col justify-center items-center">
                <div id="g-question" class="text-4xl md:text-5xl font-bold tracking-tight mb-4 leading-tight drop-shadow-lg cursor-pointer hover:text-indigo-300 transition" onclick="readGrammarQuestion()">...</div>
                <p id="g-instruction" class="text-gray-500 text-sm italic">Hãy dịch câu trên</p>
            </div>
            <input type="text" id="g-input" placeholder="Nhập câu trả lời..." class="w-full bg-transparent border-b-2 border-white/10 py-4 text-center text-xl font-medium outline-none focus:border-indigo-500 transition mb-6 text-white placeholder-gray-600" autocomplete="off">
            <div class="grid grid-cols-4 gap-4 mb-6">
                <button onclick="nextGrammar()" class="col-span-1 py-4 bg-white/5 hover:bg-white/10 rounded-2xl font-bold text-[10px] uppercase tracking-widest text-gray-400 hover:text-white transition">Bỏ qua</button>
                <button onclick="checkGrammar()" class="col-span-3 py-4 bg-white text-black hover:bg-indigo-400 hover:text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] transition shadow-lg">Kiểm tra</button>
            </div>
            <div id="g-feedback" class="text-center h-20">
                <div id="g-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></div>
                <div id="g-note" class="text-[11px] text-pink-400 font-medium"></div>
            </div>
        </div>
    </div>
</div>

<div id="music" class="tab-content">
    <div class="min-h-screen flex flex-col items-center justify-center pt-20 pb-20">
        <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-6xl px-4">
            <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto">
                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-indigo-400 border-b border-white/10 pb-2">V-Pop Hits</h3>
                <div id="v-list" class="space-y-2"></div>
            </div>
            <div class="w-full max-w-md flex flex-col items-center">
                <h4 class="text-4xl font-black text-white tracking-tighter uppercase mb-4 drop-shadow-lg">Music Pod</h4>
                <div class="relative w-full h-[300px]">
                     <model-viewer src="./airpods.glb" alt="My Airpods" auto-rotate camera-controls shadow-intensity="1" exposure="0.8" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                </div>
                <div class="w-full aspect-video bg-black rounded-2xl overflow-hidden border-2 border-white/20 shadow-2xl mt-[-40px] relative z-10">
                    <div id="player"></div> 
                    <video id="mp4-player" controls playsinline class="hidden w-full h-full object-cover"></video>
                </div>
            </div>
            <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto">
                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-pink-400 border-b border-white/10 pb-2">Chinese Hits</h3>
                <div id="c-list" class="space-y-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function speakText(text) {
        if(!text) return; window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text); msg.lang = 'zh-CN'; msg.rate = 0.8; 
        window.speechSynthesis.speak(msg);
    }

    const vocabData = [
        { hz: "我", py: "wǒ", mn: "tôi" }, { hz: "你", py: "nǐ", mn: "bạn" }, { hz: "是", py: "shì", mn: "là" }, { hz: "有", py: "yǒu", mn: "có" },
        { hz: "爸爸", py: "bàba", mn: "bố" }, { hz: "妈妈", py: "māma", mn: "mẹ" }, { hz: "老师", py: "lǎoshī", mn: "thầy cô" }, { hz: "学校", py: "xuéxiào", mn: "trường học" },
        { hz: "人", py: "rén", mn: "người" }, { hz: "名字", py: "míngzi", mn: "tên" }, { hz: "书", py: "shū", mn: "sách" }, { hz: "水", py: "shuǐ", mn: "nước" },
        { hz: "帮助", py: "bāngzhù", mn: "giúp đỡ" }, { hz: "别", py: "bié", mn: "đừng" }, { hz: "公司", py: "gōngsī", mn: "công ty" },
        { hz: "大家", py: "dàjiā", mn: "mọi người" }, { hz: "懂", py: "dǒng", mn: "hiểu" }, { hz: "房间", py: "fángjiān", mn: "phòng" },
        { hz: "非常", py: "fēicháng", mn: "vô cùng" }, { hz: "高", py: "gāo", mn: "cao" }, { hz: "告诉", py: "gàosu", mn: "nói cho biết" },
        { hz: "给", py: "gěi", mn: "cho / đưa" }, { hz: "公共汽车", py: "gōnggòngqìchē", mn: "xe buýt" }, { hz: "贵", py: "guì", mn: "đắt" },
        { hz: "好吃", py: "hǎochī", mn: "ngon" }, { hz: "欢迎", py: "huānyíng", mn: "hoan nghênh" }, { hz: "件", py: "jiàn", mn: "chiếc/cái" },
        { hz: "觉得", py: "juéde", mn: "cảm thấy" }, { hz: "咖啡", py: "kāfēi", mn: "cà phê" }, { hz: "开始", py: "kāishǐ", mn: "bắt đầu" },
        { hz: "考试", py: "kǎoshì", mn: "thi" }, { hz: "可能", py: "kěnéng", mn: "có khả năng" }, { hz: "可以", py: "kěyǐ", mn: "có thể" },
        { hz: "快", py: "kuài", mn: "nhanh" }, { hz: "快乐", py: "kuàilè", mn: "vui vẻ" }, { hz: "累", py: "lèi", mn: "mệt" },
        { hz: "离", py: "lí", mn: "cách" }, { hz: "路", py: "lù", mn: "đường" }, { hz: "旅游", py: "lǚyóu", mn: "du lịch" },
        { hz: "卖", py: "mài", mn: "bán" }, { hz: "慢", py: "màn", mn: "chậm" }, { hz: "忙", py: "máng", mn: "bận" },
        { hz: "每", py: "měi", mn: "mỗi" }, { hz: "妹妹", py: "mèimei", mn: "em gái" }, { hz: "男人", py: "nánrén", mn: "đàn ông" },
        { hz: "牛奶", py: "niúnǎi", mn: "sữa bò" }, { hz: "女人", py: "nǚrén", mn: "phụ nữ" }, { hz: "旁边", py: "pángbiān", mn: "bên cạnh" },
        { hz: "跑步", py: "pǎobù", mn: "chạy bộ" }, { hz: "便宜", py: "piányi", mn: "rẻ" }, { hz: "票", py: "piào", mn: "vé" },
        { hz: "起床", py: "qǐchuáng", mn: "ngủ dậy" }, { hz: "让", py: "ràng", mn: "nhường/bảo" }, { hz: "上班", py: "shàngbān", mn: "đi làm" },
        { hz: "身体", py: "shēntǐ", mn: "sức khỏe" }, { hz: "生病", py: "shēngbìng", mn: "bị ốm" }, { hz: "时间", py: "shíjiān", mn: "thời gian" },
        { hz: "手机", py: "shǒujī", mn: "điện thoại" }, { hz: "送", py: "sòng", mn: "tặng/tiễn" }, { hz: "虽然", py: "suīrán", mn: "tuy rằng" },
        { hz: "但是", py: "dànshì", mn: "nhưng mà" }, { hz: "踢足球", py: "tīzúqiú", mn: "đá bóng" }, { hz: "外", py: "wài", mn: "ngoài" },
        { hz: "玩", py: "wán", mn: "chơi" }, { hz: "晚上", py: "wǎnshang", mn: "buổi tối" }, { hz: "为什么", py: "wèishénme", mn: "tại sao" },
        { hz: "问题", py: "wèntí", mn: "vấn đề" }, { hz: "希望", py: "xīwàng", mn: "hy vọng" }, { hz: "洗", py: "xǐ", mn: "rửa" },
        { hz: "小时", py: "xiǎoshí", mn: "tiếng đồng hồ" }, { hz: "笑", py: "xiào", mn: "cười" }, { hz: "新", py: "xīn", mn: "mới" },
        { hz: "休息", py: "xiūxi", mn: "nghỉ ngơi" }, { hz: "眼睛", py: "yǎnjing", mn: "mắt" }, { hz: "药", py: "yào", mn: "thuốc" },
        { hz: "要", py: "yào", mn: "muốn/cần" }, { hz: "也", py: "yě", mn: "cũng" }, { hz: "一起", py: "yìqǐ", mn: "cùng nhau" },
        { hz: "已经", py: "yǐjīng", mn: "đã" }, { hz: "意思", py: "yìsi", mn: "ý nghĩa" }, { hz: "因为", py: "yīnwèi", mn: "bởi vì" },
        { hz: "所以", py: "suǒyǐ", mn: "cho nên" }, { hz: "游泳", py: "yóuyǒng", mn: "bơi lội" }, { hz: "右边", py: "yòubian", mn: "bên phải" },
        { hz: "鱼", py: "yú", mn: "cá" }, { hz: "远", py: "yuǎn", mn: "xa" }, { hz: "运动", py: "yùndòng", mn: "vận động" },
        { hz: "再", py: "zài", mn: "nữa/lại" }, { hz: "早上", py: "zǎoshang", mn: "buổi sáng" }, { hz: "找", py: "zhǎo", mn: "tìm" },
        { hz: "知道", py: "zhīdao", mn: "biết" }, { hz: "准备", py: "zhǔnbèi", mn: "chuẩn bị" }, { hz: "自行车", py: "zìxíngchē", mn: "xe đạp" },
        { hz: "走", py: "zǒu", mn: "đi (bộ)" }, { hz: "最", py: "zuì", mn: "nhất" }, { hz: "左边", py: "zuǒbian", mn: "bên trái" }
    ];

    const grammarBank = [
        { zh: "你叫什么名字？", vi: "bạn tên là gì", note: "叫 (jiào): Tên là" },
        { zh: "他是我的老师", vi: "anh ấy là giáo viên của tôi", note: "的 (de): Sở hữu cách" },
        { zh: "我去商店买东西", vi: "tôi đi cửa hàng mua đồ", note: "去 (qù) + Địa điểm + Làm gì" },
        { zh: "在这个学校有很多学生", vi: "ở trường này có rất nhiều học sinh", note: "在 (zài): Ở" },
        { zh: "你会说汉语吗", vi: "bạn biết nói tiếng trung không", note: "会 (huì): Biết (qua học tập)" },
        { zh: "我不喜欢喝茶", vi: "tôi không thích uống trà", note: "不 (bù): Không" },
        { zh: "现在几点", vi: "bây giờ là mấy giờ", note: "几 (jǐ): Mấy" },
        { zh: "你住在哪里", vi: "bạn sống ở đâu", note: "住 (zhù): Sống" },
        { zh: "这件衣服很漂亮", vi: "bộ quần áo này rất đẹp", note: "件 (jiàn): Lượng từ" },
        { zh: "我想去中国", vi: "tôi muốn đi trung quốc", note: "想 (xiǎng): Muốn" },
        { zh: "今天是星期几", vi: "hôm nay là thứ mấy", note: "星期 (xīngqī): Thứ" },
        { zh: "苹果多少钱", vi: "táo bao nhiêu tiền", note: "多少 (duōshao): Bao nhiêu" },
        { zh: "那是谁的书", vi: "kia là sách của ai", note: "那 (nà): Kia" },
        { zh: "我没钱", vi: "tôi không có tiền", note: "没 (méi): Không có" },
        { zh: "你认识他吗", vi: "bạn quen anh ấy không", note: "认识 (rènshi): Quen biết" }
    ];

    let vMode = 0; let vIdx = 0; let sIdx = 0; let gIdx = 0; let gMode = 0;

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-' + id).classList.add('active');
        if(id === 'vocab') nextVocab(false);
        if(id === 'speaking') updateSpeakUI();
        if(id === 'grammar') nextGrammar();
    }

    function changeVocabMode() {
        vMode = (vMode + 1) % 3;
        const labels = ["Hán ➔ Việt", "Việt ➔ Hán", "Hán ➔ Pinyin"];
        const colors = ["bg-pink-500", "bg-indigo-500", "bg-teal-500"];
        document.getElementById('v-mode-btn').innerText = "Mode: " + labels[vMode];
        document.getElementById('v-mode-btn').className = `text-[10px] font-black ${colors[vMode]} px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition`;
        nextVocab(false);
    }
    function nextVocab(random = true) {
        if(random) vIdx = Math.floor(Math.random() * vocabData.length);
        const item = vocabData[vIdx];
        const qDiv = document.getElementById('v-question');
        document.getElementById('v-input').value = "";
        document.getElementById('v-msg').innerText = "";
        document.getElementById('v-hint').innerText = "";
        document.getElementById('vocab-card').classList.remove('glow-green', 'glow-red');
        if(vMode === 0) qDiv.innerText = item.hz;
        else if(vMode === 1) qDiv.innerText = item.mn.toUpperCase();
        else qDiv.innerText = item.hz;
    }
    function checkVocab() {
        const item = vocabData[vIdx];
        const val = document.getElementById('v-input').value.trim().toLowerCase();
        let correct = false; let answer = "";
        if(vMode === 0) { correct = val === item.mn.toLowerCase(); answer = item.mn; }
        else if(vMode === 1) { correct = val === item.hz; answer = item.hz; }
        else { correct = val === item.py.toLowerCase() || val === item.py.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); answer = item.py; }
        const feedback = document.getElementById('v-msg');
        if(correct) {
            feedback.innerText = "CHÍNH XÁC!"; feedback.style.color = "#4ade80";
            document.getElementById('vocab-card').classList.add('glow-green');
            speakText(item.hz); setTimeout(() => nextVocab(true), 1200);
        } else {
            feedback.innerText = "SAI RỒI"; feedback.style.color = "#f87171";
            document.getElementById('v-hint').innerText = `Đáp án: ${answer}`;
            document.getElementById('vocab-card').classList.add('glow-red');
            speakText(item.hz);
        }
    }

    // --- LIVE DEBUG LOGIC ---
    function updateSpeakUI() {
        const item = vocabData[sIdx];
        document.getElementById('s-hz').innerText = item.hz;
        document.getElementById('s-py').innerText = item.py;
        document.getElementById('s-mn').innerText = item.mn.toUpperCase();
        document.getElementById('speak-card').classList.remove('glow-green', 'glow-red');
        document.getElementById('s-feedback').innerText = "Bấm nút micro để bắt đầu...";
        document.getElementById('s-debug-text').innerText = "...";
    }
    function changeSpeakWord(dir) { sIdx = (sIdx + dir + vocabData.length) % vocabData.length; updateSpeakUI(); }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SpeechRecognition) {
        const rec = new SpeechRecognition(); 
        rec.lang = 'zh-CN'; 
        rec.interimResults = true; // BẬT CHẾ ĐỘ LIVE INPUT
        
        const btn = document.getElementById('mic-btn');
        const fb = document.getElementById('s-feedback');
        const debugConsole = document.getElementById('s-debug-text');
        const ring = document.getElementById('mic-ring');

        btn.onclick = () => { try { rec.start(); } catch(e){} };

        rec.onstart = () => {
            ring.classList.remove('hidden');
            fb.innerText = "AI ĐANG NGHE...";
            fb.className = "text-[11px] font-black uppercase tracking-widest text-indigo-400 h-8 flex items-center justify-center animate-pulse";
            debugConsole.innerText = "";
        };

        rec.onend = () => { ring.classList.add('hidden'); };

        rec.onresult = (e) => {
            // Lấy kết quả
            let interimTrans = '';
            let finalTrans = '';

            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) {
                    finalTrans += e.results[i][0].transcript;
                } else {
                    interimTrans += e.results[i][0].transcript;
                }
            }

            // HIỂN THỊ RA DEBUG CONSOLE NGAY LẬP TỨC
            const display = finalTrans || interimTrans;
            debugConsole.innerText = display;

            // Kiểm tra kết quả
            if(finalTrans) {
                const clean = finalTrans.replace(/[.,?。？!！]/g, "");
                const target = vocabData[sIdx].hz;
                
                if(clean.includes(target)) {
                    fb.innerText = "CHÍNH XÁC! (CORRECT)";
                    fb.className = "text-[11px] font-black uppercase tracking-widest text-green-400 h-8 flex items-center justify-center";
                    document.getElementById('speak-card').classList.add('glow-green');
                } else {
                    fb.innerText = "SAI RỒI (WRONG)";
                    fb.className = "text-[11px] font-black uppercase tracking-widest text-red-400 h-8 flex items-center justify-center";
                    document.getElementById('speak-card').classList.add('glow-red');
                }
            }
        }
        rec.onerror = () => { fb.innerText = "Lỗi Mic"; ring.classList.add('hidden'); }
    }

    function toggleGrammarMode() {
        gMode = 1 - gMode;
        document.getElementById('g-mode-badge').innerText = gMode === 0 ? "Trung ➔ Việt" : "Việt ➔ Trung";
        nextGrammar();
    }
    function nextGrammar() {
        let newIdx; do { newIdx = Math.floor(Math.random() * grammarBank.length); } while (newIdx === gIdx && grammarBank.length > 1);
        gIdx = newIdx;
        const item = grammarBank[gIdx];
        document.getElementById('g-question').innerText = gMode === 0 ? item.zh : item.vi.toUpperCase();
        document.getElementById('g-instruction').innerText = gMode === 0 ? "Dịch câu này sang Tiếng Việt" : "Dịch câu này sang Tiếng Trung";
        document.getElementById('g-input').value = ""; document.getElementById('g-msg').innerText = ""; document.getElementById('g-note').innerText = "";
        document.getElementById('grammar-card').className = "glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden";
        if(gMode === 0) speakText(item.zh);
    }
    function checkGrammar() {
        const val = document.getElementById('g-input').value.trim().toLowerCase();
        const item = grammarBank[gIdx];
        const target = gMode === 0 ? item.vi : item.zh;
        const card = document.getElementById('grammar-card');
        let isCorrect = false;
        if (gMode === 0) isCorrect = val === target.toLowerCase() || (target.toLowerCase().includes(val) && val.length > 5);
        else isCorrect = val === target || val === target.replace(/？|。/g, "");
        speakText(item.zh); 
        if(isCorrect) {
            document.getElementById('g-msg').innerText = "RẤT TỐT!"; document.getElementById('g-msg').style.color = "#4ade80";
            document.getElementById('g-note').innerText = item.note; card.classList.add('glow-green'); setTimeout(nextGrammar, 2000);
        } else {
            document.getElementById('g-msg').innerText = "CHƯA CHÍNH XÁC"; document.getElementById('g-msg').style.color = "#f87171";
            document.getElementById('g-note').innerText = `Đáp án đúng: ${target}`; card.classList.add('glow-red');
        }
    }
    document.getElementById('g-input').addEventListener("keypress", function(event) { if (event.key === "Enter") checkGrammar(); });
    function readGrammarQuestion() { const item = grammarBank[gIdx]; speakText(item.zh); }

    const vPop = [{name:"Hôn vào đây",type:"mp4",id:"https://files.catbox.moe/kos9gw.mp4",thumb:"https://img.youtube.com/vi/vs-hsW6I63I/mqdefault.jpg"},{name:"Hà Nội",type:"mp4",id:"https://files.catbox.moe/1ygyge.mp4",thumb:"https://img.youtube.com/vi/OerAX-zKyvg/mqdefault.jpg"}];
    const cPop = [{name:"Sứ Thanh Hoa",type:"yt",id:"Z7vlR53_qNM",thumb:"https://img.youtube.com/vi/Z7vlR53_qNM/mqdefault.jpg"},{name:"Đáy Biển",type:"yt",id:"rJjQ4w-B3cE",thumb:"https://img.youtube.com/vi/rJjQ4w-B3cE/mqdefault.jpg"}];
    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player;
    function onYouTubeIframeAPIReady() { player = new YT.Player('player', { height: '100%', width: '100%', videoId: '' }); }
    function playMedia(source, type) {
        const ytDiv = document.getElementById('player'); const mp4Div = document.getElementById('mp4-player');
        if(player && player.stopVideo) player.stopVideo(); mp4Div.pause();
        if (type === 'mp4') { ytDiv.style.display = 'none'; mp4Div.style.display = 'block'; mp4Div.src = source; mp4Div.play(); } 
        else { mp4Div.style.display = 'none'; ytDiv.style.display = 'block'; player.loadVideoById(source); }
    }
    function renderMusic() {
        const tpl = (s) => `<div class="song-item" onclick="playMedia('${s.id}', '${s.type}')"><img src="${s.thumb}"><div><h4 class="text-[10px] font-bold uppercase">${s.name}</h4><p class="text-[9px] text-gray-400">${s.type === 'mp4' ? 'NO ADS' : 'Youtube'}</p></div></div>`;
        document.getElementById('v-list').innerHTML = vPop.map(tpl).join(''); document.getElementById('c-list').innerHTML = cPop.map(tpl).join('');
    }
    const cursor = document.getElementById('cursor');
    document.addEventListener('mousemove', e => { cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; });
    function handleGlobalClick() { cursor.style.transform = "scale(2)"; setTimeout(() => cursor.style.transform = "scale(1)", 150); }
    window.onload = () => { renderMusic(); switchTab('home'); };
</script>
</body>
</html>
