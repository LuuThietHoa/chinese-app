<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Hub | V30.0 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <style>
        /* CORE SETUP */
        :root { --primary: #6366f1; --accent: #f472b6; --glass: rgba(255, 255, 255, 0.05); }
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #020617, #1e1b4b, #be185d, #0f766e);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff; min-height: 100vh; overflow-x: hidden; cursor: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #cursor { position: fixed; width: 20px; height: 20px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s; }
        
        /* UI ELEMENTS */
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .glass-card:hover { transform: translateY(-5px); }
        
        /* NAVIGATION */
        nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 4px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; justify-content: center; width: 95%; max-width: 700px; }
        .nav-btn { padding: 8px 12px; border-radius: 12px; font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; color: #94a3b8; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
        
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.5s forwards; padding-bottom: 120px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* EFFECTS */
        .glow-green { box-shadow: 0 0 40px #22c55e !important; border-color: #22c55e !important; }
        .glow-red { box-shadow: 0 0 40px #ef4444 !important; border-color: #ef4444 !important; }
        .mic-ripple { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--primary); opacity: 0; animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }
        #progress-bar { width: 0%; height: 4px; background: #22c55e; transition: width 0.1s linear; position: absolute; bottom: 0; left: 0; }
        .reading-text { line-height: 1.8; letter-spacing: 1px; text-align: justify; }
        textarea:focus, input:focus { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        @keyframes coinPop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        .coin-pop-green { animation: coinPop 0.3s ease; color: #4ade80 !important; }
        .coin-pop-red { animation: coinPop 0.3s ease; color: #f87171 !important; }
        
        /* MODALS */
        .full-modal { transition: opacity 0.3s ease; }
        .full-modal.hidden { display: none; }
        .npc-bubble { position: absolute; background: white; color: black; padding: 12px; border-radius: 20px; border-bottom-left-radius: 0; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); font-weight: 800; font-size: 10px; max-width: 200px; border: 2px solid #6366f1; z-index: 50; }
        
        /* INVENTORY */
        .inv-slot { width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .inv-slot:hover { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .song-item { display: flex; gap: 12px; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; align-items: center; }
        .song-item:hover { background: rgba(255,255,255,0.15); }
        .song-item img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        
        /* SCHEDULE TABLE */
        .schedule-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px; }
        .schedule-table th { background: rgba(99, 102, 241, 0.2); padding: 10px; text-transform: uppercase; color: #a5b4fc; border: 1px solid rgba(255,255,255,0.1); }
        .schedule-table td { padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .time-chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .time-chip:hover { background: var(--primary); border-color: var(--primary); }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="cursor"></div>

<audio id="sfx-coin" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
<audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-click-900.mp3"></audio>
<audio id="sfx-type" src="https://assets.mixkit.co/sfx/preview/mixkit-keyboard-typing-1386.mp3"></audio>

<div class="fixed top-6 right-6 z-[2000] flex items-center gap-3 bg-black/40 backdrop-blur-xl px-5 py-2 rounded-full border border-yellow-500/30 shadow-2xl transition hover:scale-105">
    <div class="w-10 h-10">
        <model-viewer src="./coin.glb" alt="Coin" auto-rotate rotation-per-second="30deg" disable-zoom style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
    </div>
    <div class="flex flex-col items-end">
        <span class="text-[9px] font-bold text-yellow-500/80 uppercase tracking-widest">Balance</span>
        <span id="coin-display" class="text-2xl font-black text-yellow-400 leading-none tabular-nums">0</span>
    </div>
</div>

<div class="fixed top-24 right-6 z-[2000] cursor-pointer transition hover:scale-110 active:scale-95 group" onclick="openInventory()">
    <div class="w-16 h-16 relative bg-black/40 backdrop-blur rounded-full flex items-center justify-center border border-white/20">
        <span class="text-2xl">üéí</span>
        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-2 py-0.5 rounded-full font-black text-[8px] uppercase tracking-widest opacity-0 group-hover:opacity-100 transition whitespace-nowrap shadow-lg">T√∫i ƒê·ªì</div>
    </div>
</div>

<div id="shop-modal" class="full-modal hidden fixed inset-0 z-[3000] bg-black/95 flex items-center justify-center p-4">
    <div class="relative w-full max-w-6xl aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/10">
        <button onclick="closeShop()" class="absolute top-6 right-6 z-50 text-white hover:text-red-500 font-black text-xl bg-white/10 w-12 h-12 rounded-full flex items-center justify-center border border-white/20 transition hover:rotate-90">‚úï</button>
        <div class="absolute bottom-10 left-10 w-48 h-80 md:w-64 md:h-96 z-20">
            <model-viewer src="./main.glb" alt="Shopkeeper" environment-image="neutral" camera-controls disable-zoom shadow-intensity="2" exposure="1.5" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
            <div class="npc-bubble -top-10 left-20"><p id="npc-text">...</p></div>
        </div>
        <div class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
            <div class="relative w-72 h-72 md:w-[500px] md:h-[500px] pointer-events-auto group flex flex-col items-center">
                <button onclick="buyItem()" class="absolute -top-16 z-50 bg-yellow-500 hover:bg-yellow-400 text-black px-6 py-3 rounded-full font-black uppercase tracking-widest shadow-lg shadow-yellow-500/50 animate-bounce transition transform hover:scale-110 border-4 border-black">MUA NGAY (100 ü™ô)</button>
                <model-viewer id="shop-mob-viewer" src="./mob1.glb" alt="Mob" environment-image="neutral" auto-rotate camera-controls shadow-intensity="2" exposure="1.5" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                <div class="absolute top-20 -right-10 md:-right-20 bg-black/80 backdrop-blur-xl border border-red-500/50 p-6 rounded-2xl w-56 shadow-2xl opacity-0 group-hover:opacity-100 transition duration-300 translate-x-4 group-hover:translate-x-0">
                    <h3 class="text-red-500 font-black text-3xl mb-2 uppercase italic tracking-tighter" id="mob-name">RAICER</h3>
                    <div class="space-y-3 text-xs font-bold text-gray-400">
                        <div class="flex justify-between border-b border-white/10 pb-1"><span>‚öî T·∫•n C√¥ng:</span> <span class="text-white" id="mob-atk">200</span></div>
                        <div class="flex justify-between border-b border-white/10 pb-1"><span>‚ô• M√°u:</span> <span class="text-white" id="mob-hp">900</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-30 flex gap-4">
            <button onclick="navShop(-1)" class="px-6 py-3 bg-white/5 hover:bg-white/20 border border-white/20 rounded-xl font-bold text-xs uppercase tracking-widest text-gray-300 hover:text-white transition flex items-center gap-2">‚óÄ L√πi</button>
            <button onclick="navShop(1)" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 shadow-lg shadow-indigo-500/50 rounded-xl font-bold text-xs uppercase tracking-widest text-white transition flex items-center gap-2">Ti·∫øp ‚ñ∂</button>
        </div>
    </div>
</div>

<div id="inv-modal" class="full-modal hidden fixed inset-0 z-[3000] bg-black/90 flex items-center justify-center p-4">
    <div class="relative w-full max-w-5xl aspect-video bg-[#1a1a1a] rounded-3xl overflow-hidden shadow-2xl border border-white/10">
        <button onclick="closeInventory()" class="absolute top-6 right-6 z-50 text-white hover:text-red-500 font-black text-xl bg-black/60 w-12 h-12 rounded-full flex items-center justify-center border border-white/20">‚úï</button>
        <div class="absolute inset-0 flex flex-col p-10 z-10">
            <div class="flex-1 flex justify-between items-center px-10">
                <div class="relative w-96 h-96 flex items-center justify-center mx-auto">
                    <div id="inv-mob-container" class="w-full h-full"></div>
                </div>
            </div>
            <div class="h-32 mt-4 bg-black/40 rounded-xl border border-white/10 p-4">
                <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">T√∫i ƒê·ªì</h4>
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<nav>
    <button onclick="switchTab('home')" class="nav-btn active" id="n-home">S·∫£nh</button>
    <button onclick="switchTab('memo')" class="nav-btn" id="n-memo">Ghi Nh·ªõ</button>
    <button onclick="switchTab('test')" class="nav-btn" id="n-test">Ki·ªÉm Tra</button>
    <button onclick="switchTab('work')" class="nav-btn" id="n-work">L·ªãch L√†m</button>
    <button onclick="switchTab('vocab')" class="nav-btn" id="n-vocab">H·ªçc T·ª´</button>
    <button onclick="switchTab('reading')" class="nav-btn" id="n-reading">ƒê·ªçc Hi·ªÉu</button>
    <button onclick="switchTab('speaking')" class="nav-btn" id="n-speaking">N√≥i</button>
    <button onclick="switchTab('music')" class="nav-btn" id="n-music">Nh·∫°c</button>
</nav>

<div id="home" class="tab-content active">
    <div class="h-screen flex flex-col items-center justify-center relative">
        <div class="absolute top-24 left-10 cursor-pointer transition hover:scale-110 active:scale-95 group z-20" onclick="openShop()">
            <div class="w-32 h-32 relative">
                <model-viewer src="./shop.glb" alt="My Shop" auto-rotate camera-controls shadow-intensity="1" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                <div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black px-3 py-1 rounded-full font-black text-[9px] uppercase tracking-widest opacity-0 group-hover:opacity-100 transition whitespace-nowrap shadow-lg border-2 border-white">C·ª≠a H√†ng</div>
            </div>
        </div>

        <div class="glass-card p-12 text-center max-w-md mx-4 z-10">
            <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SKYREIGN</h1>
            <p class="text-xs tracking-[0.5em] text-gray-400 uppercase mb-10">L∆∞u Thi·∫øt Hoa ‚Ä¢ V30.0 Ultimate</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('memo')" class="py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs uppercase tracking-widest transition">√în Ng·ªØ Ph√°p</button>
                <button onclick="switchTab('test')" class="py-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-bold text-xs uppercase tracking-widest transition shadow-lg shadow-indigo-500/30">Ki·ªÉm Tra AI</button>
            </div>
        </div>
    </div>
</div>

<div id="memo" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20 pb-20">
        <div class="glass-card p-8 w-full max-w-4xl mx-4 h-[80vh] overflow-y-auto">
            <h2 class="text-3xl font-black uppercase text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-green-400">Danh S√°ch Ng·ªØ Ph√°p</h2>
            <div id="grammar-list" class="space-y-6">
                </div>
        </div>
    </div>
</div>

<div id="test" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20 pb-20">
        <div class="glass-card p-8 w-full max-w-3xl mx-4 relative min-h-[500px] flex flex-col">
            <div class="flex justify-center gap-4 mb-8">
                <button onclick="setTestMode('analyze')" class="px-4 py-2 bg-indigo-600 rounded-full text-[10px] font-bold uppercase hover:bg-indigo-500">Ph√¢n T√≠ch & ƒê·∫∑t C√¢u</button>
                <button onclick="setTestMode('fill')" class="px-4 py-2 bg-pink-600 rounded-full text-[10px] font-bold uppercase hover:bg-pink-500">ƒêi·ªÅn T·ª´ (H·ªôi tho·∫°i)</button>
            </div>

            <div id="test-analyze" class="hidden flex-1">
                <div class="text-center mb-6">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-2">C√¢u H·ªèi AI:</p>
                    <h3 id="ta-question" class="text-4xl font-black text-white mb-2">...</h3>
                    <p id="ta-status" class="text-xs font-bold text-yellow-500 h-4"></p>
                </div>
                
                <div id="ta-step1" class="space-y-4">
                    <p class="text-sm text-center">H√£y cho bi·∫øt c√¢u tr√™n thu·ªôc ng·ªØ ph√°p n√†o?</p>
                    <div class="grid grid-cols-1 gap-2" id="ta-options"></div>
                </div>

                <div id="ta-step2" class="hidden space-y-4">
                    <p class="text-sm text-center">AI: Ch√≠nh x√°c! Gi·ªù h√£y x√°c ƒë·ªãnh th√†nh ph·∫ßn:</p>
                    <div class="space-y-2">
                        <p class="text-xs text-indigo-300">Ch·ªß ng·ªØ (S) l√† g√¨?</p>
                        <input type="text" id="ta-sub-input" class="w-full bg-white/5 border border-white/20 rounded-lg p-3 outline-none focus:border-indigo-500">
                        <p class="text-xs text-indigo-300">Danh t·ª´ (N) l√† g√¨?</p>
                        <input type="text" id="ta-noun-input" class="w-full bg-white/5 border border-white/20 rounded-lg p-3 outline-none focus:border-indigo-500">
                        <button onclick="checkComponents()" class="w-full py-3 bg-white text-black font-bold uppercase rounded-lg hover:bg-indigo-400 hover:text-white transition">Ki·ªÉm Tra</button>
                    </div>
                </div>

                <div id="ta-step3" class="hidden space-y-4 mt-4">
                    <p class="text-sm text-center">Tuy·ªát v·ªùi! Th·ª≠ th√°ch cu·ªëi c√πng:</p>
                    <p class="text-xs text-center text-gray-400">H√£y t·ª± ƒë·∫∑t 1 c√¢u s·ª≠ d·ª•ng c·∫•u tr√∫c ng·ªØ ph√°p n√†y (Nh·∫≠p ch·ªØ H√°n):</p>
                    <input type="text" id="ta-make-sentence" class="w-full bg-white/5 border border-white/20 rounded-lg p-4 text-center text-xl outline-none focus:border-green-500" placeholder="V√≠ d·ª•: ÊàëÊòØ...">
                    <button onclick="checkAISentence()" class="w-full py-3 bg-green-600 text-white font-bold uppercase rounded-lg hover:bg-green-500 transition shadow-lg shadow-green-500/30">AI Ki·ªÉm Tra (+Ti·ªÅn)</button>
                    <div id="ta-ai-feedback" class="text-center text-xs font-bold mt-2"></div>
                </div>
            </div>

            <div id="test-fill" class="hidden flex-1 flex flex-col items-center">
                 <div class="bg-black/30 p-6 rounded-2xl w-full mb-6 border border-white/10">
                    <p id="tf-dialogue" class="text-xl leading-relaxed text-center font-medium"></p>
                 </div>
                 <div id="tf-options" class="flex flex-wrap gap-3 justify-center"></div>
                 <p id="tf-msg" class="mt-4 text-xs font-bold uppercase tracking-widest h-6"></p>
                 <button onclick="nextFillTest()" class="mt-auto py-2 px-6 bg-white/10 rounded-full text-[10px] uppercase hover:bg-white/20">ƒê·ªïi ƒëo·∫°n kh√°c</button>
            </div>
        </div>
    </div>
</div>

<div id="work" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20 pb-20">
        <div class="glass-card p-8 w-full max-w-4xl mx-4 min-h-[600px] flex flex-col">
            <h2 class="text-3xl font-black uppercase text-center mb-2 bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-red-400">X·∫øp L·ªãch T·ª± ƒê·ªông</h2>
            
            <div id="work-wizard" class="flex-1 flex flex-col items-center justify-center">
                <div class="w-full max-w-md space-y-6">
                    <div class="text-center">
                        <span class="text-[10px] bg-white/10 px-3 py-1 rounded-full uppercase text-gray-400">B∆∞·ªõc <span id="w-step-num">1</span>/7</span>
                        <h3 class="text-2xl font-bold mt-4 text-indigo-300" id="w-day-title">Th·ª© 2</h3>
                    </div>
                    
                    <div id="w-date-input-container">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Ng√†y (V√≠ d·ª•: 15/10)</label>
                        <input type="text" id="w-date" class="w-full bg-transparent border-b border-white/20 py-2 text-xl outline-none focus:border-indigo-500 text-white" placeholder="Nh·∫≠p ng√†y...">
                    </div>

                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500">V·ªã tr√≠ l√†m</label>
                        <input type="text" id="w-pos" class="w-full bg-transparent border-b border-white/20 py-2 text-xl outline-none focus:border-indigo-500 text-white" placeholder="Donut, N√∫i l·ª≠a, C·ªïng...">
                        <div class="flex gap-2 mt-2">
                             <span onclick="document.getElementById('w-pos').value='Donut'" class="time-chip text-[9px]">Donut</span>
                             <span onclick="document.getElementById('w-pos').value='N√∫i L·ª≠a'" class="time-chip text-[9px]">N√∫i L·ª≠a</span>
                             <span onclick="document.getElementById('w-pos').value='C·ªïng'" class="time-chip text-[9px]">C·ªïng</span>
                             <span onclick="document.getElementById('w-pos').value='OFF'" class="time-chip text-[9px] bg-red-500/20 border-red-500/50">NGH·ªà</span>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500">Ca l√†m vi·ªác</label>
                        <input type="text" id="w-time" class="w-full bg-transparent border-b border-white/20 py-2 text-xl outline-none focus:border-indigo-500 text-white" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p...">
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span onclick="document.getElementById('w-time').value='15h30-22h30'" class="time-chip">15h30-22h30</span>
                            <span onclick="document.getElementById('w-time').value='18h00-22h30'" class="time-chip">18h00-22h30</span>
                            <span onclick="document.getElementById('w-time').value='08h30-15h30'" class="time-chip">08h30-15h30</span>
                        </div>
                    </div>

                    <button onclick="nextWorkStep()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-bold uppercase tracking-widest shadow-lg transform active:scale-95 transition">Ti·∫øp Theo ‚ûî</button>
                </div>
            </div>

            <div id="work-result" class="hidden flex-1 flex flex-col">
                <div class="overflow-x-auto">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>Th·ª©</th>
                                <th>Ng√†y</th>
                                <th>V·ªã Tr√≠</th>
                                <th>Gi·ªù L√†m</th>
                                <th>T·ªïng Gi·ªù</th>
                            </tr>
                        </thead>
                        <tbody id="work-tbody"></tbody>
                    </table>
                </div>
                <div class="mt-auto pt-6 flex gap-4 justify-center">
                    <button onclick="resetWorkSchedule()" class="px-6 py-3 bg-gray-700 rounded-lg text-xs font-bold uppercase">L√†m L·∫°i</button>
                    <button onclick="window.print()" class="px-6 py-3 bg-white text-black rounded-lg text-xs font-bold uppercase">In L·ªãch</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="vocab" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-lg mx-4 relative" id="vocab-card">
            <div class="flex justify-between items-center mb-8">
                <button onclick="changeVocabMode()" id="v-mode-btn" class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition">Mode: H√°n ‚ûî Vi·ªát</button>
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">HSK 1 FULL</div>
            </div>
            <div id="v-question" class="text-7xl font-black text-center mb-8 tracking-tighter min-h-[100px] flex items-center justify-center">?</div>
            <input type="text" id="v-input" placeholder="Nh·∫≠p ƒë√°p √°n..." class="w-full bg-transparent border-b-2 border-white/20 py-3 text-center font-bold text-2xl outline-none focus:border-indigo-500 transition text-white placeholder-gray-600 mb-8" autocomplete="off">
            <button onclick="checkVocab()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-gray-200 transition mb-4">Ki·ªÉm Tra</button>
            <div id="v-feedback" class="text-center h-10">
                <p id="v-msg" class="text-[11px] font-bold uppercase tracking-widest"></p>
                <p id="v-hint" class="text-[12px] font-bold text-red-400 mt-1 uppercase hidden"></p>
            </div>
        </div>
    </div>
</div>

<div id="reading" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-8 w-full max-w-3xl mx-4 relative" id="reading-card">
            <div class="flex justify-between items-center mb-6">
                <div class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest">ƒêo·∫°n VƒÉn Ng·∫´u Nhi√™n</div>
                <div class="flex gap-2">
                    <button id="r-toggle-btn" onclick="toggleReadingRef()" class="text-[10px] font-bold text-green-400 hover:text-white uppercase tracking-widest transition border border-green-500 px-2 py-1 rounded-lg">Xem ƒê√°p √Ån (Vi·ªát)</button>
                    <button onclick="nextParagraph()" class="text-[10px] font-bold text-gray-400 hover:text-white uppercase tracking-widest transition">ƒê·ªïi b√†i kh√°c ‚Üª</button>
                </div>
            </div>
            <div class="bg-black/20 p-6 rounded-2xl mb-6 border border-white/10 h-64 overflow-y-auto">
                <p id="r-text" class="text-xl md:text-2xl font-medium text-gray-100 reading-text">Loading...</p>
            </div>
            <p class="text-xs text-gray-400 mb-2 italic">H√£y d·ªãch ƒëo·∫°n vƒÉn tr√™n sang Ti·∫øng Vi·ªát (+1 Coin n·∫øu ƒë√∫ng):</p>
            <textarea id="r-input" rows="4" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white placeholder-gray-600 outline-none focus:border-indigo-500 transition mb-6" placeholder="G√µ b·∫£n d·ªãch c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            <button onclick="checkReading()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-indigo-400 hover:text-white transition mb-4 shadow-lg">Ki·ªÉm Tra B·∫£n D·ªãch</button>
            <div id="r-feedback" class="text-center min-h-[40px]">
                <p id="r-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></p>
            </div>
        </div>
    </div>
</div>

<div id="speaking" class="tab-content">
    <div class="min-h-screen flex items-center justify-center pt-20">
        <div class="glass-card p-10 w-full max-w-md mx-4 text-center relative overflow-hidden" id="speak-card">
            <div class="text-[10px] uppercase tracking-widest text-indigo-400 font-black mb-8">V18.0 - Fast Catch</div>
            <div class="mb-8 relative group">
                <div id="s-hz" class="text-9xl font-black mb-2 tracking-tighter cursor-pointer transition hover:text-indigo-400" onclick="speakText(document.getElementById('s-hz').innerText)">Êàë</div>
                <div id="s-py" class="text-2xl text-gray-500 mb-1">w«í</div>
                <div id="s-mn" class="text-xs font-bold bg-white/10 px-3 py-1 rounded-full inline-block">T√îI</div>
            </div>
            <div class="flex justify-center items-center gap-6 mb-8">
                <button onclick="changeSpeakWord(-1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">‚Üê</button>
                <div class="relative">
                    <div id="mic-ring" class="hidden mic-ripple"></div>
                    <button id="mic-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl relative z-10 transition hover:scale-110 active:scale-90 text-white">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    </button>
                </div>
                <button onclick="changeSpeakWord(1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">‚Üí</button>
            </div>
            <div id="s-feedback" class="text-[11px] font-bold uppercase tracking-widest text-gray-400 h-16 flex flex-col items-center justify-center px-4">
                <span id="s-status">B·∫•m mic v√† n√≥i ngay</span>
            </div>
            <div id="s-live-text" class="absolute bottom-1 w-full text-center text-[9px] text-indigo-300/50 uppercase tracking-widest"></div>
            <div id="progress-bar"></div>
        </div>
    </div>
</div>

<div id="music" class="tab-content">
    <div class="min-h-screen flex flex-col items-center justify-center pt-20 pb-20">
        <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-6xl px-4">
            <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto">
                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-indigo-400 border-b border-white/10 pb-2">V-Pop Hits</h3>
                <div id="v-list" class="space-y-2"></div>
            </div>
            <div class="w-full max-w-md flex flex-col items-center">
                <h4 class="text-4xl font-black text-white tracking-tighter uppercase mb-4 drop-shadow-lg">Music Pod</h4>
                <div class="relative w-full h-[300px]">
                     <model-viewer src="./airpods.glb" alt="My Airpods" auto-rotate camera-controls shadow-intensity="1" exposure="0.8" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                </div>
                <div class="w-full aspect-video bg-black rounded-2xl overflow-hidden border-2 border-white/20 shadow-2xl mt-[-40px] relative z-10">
                    <div id="player"></div> 
                    <video id="mp4-player" controls playsinline class="hidden w-full h-full object-cover"></video>
                </div>
            </div>
            <div class="glass-card p-6 w-full md:w-72 h-96 overflow-y-auto">
                <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-pink-400 border-b border-white/10 pb-2">Chinese Hits</h3>
                <div id="c-list" class="space-y-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CORE & DATA ---
    let userCoins = parseInt(localStorage.getItem('skyCoins')) || 0;
    let myMobs = JSON.parse(localStorage.getItem('skyMobs')) || [];
    const coinDisplay = document.getElementById('coin-display');
    const coinSfx = document.getElementById('sfx-coin');
    const clickSfx = document.getElementById('sfx-click');
    const typeSfx = document.getElementById('sfx-type');
    coinDisplay.innerText = userCoins;

    function updateCoins(amount) {
        userCoins += amount;
        localStorage.setItem('skyCoins', userCoins);
        coinDisplay.innerText = userCoins;
        coinDisplay.classList.remove('coin-pop-green', 'coin-pop-red');
        void coinDisplay.offsetWidth;
        if(amount > 0) { coinDisplay.classList.add('coin-pop-green'); coinSfx.currentTime = 0; coinSfx.play().catch(e=>{}); } 
        else { coinDisplay.classList.add('coin-pop-red'); }
    }

    const vocabData = [
        { hz: "Êàë", py: "w«í", mn: "t√¥i" }, { hz: "‰Ω†", py: "n«ê", mn: "b·∫°n" }, { hz: "‰ªñ", py: "tƒÅ", mn: "anh ·∫•y" }, { hz: "Â•π", py: "tƒÅ", mn: "c√¥ ·∫•y" }, { hz: "Êàë‰ª¨", py: "w«ímen", mn: "ch√∫ng t√¥i" }, { hz: "Ë∞Å", py: "sh√©i", mn: "ai" },
        { hz: "Áà∏Áà∏", py: "b√†ba", mn: "b·ªë" }, { hz: "Â¶àÂ¶à", py: "mƒÅma", mn: "m·∫π" }, { hz: "ËÄÅÂ∏à", py: "l«éoshƒ´", mn: "th·∫ßy gi√°o" }, { hz: "Â≠¶Áîü", py: "xu√©sheng", mn: "h·ªçc sinh" }, { hz: "‰∫∫", py: "r√©n", mn: "ng∆∞·ªùi" },
        { hz: "ÊòØ", py: "sh√¨", mn: "l√†" }, { hz: "‰∏ç", py: "b√π", mn: "kh√¥ng" }, { hz: "Âêó", py: "ma", mn: "kh√¥ng (h·ªèi)" },
        { hz: "ÊúãÂèã", py: "p√©ngyou", mn: "b·∫°n b√®" }, { hz: "ÂåªÁîü", py: "yƒ´shƒìng", mn: "b√°c sƒ©" }, { hz: "ËÄÅÊùø", py: "l«éob«én", mn: "√¥ng ch·ªß" }, { hz: "Â∑•‰∫∫", py: "g≈çngr√©n", mn: "c√¥ng nh√¢n" },
        { hz: "Áå´", py: "mƒÅo", mn: "m√®o" }, { hz: "Áãó", py: "g«íu", mn: "ch√≥" },
        { hz: "ÂñúÊ¨¢", py: "x«êhuan", mn: "th√≠ch" }, { hz: "Áà±", py: "√†i", mn: "y√™u" }, { hz: "ÂêÉ", py: "chƒ´", mn: "ƒÉn" }, { hz: "Âñù", py: "hƒì", mn: "u·ªëng" }, { hz: "Âéª", py: "q√π", mn: "ƒëi" }
    ];

    // --- NEW FEATURE 1: MEMORIZE (GRAMMAR) ---
    const grammarRules = [
        { id: "g1", title: "S + ÊòØ + N (Kh·∫≥ng ƒë·ªãnh)", structure: "Ch·ªß ng·ªØ + ÊòØ + Danh t·ª´", desc: "D√πng ƒë·ªÉ gi·ªõi thi·ªáu, ƒë·ªãnh nghƒ©a. (S l√† N)", regex: /(.+)ÊòØ(.+)/ },
        { id: "g2", title: "S + ‰∏ç + ÊòØ + N (Ph·ªß ƒë·ªãnh)", structure: "Ch·ªß ng·ªØ + ‰∏ç + ÊòØ + Danh t·ª´", desc: "Ph·ªß ƒë·ªãnh c·ªßa ch·ªØ L√†. (S kh√¥ng ph·∫£i l√† N)", regex: /(.+)‰∏çÊòØ(.+)/ },
        { id: "g3", title: "S + ÊòØ + N + Âêó? (Nghi v·∫•n)", structure: "Ch·ªß ng·ªØ + ÊòØ + Danh t·ª´ + Âêó?", desc: "C√¢u h·ªèi Yes/No. (S l√† N c√≥ ph·∫£i kh√¥ng?)", regex: /(.+)ÊòØ(.+)Âêó[?Ôºü]?/ },
        { id: "g4", title: "ƒê·∫°i t·ª´/Danh t·ª´ + ‰ª¨ (S·ªë nhi·ªÅu)", structure: "N + ‰ª¨", desc: "Bi·∫øn danh t·ª´ ch·ªâ ng∆∞·ªùi th√†nh s·ªë nhi·ªÅu. VD: Êàë‰ª¨ (Ch√∫ng t√¥i), ËÄÅÂ∏à‰ª¨ (C√°c th·∫ßy c√¥).", regex: /(.+)‰ª¨/ }
    ];

    function renderGrammarList() {
        const list = document.getElementById('grammar-list');
        list.innerHTML = grammarRules.map(rule => {
            // Auto generate example
            let ex = "";
            if(rule.id === "g1") ex = "ÊàëÊòØÂ≠¶Áîü (T√¥i l√† h·ªçc sinh)";
            if(rule.id === "g2") ex = "Êàë‰∏çÊòØËÄÅÂ∏à (T√¥i kh√¥ng ph·∫£i gi√°o vi√™n)";
            if(rule.id === "g3") ex = "‰Ω†ÊòØ‰∏≠ÂõΩ‰∫∫ÂêóÔºü (B·∫°n l√† ng∆∞·ªùi TQ ph·∫£i kh√¥ng?)";
            if(rule.id === "g4") ex = "Êàë‰ª¨ (Ch√∫ng t√¥i), ÊúãÂèã‰ª¨ (C√°c b·∫°n)";
            
            return `
            <div class="bg-black/30 p-6 rounded-2xl border border-white/10 hover:border-indigo-500 transition">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold text-indigo-400">${rule.title}</h3>
                    <button class="text-[10px] bg-white/10 px-2 py-1 rounded" onclick="speakText('${ex.split('(')[0]}')">üîä Nghe</button>
                </div>
                <div class="text-lg font-mono text-pink-400 mb-2 bg-black/40 p-2 rounded inline-block">${rule.structure}</div>
                <p class="text-sm text-gray-300 mb-4">${rule.desc}</p>
                <div class="text-sm text-green-400 italic border-l-2 border-green-500 pl-3">V√≠ d·ª• t·ª± ƒë·ªông: ${ex}</div>
            </div>`;
        }).join('');
    }

    // --- NEW FEATURE 2: TEST (AI ANALYZE) ---
    let currentTestMode = '';
    let currentAnalyzeRule = null;
    let currentAnalyzeSentence = "";
    
    function setTestMode(mode) {
        document.getElementById('test-analyze').classList.add('hidden');
        document.getElementById('test-fill').classList.add('hidden');
        currentTestMode = mode;
        if(mode === 'analyze') {
            document.getElementById('test-analyze').classList.remove('hidden');
            startAnalyzeTest();
        } else {
            document.getElementById('test-fill').classList.remove('hidden');
            nextFillTest();
        }
    }

    function startAnalyzeTest() {
        // Pick random rule from g1, g2, g3
        const targetRules = grammarRules.slice(0,3);
        currentAnalyzeRule = targetRules[Math.floor(Math.random() * targetRules.length)];
        
        // Generate sentence based on rule
        const subjects = ["Êàë", "‰Ω†", "‰ªñ", "Áà∏Áà∏", "Â¶àÂ¶à"];
        const nouns = ["Â≠¶Áîü", "ËÄÅÂ∏à", "ÂåªÁîü", "Â∑•‰∫∫", "ÊúãÂèã"];
        const S = subjects[Math.floor(Math.random() * subjects.length)];
        const N = nouns[Math.floor(Math.random() * nouns.length)];
        
        if(currentAnalyzeRule.id === "g1") currentAnalyzeSentence = `${S}ÊòØ${N}`;
        if(currentAnalyzeRule.id === "g2") currentAnalyzeSentence = `${S}‰∏çÊòØ${N}`;
        if(currentAnalyzeRule.id === "g3") currentAnalyzeSentence = `${S}ÊòØ${N}ÂêóÔºü`;

        document.getElementById('ta-question').innerText = currentAnalyzeSentence;
        document.getElementById('ta-status').innerText = "";
        document.getElementById('ta-step1').classList.remove('hidden');
        document.getElementById('ta-step2').classList.add('hidden');
        document.getElementById('ta-step3').classList.add('hidden');
        document.getElementById('ta-make-sentence').value = "";
        document.getElementById('ta-sub-input').value = "";
        document.getElementById('ta-noun-input').value = "";
        document.getElementById('ta-ai-feedback').innerText = "";
        
        // Render Options
        const opts = targetRules.map(r => `<button onclick="checkRule('${r.id}')" class="p-3 bg-white/10 hover:bg-indigo-600 rounded-lg text-left text-xs font-bold uppercase transition border border-white/10">${r.structure}</button>`).join('');
        document.getElementById('ta-options').innerHTML = opts;
    }

    function checkRule(id) {
        if(id === currentAnalyzeRule.id) {
            updateCoins(1);
            document.getElementById('ta-status').innerText = "CH√çNH X√ÅC! (+1 COIN)";
            setTimeout(() => {
                document.getElementById('ta-step1').classList.add('hidden');
                document.getElementById('ta-step2').classList.remove('hidden');
            }, 1000);
        } else {
            updateCoins(-1);
            document.getElementById('ta-status').innerText = "SAI R·ªíI! TH·ª¨ L·∫†I (-1 COIN)";
        }
    }

    function checkComponents() {
        const sVal = document.getElementById('ta-sub-input').value.trim();
        const nVal = document.getElementById('ta-noun-input').value.trim();
        
        // Regex extract from current sentence
        const match = currentAnalyzeSentence.match(currentAnalyzeRule.regex);
        let trueS = "", trueN = "";
        if(match) { trueS = match[1]; trueN = match[2]; }

        if(currentAnalyzeSentence.includes(sVal) && currentAnalyzeSentence.includes(nVal) && sVal.length > 0 && nVal.length > 0) {
            // Simplified check: if input exists in sentence and reasonable length
            updateCoins(1);
            document.getElementById('ta-status').innerText = "GI·ªéI QU√Å! (+1 COIN)";
            document.getElementById('ta-step2').classList.add('hidden');
            document.getElementById('ta-step3').classList.remove('hidden');
        } else {
            document.getElementById('ta-status').innerText = "CH∆ØA ƒê√öNG TH√ÄNH PH·∫¶N. H√ÉY NH√åN K·ª∏ C√ÇU.";
        }
    }

    function checkAISentence() {
        const input = document.getElementById('ta-make-sentence').value.trim();
        const feedback = document.getElementById('ta-ai-feedback');
        
        // AI Logic Check
        const match = input.match(currentAnalyzeRule.regex);
        // Check if contains chinese characters
        const isChinese = /[\u4e00-\u9fa5]/.test(input);

        if(match && isChinese) {
            updateCoins(10); // Big reward
            feedback.innerText = "AI VERIFIED: C·∫§U TR√öC CHU·∫®N X√ÅC! (+10 COINS)";
            feedback.style.color = "#4ade80";
            clickSfx.play().catch(()=>{});
            setTimeout(startAnalyzeTest, 2000);
        } else {
            feedback.innerText = "AI REJECT: SAI C·∫§U TR√öC HO·∫∂C KH√îNG PH·∫¢I TI·∫æNG TRUNG.";
            feedback.style.color = "#f87171";
        }
    }

    // --- NEW FEATURE 2b: FILL BLANK ---
    const dialogues = [
        { text: "‰Ω†Â•ΩÔºÅÊàëÂè´L∆∞u Thi·∫øt Hoa. ÊàëÊòØÂ≠¶Áîü„ÄÇ", hiddenIdx: [3, 5] }, // Hoa, Student
        { text: "‰Ω†ÂéªÂì™ÂÑøÔºüÊàëÂéªÂ≠¶Ê†°ÁúãËÄÅÂ∏à„ÄÇ", hiddenIdx: [2, 5] }, // Where, School
        { text: "Ëøô‰∏™Â§öÂ∞ëÈí±ÔºüÂ§™Ë¥µ‰∫ÜÔºÅ", hiddenIdx: [2, 4] }, // How much, Expensive
        { text: "‰Ω†ÊòØ‰∏≠ÂõΩ‰∫∫ÂêóÔºü‰∏çÊòØÔºåÊàëÊòØË∂äÂçó‰∫∫„ÄÇ", hiddenIdx: [2, 7] } // Chinese, Vietnamese
    ];
    let curFill = null;

    function nextFillTest() {
        const d = dialogues[Math.floor(Math.random() * dialogues.length)];
        curFill = d;
        const words = Array.from(d.text);
        let html = "";
        let hiddenChars = [];
        
        // Simple logic: hide randomly roughly based on spaces if it were pinyin, but here chars
        // We use predefined hidden indices logic or simple regex
        // Let's hide specific words found in our vocab
        
        let displayStr = d.text;
        // Simple mock "Fill in" logic:
        // Pick a substring to hide
        const target = ["Êàë", "‰Ω†", "Â≠¶Áîü", "ËÄÅÂ∏à", "Èí±", "Âéª", "Â•Ω", "Âêó"].filter(w => d.text.includes(w));
        const hiddenWord = target[Math.floor(Math.random() * target.length)] || "Êàë";
        
        displayStr = displayStr.replace(hiddenWord, "_____");
        
        document.getElementById('tf-dialogue').innerText = displayStr;
        document.getElementById('tf-msg').innerText = "";
        
        // Options
        const opts = [hiddenWord, "‰ªÄ‰πà", "Âõ†‰∏∫", "Áà∏Áà∏"].sort(() => Math.random() - 0.5);
        document.getElementById('tf-options').innerHTML = opts.map(o => 
            `<button onclick="checkFill('${o}', '${hiddenWord}')" class="px-4 py-2 bg-white/10 hover:bg-white/30 border border-white/20 rounded-lg font-bold">${o}</button>`
        ).join('');
    }

    function checkFill(ans, correct) {
        const msg = document.getElementById('tf-msg');
        if(ans === correct) {
            updateCoins(1);
            msg.innerText = "CH√çNH X√ÅC! (+1 COIN)";
            msg.style.color = "#4ade80";
            document.getElementById('tf-dialogue').innerText = document.getElementById('tf-dialogue').innerText.replace("_____", correct);
            setTimeout(nextFillTest, 1500);
        } else {
            updateCoins(-1);
            msg.innerText = "SAI R·ªíI!";
            msg.style.color = "#f87171";
        }
    }

    // --- NEW FEATURE 3: WORK SCHEDULE ---
    const workDays = ["Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7", "Ch·ªß Nh·∫≠t"];
    let workStep = 0;
    let scheduleData = [];

    function resetWorkSchedule() {
        workStep = 0;
        scheduleData = [];
        document.getElementById('work-wizard').classList.remove('hidden');
        document.getElementById('work-result').classList.add('hidden');
        document.getElementById('w-date').value = ""; // Clear inputs
        document.getElementById('w-pos').value = "";
        document.getElementById('w-time').value = "";
        updateWizardUI();
    }

    function updateWizardUI() {
        document.getElementById('w-day-title').innerText = workDays[workStep];
        document.getElementById('w-step-num').innerText = workStep + 1;
        
        // Auto Date Logic
        if(workStep > 0 && scheduleData.length > 0) {
            const prevDate = scheduleData[workStep-1].date;
            // Try to parse DD/MM
            const parts = prevDate.split('/');
            if(parts.length === 2) {
                let d = parseInt(parts[0]);
                let m = parseInt(parts[1]);
                // Simple increment (ignoring max days in month for simplicity in v1)
                d++; 
                if(d > 31) { d = 1; m++; }
                document.getElementById('w-date').value = `${d}/${m}`;
                document.getElementById('w-date-input-container').classList.add('opacity-50'); // Dim it to show auto
            }
        } else {
            document.getElementById('w-date-input-container').classList.remove('opacity-50');
        }
    }

    function nextWorkStep() {
        const date = document.getElementById('w-date').value || "N/A";
        const pos = document.getElementById('w-pos').value || "N/A";
        const time = document.getElementById('w-time').value || "N/A";

        scheduleData.push({ day: workDays[workStep], date, pos, time });
        
        workStep++;
        if(workStep >= 7) {
            renderScheduleResult();
        } else {
            // Clear inputs for next step except date (which is auto)
            document.getElementById('w-pos').value = "";
            document.getElementById('w-time').value = "";
            updateWizardUI();
        }
    }

    function renderScheduleResult() {
        document.getElementById('work-wizard').classList.add('hidden');
        document.getElementById('work-result').classList.remove('hidden');
        
        const tbody = document.getElementById('work-tbody');
        tbody.innerHTML = scheduleData.map(d => {
            // Calc hours roughly
            let duration = 0;
            if(d.time.includes('-')) {
                const times = d.time.replace(/h/g, '.').split('-');
                if(times.length === 2) duration = parseFloat(times[1]) - parseFloat(times[0]);
            }
            return `
            <tr class="${d.pos === 'OFF' ? 'bg-red-500/10' : ''}">
                <td class="font-bold text-indigo-300">${d.day}</td>
                <td>${d.date}</td>
                <td class="font-bold text-white uppercase">${d.pos}</td>
                <td>${d.time}</td>
                <td>${d.pos === 'OFF' ? '-' : (duration > 0 ? duration.toFixed(1) + 'h' : '?')}</td>
            </tr>`;
        }).join('');
    }

    // --- STANDARD LOGIC (Inventory, Shop, Tabs) ---
    const mobs = [ { id: "mob1", model: "./mob1.glb", name: "RAICER", atk: 200, hp: 900, price: 100 } ];
    let shopIdx = 0;
    function openShop() { clickSfx.currentTime = 0; clickSfx.play().catch(e=>{}); document.getElementById('shop-modal').classList.remove('hidden'); setTimeout(() => typeWriter("H√£y mua nh·ªØng g√¨ b·∫°n mu·ªën...", "npc-text"), 500); loadMob(0); }
    function closeShop() { document.getElementById('shop-modal').classList.add('hidden'); }
    function loadMob(idx) { if(idx < 0 || idx >= mobs.length) { alert("H√£y ƒë·ª£i c·∫≠p nh·∫≠t th√™m qu√°i m·ªõi!"); return; } shopIdx = idx; const m = mobs[shopIdx]; document.getElementById('shop-mob-viewer').src = m.model; document.getElementById('mob-name').innerText = m.name; document.getElementById('mob-atk').innerText = m.atk; document.getElementById('mob-hp').innerText = m.hp; }
    function navShop(dir) { loadMob(shopIdx + dir); }
    function buyItem() { const m = mobs[shopIdx]; if(myMobs.includes(m.id)) { alert("B·∫°n ƒë√£ s·ªü h·ªØu qu√°i v·∫≠t n√†y r·ªìi!"); return; } if(userCoins >= m.price) { updateCoins(-m.price); myMobs.push(m.id); localStorage.setItem('skyMobs', JSON.stringify(myMobs)); alert("Mua th√†nh c√¥ng!"); } else { alert("Ch∆∞a ƒë·ªß ti·ªÅn!"); } }
    function openInventory() { clickSfx.currentTime = 0; clickSfx.play().catch(e=>{}); document.getElementById('inv-modal').classList.remove('hidden'); if(myMobs.includes('mob1')) document.getElementById('inv-mob-container').innerHTML = `<model-viewer src="./mob1.glb" auto-rotate camera-controls disable-zoom style="width: 100%; height: 100%"></model-viewer>`; else document.getElementById('inv-mob-container').innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">Tr·ªëng r·ªóng...</div>`; }
    function closeInventory() { document.getElementById('inv-modal').classList.add('hidden'); }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-' + id).classList.add('active');
        if(id === 'memo') renderGrammarList();
        if(id === 'work') resetWorkSchedule();
    }

    function typeWriter(text, elementId) { const el = document.getElementById(elementId); el.innerText = ""; let i = 0; function typing() { if (i < text.length) { el.textContent += text.charAt(i); i++; setTimeout(typing, 50); } } typing(); }
    
    // SPEAK & MUSIC (Legacy)
    function speakText(text) { window.speechSynthesis.cancel(); const msg = new SpeechSynthesisUtterance(text); msg.lang = 'zh-CN'; window.speechSynthesis.speak(msg); }
    const readingData = [
        { zh: "‰Ω†Â•ΩÔºÅÊàëÂè´L∆∞u Thi·∫øt Hoa. ÊàëÊòØÂ≠¶Áîü„ÄÇ", vi_display: "Xin ch√†o! T√¥i t√™n L∆∞u Thi·∫øt Hoa. T√¥i l√† h·ªçc sinh." },
        { zh: "‰ªäÂ§©ÊòüÊúüÂÖ≠„ÄÇÁé∞Âú®‰∏äÂçà‰πùÁÇπÔºåÊàëÂú®ÂÆ∂Áúã‰π¶„ÄÇ", vi_display: "H√¥m nay l√† th·ª© b·∫£y. B√¢y gi·ªù l√† 9 gi·ªù s√°ng, t√¥i ·ªü nh√† ƒë·ªçc s√°ch." }
    ];
    let rIdx = 0;
    function nextParagraph() { rIdx = (rIdx + 1) % readingData.length; document.getElementById('r-text').innerText = readingData[rIdx].zh; document.getElementById('r-msg').innerText = ""; document.getElementById('r-input').value = ""; }
    function checkReading() { const input = document.getElementById('r-input').value.toLowerCase(); if(input.length > 10) { updateCoins(1); document.getElementById('r-msg').innerText = "R·∫§T T·ªêT! (+1 COIN)"; document.getElementById('r-msg').style.color = "#4ade80"; } else { document.getElementById('r-msg').innerText = "H√ÉY VI·∫æT D√ÄI H∆†N..."; } }
    function toggleReadingRef() { document.getElementById('r-text').innerText = readingData[rIdx].vi_display; }

    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player; function onYouTubeIframeAPIReady() { player = new YT.Player('player', { height: '100%', width: '100%', videoId: '' }); }
    function playMedia(source, type) { const ytDiv = document.getElementById('player'); const mp4Div = document.getElementById('mp4-player'); if(player && player.stopVideo) player.stopVideo(); mp4Div.pause(); if (type === 'mp4') { ytDiv.style.display = 'none'; mp4Div.style.display = 'block'; mp4Div.src = source; mp4Div.play(); } else { mp4Div.style.display = 'none'; ytDiv.style.display = 'block'; player.loadVideoById(source); } }
    
    // Init
    window.onload = () => { switchTab('home'); renderGrammarList(); };
    function handleGlobalClick(e) { document.getElementById('cursor').style.left = e.clientX + 'px'; document.getElementById('cursor').style.top = e.clientY + 'px'; }
</script>
</body>
</html>
