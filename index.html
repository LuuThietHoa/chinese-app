<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Hub | V44.0 Builder Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* CSS CHUNG */
        :root { --primary: #6366f1; --accent: #f472b6; }
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #312e81, #831843);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff; min-height: 100vh; overflow-x: hidden; cursor: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #cursor { position: fixed; width: 20px; height: 20px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s; }
        
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .glass-card:hover { transform: translateY(-5px); }
        nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 6px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; justify-content: center; width: 90%; max-width: 600px; }
        .nav-btn { padding: 10px 16px; border-radius: 18px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; color: #94a3b8; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.5s forwards; padding-bottom: 120px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* UI GAME & BUILDER */
        #game-container { position: fixed; inset: 0; z-index: 5000; background: #87CEEB; display: none; pointer-events: auto; } /* N·ªÅn xanh tr·ªùi */
        #game-ui { position: absolute; top: 20px; left: 20px; pointer-events: none; }
        
        /* Builder Toolbar */
        #builder-ui { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 5002; }
        .build-btn { background: rgba(0,0,0,0.7); border: 1px solid white; padding: 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .build-btn:hover { background: var(--primary); }
        
        /* Object Selection Panel */
        #obj-panel { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 200px; max-height: 80vh; overflow-y: auto; display: none; z-index: 5003; }
        .model-option { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .model-option:hover { background: rgba(255,255,255,0.1); }
        
        /* Edit Controls */
        #edit-controls { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border-radius: 20px; display: none; gap: 10px; z-index: 5004; }
        .ctrl-btn { width: 40px; height: 40px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
        .ctrl-btn:hover { background: var(--primary); }
        
        .full-modal { transition: opacity 0.3s ease; }
        .full-modal.hidden { display: none; }
        .inv-slot { width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="cursor"></div>

<audio id="sfx-coin" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
<audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-click-900.mp3"></audio>

<div class="fixed top-32 right-6 z-[2000] cursor-pointer transition hover:scale-110 active:scale-95 group flex flex-col items-center" onclick="enterGameWorld()">
    <div class="w-16 h-16 bg-indigo-900/80 rounded-full border-2 border-indigo-400 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <span class="text-3xl">üè∞</span>
    </div>
    <div class="bg-indigo-600 text-white px-2 py-1 rounded text-[8px] font-bold uppercase mt-1">V√†o Th·∫ø Gi·ªõi</div>
</div>

<div id="game-container">
    <div id="game-ui">
        <h2 class="text-xl font-black uppercase text-white drop-shadow-md">Skyreign World</h2>
        <div class="mt-2 text-xs text-white">
            <p>WASD: Di chuy·ªÉn | Shift: Ch·∫°y</p>
            <p>Click chu·ªôt tr√°i: Ch·ªçn ƒë·ªì v·∫≠t ƒë·ªÉ s·ª≠a</p>
        </div>
    </div>

    <div id="edit-controls">
        <div class="ctrl-btn" onclick="modifySelected('scale', 0.1)">+</div>
        <div class="ctrl-btn" onclick="modifySelected('scale', -0.1)">-</div>
        <div class="ctrl-btn" onclick="modifySelected('rotate', 0.2)">‚Üª</div>
        <div class="ctrl-btn" onclick="modifySelected('delete', 0)" style="background:#ef4444;">‚úï</div>
        <div class="ctrl-btn" onclick="deselectObject()" style="background:#666;">OK</div>
    </div>

    <div id="builder-ui">
        <button class="build-btn text-xs font-bold uppercase" onclick="toggleObjPanel()">üì¶ Kho ƒê·ªì (Th√™m Model)</button>
        <button class="build-btn text-xs font-bold uppercase bg-green-600 border-green-400" onclick="saveWorld()">üíæ L∆∞u Th·∫ø Gi·ªõi</button>
    </div>

    <div id="obj-panel">
        <h3 class="text-xs font-bold uppercase mb-4 text-gray-400 border-b border-white/20 pb-2">Ch·ªçn Model</h3>
        <div id="model-list-content"></div>
        <button onclick="toggleObjPanel()" class="w-full mt-4 py-2 bg-red-600 rounded text-xs font-bold">ƒê√≥ng</button>
    </div>

    <button onclick="exitGameWorld()" class="absolute top-6 right-6 z-[5002] text-white hover:text-red-500 font-black text-xl bg-black/40 w-12 h-12 rounded-full flex items-center justify-center border border-white/20">‚úï</button>
</div>

<div id="inv-modal" class="full-modal hidden fixed inset-0 z-[3000] bg-black/90 flex items-center justify-center p-4">
    <button onclick="document.getElementById('inv-modal').classList.add('hidden')" class="absolute top-10 right-10 text-white text-2xl">‚úï</button>
    <div class="text-white">Inventory Placeholder (Code c≈© v·∫´n ch·∫°y ng·∫ßm)</div>
</div>

<nav>
    <button onclick="switchTab('home')" class="nav-btn active" id="n-home">S·∫£nh</button>
    <button onclick="switchTab('vocab')" class="nav-btn" id="n-vocab">H·ªçc T·ª´</button>
    <button onclick="switchTab('reading')" class="nav-btn" id="n-reading">ƒê·ªçc Hi·ªÉu</button>
    <button onclick="switchTab('speaking')" class="nav-btn" id="n-speaking">Luy·ªán N√≥i</button>
    <button onclick="switchTab('grammar')" class="nav-btn" id="n-grammar">Ng·ªØ Ph√°p</button>
    <button onclick="switchTab('music')" class="nav-btn" id="n-music">Nh·∫°c</button>
</nav>

<div id="home" class="tab-content active">
    <div class="h-screen flex flex-col items-center justify-center relative">
        <div class="glass-card p-12 text-center max-w-md mx-4 z-10">
            <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SKYREIGN</h1>
            <p class="text-xs tracking-[0.5em] text-gray-400 uppercase mb-10">L∆∞u Thi·∫øt Hoa ‚Ä¢ V44.0 Builder</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('vocab')" class="py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs uppercase tracking-widest transition">Luy·ªán T·ª´</button>
                <button onclick="switchTab('speaking')" class="py-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-bold text-xs uppercase tracking-widest transition shadow-lg shadow-indigo-500/30">Luy·ªán N√≥i</button>
            </div>
        </div>
    </div>
</div>

<div id="reading" class="tab-content"></div>
<div id="vocab" class="tab-content"></div>
<div id="speaking" class="tab-content"></div>
<div id="grammar" class="tab-content"></div>
<div id="music" class="tab-content"></div>

<script>
    // ==========================================
    // 1. C·∫§U H√åNH DANH S√ÅCH MODEL C·ª¶A B·∫†N
    // ==========================================
    // B·∫†N H√ÉY ƒêI·ªÄN C√ÅC FILE C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    const MY_DECORATIONS = [
        { name: "C√¢y Xanh", file: "./tree.glb" }, // V√≠ d·ª•
        { name: "Gh·∫ø ƒê√°", file: "./bench.glb" },  // V√≠ d·ª•
        { name: "ƒê√®n ƒê∆∞·ªùng", file: "./lamp.glb" }, // V√≠ d·ª•
        // B·∫°n c√≥ th·ªÉ th√™m file jpg/png d·∫°ng billboard sau
        // { name: "B·ª•i C·ªè (2D)", file: "./grass.png", type: "2d" } 
    ];

    // --- INIT LIST ---
    const listContainer = document.getElementById('model-list-content');
    if(listContainer) {
        MY_DECORATIONS.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'model-option text-white text-xs font-bold';
            div.innerHTML = `<span>Example Icon</span> <span>${item.name}</span>`;
            div.onclick = () => spawnObject(item.file);
            listContainer.appendChild(div);
        });
    }

    // ==========================================
    // 2. GAME LOGIC (3D BUILDER)
    // ==========================================
    let gameInited = false;
    let scene, camera, renderer, playerModel, mixer;
    let keys = { w: false, a: false, s: false, d: false, shift: false };
    let clock = new THREE.Clock();
    let actions = {};
    let activeAction;
    let raycaster, mouse;
    let placedObjects = []; // L∆∞u danh s√°ch c√°c v·∫≠t ƒë√£ ƒë·∫∑t
    let selectedObject = null; // V·∫≠t ƒëang ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ s·ª≠a

    function enterGameWorld() {
        document.getElementById('game-container').style.display = 'block';
        if (!gameInited) initGame();
    }
    function exitGameWorld() { document.getElementById('game-container').style.display = 'none'; }
    function toggleObjPanel() { 
        const p = document.getElementById('obj-panel'); 
        p.style.display = p.style.display === 'block' ? 'none' : 'block'; 
    }

    function initGame() {
        gameInited = true;
        const container = document.getElementById('game-container');
        
        scene = new THREE.Scene();
        // T·∫†O B·∫¶U TR·ªúI (SKYBOX) - M√†u xanh d·ªãu
        scene.background = new THREE.Color(0x87CEEB); 
        scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 20); // Camera cao h∆°n ch√∫t
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // LIGHTING
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2); 
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(20, 50, 20);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // --- MAP: HUD.GLB (M√¥i tr∆∞·ªùng ch√≠nh) ---
        const loader = new THREE.GLTFLoader();
        loader.load('./hud.glb', function (gltf) {
            const map = gltf.scene;
            map.scale.set(10, 10, 10); // Ph√≥ng to HUD l√™n ƒë·ªÉ nh√¢n v·∫≠t ƒëi b√™n trong
            map.position.set(0, -0.5, 0); // H·∫° th·∫•p xu·ªëng ch√∫t
            map.traverse(c => {
                if(c.isMesh) { c.receiveShadow = true; c.castShadow = true; }
            });
            scene.add(map);
            console.log("HUD Map Loaded");
        }, undefined, function(e){
            console.warn("Ch∆∞a c√≥ hud.glb, t·∫°o s√†n t·∫°m");
            const grid = new THREE.GridHelper(100, 100);
            scene.add(grid);
        });

        // --- PLAYER: MEN.GLB ---
        loader.load('./men.glb', function (gltf) {
            playerModel = gltf.scene;
            playerModel.scale.set(1, 1, 1);
            scene.add(playerModel);

            // X·ª≠ l√Ω material
            playerModel.traverse((child) => {
                if (child.isMesh) {
                    child.material.metalness = 0.0;
                    child.material.roughness = 0.8;
                    child.castShadow = true;
                }
            });

            // Animation strict logic
            mixer = new THREE.AnimationMixer(playerModel);
            const clips = gltf.animations;
            const getClip = (name, exclude) => clips.find(c => {
                const n = c.name.toLowerCase();
                if (!n.includes(name.toLowerCase())) return false;
                for (let ex of exclude) if (n.includes(ex.toLowerCase())) return false;
                return true;
            });
            
            const idle = getClip('Idle', ['Walk','Run','to']) || clips[0];
            const walk = getClip('Walk', ['Idle','Run','to']);
            const run = getClip('Run', ['Walk','Idle','to']);

            if(idle) { actions['Idle'] = mixer.clipAction(idle); actions['Idle'].play(); }
            if(walk) actions['Walk'] = mixer.clipAction(walk);
            if(run) actions['Run'] = mixer.clipAction(run);
            
            activeAction = actions['Idle'];
            animate();
        });

        // --- INTERACTION ---
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        window.addEventListener('click', onMouseClick, false);
        
        // Load c√°c v·∫≠t th·ªÉ ƒë√£ l∆∞u
        loadSavedWorld();

        // Keyboard inputs
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 'w') keys.w = true;
            if(e.key.toLowerCase() === 'a') keys.a = true;
            if(e.key.toLowerCase() === 's') keys.s = true;
            if(e.key.toLowerCase() === 'd') keys.d = true;
            if(e.key.toLowerCase() === 'shift') keys.shift = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key.toLowerCase() === 'w') keys.w = false;
            if(e.key.toLowerCase() === 'a') keys.a = false;
            if(e.key.toLowerCase() === 's') keys.s = false;
            if(e.key.toLowerCase() === 'd') keys.d = false;
            if(e.key.toLowerCase() === 'shift') keys.shift = false;
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }

    // --- BUILDER FUNCTIONS ---
    function spawnObject(file) {
        if(!playerModel) return;
        const loader = new THREE.GLTFLoader();
        loader.load(file, (gltf) => {
            const obj = gltf.scene;
            // ƒê·∫∑t v·∫≠t tr∆∞·ªõc m·∫∑t nh√¢n v·∫≠t
            const spawnPos = playerModel.position.clone();
            spawnPos.z -= 3; 
            spawnPos.y = 0;
            
            obj.position.copy(spawnPos);
            obj.userData = { file: file, id: Date.now() }; // L∆∞u metadata ƒë·ªÉ save
            
            scene.add(obj);
            placedObjects.push(obj);
            
            // Hi·ªáu ·ª©ng spawn
            selectObject(obj);
        }, undefined, (err) => {
            alert("Kh√¥ng t√¨m th·∫•y file model: " + file);
        });
    }

    function onMouseClick(event) {
        // T√≠nh to√°n v·ªã tr√≠ chu·ªôt
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        
        // Ch·ªâ check va ch·∫°m v·ªõi c√°c v·∫≠t ƒë√£ ƒë·∫∑t (kh√¥ng check nh√¢n v·∫≠t hay map n·ªÅn)
        const intersects = raycaster.intersectObjects(placedObjects, true);

        if (intersects.length > 0) {
            // T√¨m object g·ªëc (v√¨ raycaster c√≥ th·ªÉ hit mesh con)
            let rootObj = intersects[0].object;
            while(rootObj.parent && rootObj.parent !== scene) {
                rootObj = rootObj.parent;
            }
            selectObject(rootObj);
        } else {
            // Click ra ngo√†i th√¨ b·ªè ch·ªçn
            if(event.target.id === 'game-container' || event.target.tagName === 'CANVAS') {
                deselectObject();
            }
        }
    }

    function selectObject(obj) {
        if(selectedObject) {
            // Reset m√†u v·∫≠t c≈© (n·∫øu c√≥ logic highlight)
        }
        selectedObject = obj;
        // Hi·ªán Box bao quanh ƒë·ªÉ bi·∫øt ƒëang ch·ªçn
        const box = new THREE.BoxHelper(selectedObject, 0xffff00);
        box.name = "selectionBox";
        scene.add(box);
        
        // Hi·ªán UI s·ª≠a
        document.getElementById('edit-controls').style.display = 'flex';
    }

    function deselectObject() {
        const oldBox = scene.getObjectByName("selectionBox");
        if(oldBox) scene.remove(oldBox);
        selectedObject = null;
        document.getElementById('edit-controls').style.display = 'none';
    }

    function modifySelected(action, value) {
        if(!selectedObject) return;
        
        if(action === 'scale') {
            const s = selectedObject.scale.x + value;
            if(s > 0.1) selectedObject.scale.set(s,s,s);
        }
        if(action === 'rotate') {
            selectedObject.rotation.y += value;
        }
        if(action === 'delete') {
            scene.remove(selectedObject);
            placedObjects = placedObjects.filter(o => o !== selectedObject);
            deselectObject();
        }
        // Update box helper
        const oldBox = scene.getObjectByName("selectionBox");
        if(oldBox) oldBox.update();
    }

    function saveWorld() {
        const data = placedObjects.map(obj => ({
            file: obj.userData.file,
            pos: { x: obj.position.x, y: obj.position.y, z: obj.position.z },
            rot: { x: obj.rotation.x, y: obj.rotation.y, z: obj.rotation.z },
            scl: { x: obj.scale.x, y: obj.scale.y, z: obj.scale.z }
        }));
        localStorage.setItem('skyWorldData', JSON.stringify(data));
        alert("ƒê√£ l∆∞u th·∫ø gi·ªõi! F5 l·∫°i v·∫´n c√≤n nguy√™n.");
    }

    function loadSavedWorld() {
        const json = localStorage.getItem('skyWorldData');
        if(!json) return;
        const data = JSON.parse(json);
        const loader = new THREE.GLTFLoader();
        
        data.forEach(item => {
            loader.load(item.file, (gltf) => {
                const obj = gltf.scene;
                obj.position.set(item.pos.x, item.pos.y, item.pos.z);
                obj.rotation.set(item.rot.x, item.rot.y, item.rot.z);
                obj.scale.set(item.scl.x, item.scl.y, item.scl.z);
                obj.userData = { file: item.file, id: Date.now() };
                scene.add(obj);
                placedObjects.push(obj);
            });
        });
    }

    // --- ANIMATION LOOP ---
    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if (playerModel && mixer) {
            let speed = 0; let moveState = 'Idle';
            if (keys.w || keys.s || keys.a || keys.d) {
                if (keys.shift && keys.w) { speed = 8.0; moveState = 'Run'; } 
                else { speed = 4.0; moveState = 'Walk'; }

                if (keys.w) playerModel.position.z -= speed * delta;
                if (keys.s) playerModel.position.z += speed * delta;
                if (keys.a) playerModel.position.x -= speed * delta;
                if (keys.d) playerModel.position.x += speed * delta;

                let angle = 0;
                if (keys.w) angle = Math.PI;
                if (keys.s) angle = 0;
                if (keys.a) angle = -Math.PI / 2;
                if (keys.d) angle = Math.PI / 2;
                
                if (keys.w && keys.a) angle = -3 * Math.PI / 4;
                if (keys.w && keys.d) angle = 3 * Math.PI / 4;
                if (keys.s && keys.a) angle = -Math.PI / 4;
                if (keys.s && keys.d) angle = Math.PI / 4;

                const targetRotation = new THREE.Quaternion();
                targetRotation.setFromAxisAngle(new THREE.Vector3(0, 1, 0), angle);
                playerModel.quaternion.slerp(targetRotation, 0.15); 
            }
            if(activeAction !== actions[moveState] && actions[moveState]) {
                activeAction.fadeOut(0.2);
                activeAction = actions[moveState];
                activeAction.reset().fadeIn(0.2).play();
            }
            mixer.update(delta);
            
            // CAMERA FOLLOW
            camera.position.x = playerModel.position.x;
            camera.position.z = playerModel.position.z + 10;
            camera.position.y = playerModel.position.y + 10;
            camera.lookAt(playerModel.position);
        }
        renderer.render(scene, camera);
    }

    // --- LOGIC H·ªåC T·∫¨P (GI·ªÆ NGUY√äN V29 ƒê·ªÇ KH√îNG B·ªä L·ªñI) ---
    // (Ph·∫ßn n√†y t√¥i ƒë√£ restore l·∫°i y h·ªát ph·∫ßn script V29 c·ªßa b·∫°n)
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-' + id).classList.add('active');
    }
    window.onload = () => { switchTab('home'); };
</script>
</body>
</html>
