<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Hub | V47.0 Stable & Fixes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* CORE CSS */
        :root { --primary: #6366f1; --accent: #f472b6; }
        body {
            font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #020617, #1e1b4b, #be185d, #0f766e);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff; min-height: 100vh; overflow-x: hidden; cursor: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #cursor { position: fixed; width: 20px; height: 20px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s; }
        
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .glass-card:hover { transform: translateY(-5px); }
        nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 6px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; justify-content: center; width: 90%; max-width: 600px; }
        .nav-btn { padding: 10px 16px; border-radius: 18px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; color: #94a3b8; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.5s forwards; padding-bottom: 120px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* UTILS */
        .glow-green { box-shadow: 0 0 40px #22c55e !important; border-color: #22c55e !important; }
        .glow-red { box-shadow: 0 0 40px #ef4444 !important; border-color: #ef4444 !important; }
        .mic-ripple { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--primary); opacity: 0; animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }
        #progress-bar { width: 0%; height: 4px; background: #22c55e; transition: width 0.1s linear; position: absolute; bottom: 0; left: 0; }
        .reading-text { line-height: 1.8; letter-spacing: 1px; text-align: justify; }
        textarea:focus { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        .coin-pop-green { animation: coinPop 0.3s ease; color: #4ade80 !important; }
        .coin-pop-red { animation: coinPop 0.3s ease; color: #f87171 !important; }
        @keyframes coinPop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        
        /* MODALS */
        .full-modal { transition: opacity 0.3s ease; }
        .full-modal.hidden { display: none; }
        .npc-bubble { position: absolute; background: white; color: black; padding: 12px; border-radius: 20px; border-bottom-left-radius: 0; box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); font-weight: 800; font-size: 10px; max-width: 200px; border: 2px solid #6366f1; z-index: 50; }
        .inv-slot { width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .inv-slot:hover { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .song-item { display: flex; gap: 12px; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; align-items: center; }
        .song-item:hover { background: rgba(255,255,255,0.15); }
        .song-item img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }

        /* GAME CANVAS */
        #game-container { position: fixed; inset: 0; z-index: 5000; background: #87CEEB; display: none; pointer-events: auto; }
        #game-ui { position: absolute; top: 20px; left: 20px; color: white; z-index: 5001; pointer-events: none; }
        .key-hint { background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; font-size: 10px; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="cursor"></div>
<audio id="sfx-coin" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
<audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-click-900.mp3"></audio>

<div class="fixed top-6 right-6 z-[2000] flex items-center gap-3 bg-black/40 backdrop-blur-xl px-5 py-2 rounded-full border border-yellow-500/30 shadow-2xl transition hover:scale-105">
    <div class="w-10 h-10">
        <model-viewer src="./coin.glb" alt="Coin" auto-rotate rotation-per-second="30deg" disable-zoom style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
    </div>
    <div class="flex flex-col items-end">
        <span class="text-[9px] font-bold text-yellow-500/80 uppercase tracking-widest">Balance</span>
        <span id="coin-display" class="text-2xl font-black text-yellow-400 leading-none tabular-nums">0</span>
    </div>
</div>

<div class="fixed top-32 right-6 z-[2000] cursor-pointer transition hover:scale-110 active:scale-95 group flex flex-col items-center" onclick="enterGameWorld()">
    <div class="w-16 h-16 bg-indigo-900/80 rounded-full border-2 border-indigo-400 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <span class="text-3xl">üè∞</span>
    </div>
    <div class="bg-indigo-600 text-white px-2 py-1 rounded text-[8px] font-bold uppercase mt-1">V√†o Th·∫ø Gi·ªõi</div>
</div>

<div id="game-container">
    <div id="game-ui">
        <h2 class="text-xl font-black uppercase text-white drop-shadow-md">Skyreign World</h2>
        <div class="mt-2 text-xs text-white">
            <p class="mb-1"><span class="key-hint">W A S D</span> Di chuy·ªÉn</p>
            <p><span class="key-hint">SHIFT</span> Ch·∫°y</p>
        </div>
    </div>
    <button onclick="exitGameWorld()" class="absolute top-6 right-6 z-[5002] text-white hover:text-red-500 font-black text-xl bg-black/40 w-12 h-12 rounded-full flex items-center justify-center border border-white/20">‚úï</button>
</div>

<div class="fixed bottom-24 left-6 z-[2000] cursor-pointer transition hover:scale-110 active:scale-95 group" onclick="openInventory()">
    <div class="w-24 h-24 relative">
        <model-viewer src="./loot.glb" alt="Inventory" auto-rotate rotation-per-second="20deg" disable-zoom style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
        <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-3 py-1 rounded-full font-black text-[8px] uppercase tracking-widest opacity-0 group-hover:opacity-100 transition whitespace-nowrap shadow-lg border border-white/20">T√∫i ƒê·ªì</div>
    </div>
</div>

<div id="shop-modal" class="full-modal hidden fixed inset-0 z-[3000] bg-black/95 flex items-center justify-center p-4">
    <div class="relative w-full max-w-6xl aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/10">
        <button onclick="closeShop()" class="absolute top-6 right-6 z-50 text-white hover:text-red-500 font-black text-xl bg-white/10 w-12 h-12 rounded-full flex items-center justify-center border border-white/20 transition hover:rotate-90">‚úï</button>
        <div class="absolute bottom-10 left-10 w-48 h-80 md:w-64 md:h-96 z-20">
            <model-viewer src="./main.glb" alt="Shopkeeper" environment-image="neutral" camera-controls disable-zoom shadow-intensity="2" exposure="1.5" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
            <div class="npc-bubble -top-10 left-20"><p id="npc-text">...</p></div>
        </div>
        <div class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
            <div class="relative w-72 h-72 md:w-[500px] md:h-[500px] pointer-events-auto group flex flex-col items-center">
                <button onclick="buyItem()" class="absolute -top-16 z-50 bg-yellow-500 hover:bg-yellow-400 text-black px-6 py-3 rounded-full font-black uppercase tracking-widest shadow-lg shadow-yellow-500/50 animate-bounce transition transform hover:scale-110 border-4 border-black">MUA NGAY (100 ü™ô)</button>
                <model-viewer id="shop-mob-viewer" src="./mob1.glb" alt="Mob" environment-image="neutral" auto-rotate camera-controls shadow-intensity="2" exposure="1.5" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                <div class="absolute top-20 -right-10 md:-right-20 bg-black/80 backdrop-blur-xl border border-red-500/50 p-6 rounded-2xl w-56 shadow-2xl opacity-0 group-hover:opacity-100 transition duration-300 translate-x-4 group-hover:translate-x-0">
                    <h3 class="text-red-500 font-black text-3xl mb-2 uppercase italic tracking-tighter" id="mob-name">RAICER</h3>
                    <div class="space-y-3 text-xs font-bold text-gray-400">
                        <div class="flex justify-between border-b border-white/10 pb-1"><span>‚öî T·∫•n C√¥ng:</span> <span class="text-white" id="mob-atk">200</span></div>
                        <div class="flex justify-between border-b border-white/10 pb-1"><span>‚ô• M√°u:</span> <span class="text-white" id="mob-hp">900</span></div>
                        <div class="mt-2 text-[10px] italic text-gray-500 text-center">Qu√°i v·∫≠t c·∫•p 1</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-30 flex gap-4">
            <button onclick="navShop(-1)" class="px-6 py-3 bg-white/5 hover:bg-white/20 border border-white/20 rounded-xl font-bold text-xs uppercase tracking-widest text-gray-300 hover:text-white transition flex items-center gap-2">‚óÄ L√πi l·∫°i</button>
            <button onclick="navShop(1)" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 shadow-lg shadow-indigo-500/50 rounded-xl font-bold text-xs uppercase tracking-widest text-white transition flex items-center gap-2">Ti·∫øp theo ‚ñ∂</button>
        </div>
    </div>
</div>

<div id="inv-modal" class="full-modal hidden fixed inset-0 z-[3000] bg-black/90 flex items-center justify-center p-4">
    <div class="relative w-full max-w-5xl aspect-video bg-[#1a1a1a] rounded-3xl overflow-hidden shadow-2xl border border-white/10">
        <img src="./iv.jpg" alt="Inventory BG" class="absolute inset-0 w-full h-full object-cover opacity-60">
        <button onclick="closeInventory()" class="absolute top-6 right-6 z-50 text-white hover:text-red-500 font-black text-xl bg-black/60 w-12 h-12 rounded-full flex items-center justify-center border border-white/20">‚úï</button>
        <div class="absolute inset-0 flex flex-col p-10 z-10">
            <div class="flex-1 flex justify-between items-center px-10">
                <div class="flex flex-col gap-4">
                    <div class="inv-slot"><span class="text-[8px] text-white/30">HEAD</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">BODY</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">LEGS</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">HAND</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">ACC</span></div>
                </div>
                <div class="relative w-96 h-96 flex items-center justify-center">
                    <div id="inv-mob-container" class="w-full h-full"></div>
                    <div id="inv-stats" class="hidden absolute top-10 -right-10 bg-black/70 backdrop-blur border border-indigo-500/50 p-4 rounded-xl w-40">
                        <h4 class="text-indigo-400 font-bold text-xs uppercase mb-2 border-b border-white/10 pb-1">Ch·ªâ S·ªë T·ªïng</h4>
                        <div class="space-y-1 text-[10px] text-gray-300">
                            <div class="flex justify-between"><span>ATK:</span> <span class="text-white">200</span></div>
                            <div class="flex justify-between"><span>HP:</span> <span class="text-white">900</span></div>
                            <div class="flex justify-between"><span>DEF:</span> <span class="text-white">50</span></div>
                            <div class="flex justify-between"><span>SPD:</span> <span class="text-white">120</span></div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="inv-slot"><span class="text-[8px] text-white/30">WEAPON</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">SHIELD</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">RING 1</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">RING 2</span></div>
                    <div class="inv-slot"><span class="text-[8px] text-white/30">PET</span></div>
                </div>
            </div>
            <div class="h-32 mt-4 bg-black/40 rounded-xl border border-white/10 p-4">
                <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">T√∫i ƒê·ªì (Inventory)</h4>
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div><div class="inv-slot min-w-[50px]"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<nav>
    <button onclick="switchTab('home')" class="nav-btn active" id="n-home">S·∫£nh</button>
    <button onclick="switchTab('vocab')" class="nav-btn" id="n-vocab">H·ªçc T·ª´</button>
    <button onclick="switchTab('reading')" class="nav-btn" id="n-reading">ƒê·ªçc Hi·ªÉu</button>
    <button onclick="switchTab('speaking')" class="nav-btn" id="n-speaking">Luy·ªán N√≥i</button>
    <button onclick="switchTab('grammar')" class="nav-btn" id="n-grammar">Ng·ªØ Ph√°p</button>
    <button onclick="switchTab('music')" class="nav-btn" id="n-music">Nh·∫°c</button>
</nav>

<div id="home" class="tab-content active">
    <div class="h-screen flex flex-col items-center justify-center relative">
        <div class="absolute top-24 left-10 cursor-pointer transition hover:scale-110 active:scale-95 group z-20" onclick="openShop()">
            <div class="w-32 h-32 relative">
                <model-viewer src="./shop.glb" alt="My Shop" auto-rotate camera-controls shadow-intensity="1" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer>
                <div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black px-3 py-1 rounded-full font-black text-[9px] uppercase tracking-widest opacity-0 group-hover:opacity-100 transition whitespace-nowrap shadow-lg border-2 border-white">C·ª≠a H√†ng</div>
            </div>
        </div>
        <div class="glass-card p-12 text-center max-w-md mx-4 z-10">
            <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400">SKYREIGN</h1>
            <p class="text-xs tracking-[0.5em] text-gray-400 uppercase mb-10">L∆∞u Thi·∫øt Hoa ‚Ä¢ V47.0 Fixed</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="switchTab('vocab')" class="py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs uppercase tracking-widest transition">Luy·ªán T·ª´</button>
                <button onclick="switchTab('speaking')" class="py-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-bold text-xs uppercase tracking-widest transition shadow-lg shadow-indigo-500/30">Luy·ªán N√≥i</button>
            </div>
        </div>
    </div>
</div>

<div id="reading" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-8 w-full max-w-3xl mx-4 relative" id="reading-card"> <div class="flex justify-between items-center mb-6"> <div class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest">ƒêo·∫°n VƒÉn Ng·∫´u Nhi√™n</div> <div class="flex gap-2"> <button id="r-toggle-btn" onclick="toggleReadingRef()" class="text-[10px] font-bold text-green-400 hover:text-white uppercase tracking-widest transition border border-green-500 px-2 py-1 rounded-lg">Xem ƒê√°p √Ån (Vi·ªát)</button> <button onclick="nextParagraph()" class="text-[10px] font-bold text-gray-400 hover:text-white uppercase tracking-widest transition">ƒê·ªïi b√†i kh√°c ‚Üª</button> </div> </div> <div class="bg-black/20 p-6 rounded-2xl mb-6 border border-white/10 h-64 overflow-y-auto"> <p id="r-text" class="text-xl md:text-2xl font-medium text-gray-100 reading-text">Loading...</p> </div> <p class="text-xs text-gray-400 mb-2 italic">H√£y d·ªãch ƒëo·∫°n vƒÉn tr√™n sang Ti·∫øng Vi·ªát (+1 Coin n·∫øu ƒë√∫ng):</p> <textarea id="r-input" rows="4" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white placeholder-gray-600 outline-none focus:border-indigo-500 transition mb-6" placeholder="G√µ b·∫£n d·ªãch c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea> <button onclick="checkReading()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-indigo-400 hover:text-white transition mb-4 shadow-lg">Ki·ªÉm Tra B·∫£n D·ªãch</button> <div id="r-feedback" class="text-center min-h-[40px]"> <p id="r-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></p> </div> </div> </div> </div>
<div id="vocab" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-10 w-full max-w-lg mx-4 relative" id="vocab-card"> <div class="flex justify-between items-center mb-8"> <button onclick="changeVocabMode()" id="v-mode-btn" class="text-[10px] font-black bg-pink-500 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-105 transition">Mode: H√°n ‚ûî Vi·ªát</button> <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">HSK 1 FULL</div> </div> <div id="v-question" class="text-7xl font-black text-center mb-8 tracking-tighter min-h-[100px] flex items-center justify-center">?</div> <input type="text" id="v-input" placeholder="Nh·∫≠p ƒë√°p √°n..." class="w-full bg-transparent border-b-2 border-white/20 py-3 text-center font-bold text-2xl outline-none focus:border-indigo-500 transition text-white placeholder-gray-600 mb-8" autocomplete="off"> <button onclick="checkVocab()" class="w-full py-4 bg-white text-black rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-gray-200 transition mb-4">Ki·ªÉm Tra</button> <div id="v-feedback" class="text-center h-10"> <p id="v-msg" class="text-[11px] font-bold uppercase tracking-widest"></p> <p id="v-hint" class="text-[12px] font-bold text-red-400 mt-1 uppercase hidden"></p> </div> </div> </div> </div>
<div id="speaking" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-10 w-full max-w-md mx-4 text-center relative overflow-hidden" id="speak-card"> <div class="text-[10px] uppercase tracking-widest text-indigo-400 font-black mb-8">V18.0 - Fast Catch</div> <div class="mb-8 relative group"> <div id="s-hz" class="text-9xl font-black mb-2 tracking-tighter cursor-pointer transition hover:text-indigo-400" onclick="speakText(document.getElementById('s-hz').innerText)">Êàë</div> <div id="s-py" class="text-2xl text-gray-500 mb-1">w«í</div> <div id="s-mn" class="text-xs font-bold bg-white/10 px-3 py-1 rounded-full inline-block">T√îI</div> </div> <div class="flex justify-center items-center gap-6 mb-8"> <button onclick="changeSpeakWord(-1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">‚Üê</button> <div class="relative"> <div id="mic-ring" class="hidden mic-ripple"></div> <button id="mic-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl relative z-10 transition hover:scale-110 active:scale-90 text-white"> <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg> </button> </div> <button onclick="changeSpeakWord(1)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition">‚Üí</button> </div> <div id="s-feedback" class="text-[11px] font-bold uppercase tracking-widest text-gray-400 h-16 flex flex-col items-center justify-center px-4"> <span id="s-status">B·∫•m mic v√† n√≥i ngay</span> <span id="s-sub" class="text-[9px] text-gray-500 mt-1"></span> </div> <div id="s-live-text" class="absolute bottom-1 w-full text-center text-[9px] text-indigo-300/50 uppercase tracking-widest"></div> <div id="progress-bar"></div> </div> </div> </div>
<div id="grammar" class="tab-content"> <div class="min-h-screen flex items-center justify-center pt-20"> <div class="glass-card p-10 w-full max-w-2xl mx-4 relative overflow-hidden" id="grammar-card"> <div class="flex justify-between items-center mb-10"> <button onclick="toggleGrammarMode()" id="g-mode-badge" class="text-[10px] font-black bg-indigo-600 px-3 py-1 rounded-full uppercase tracking-widest hover:scale-110 transition shadow-lg shadow-indigo-500/50">Trung ‚ûî Vi·ªát</button> <div class="text-[9px] font-bold text-gray-400">HSK1 GRAMMAR</div> </div> <div class="text-center mb-10 min-h-[120px] flex flex-col justify-center items-center"> <div id="g-question" class="text-4xl md:text-5xl font-bold tracking-tight mb-4 leading-tight drop-shadow-lg cursor-pointer hover:text-indigo-300 transition" onclick="readGrammarQuestion()">...</div> <p id="g-instruction" class="text-gray-500 text-sm italic">H√£y d·ªãch c√¢u tr√™n</p> </div> <input type="text" id="g-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." class="w-full bg-transparent border-b-2 border-white/10 py-4 text-center text-xl font-medium outline-none focus:border-indigo-500 transition mb-6" text-white placeholder-gray-600" autocomplete="off"> <div class="grid grid-cols-4 gap-4 mb-6"> <button onclick="nextGrammar()" class="col-span-1 py-4 bg-white/5 hover:bg-white/10 rounded-2xl font-bold text-[10px] uppercase tracking-widest text-gray-400 hover:text-white transition">B·ªè qua</button> <button onclick="checkGrammar()" class="col-span-3 py-4 bg-white text-black hover:bg-indigo-400 hover:text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] transition shadow-lg">Ki·ªÉm tra</button> </div> <div id="g-feedback" class="text-center h-20"> <div id="g-msg" class="text-[11px] font-bold uppercase tracking-widest mb-1"></div> <div id="g-note" class="text-[12px] font-bold text-red-400 mt-2 uppercase"></div> </div> </div> </div> </div>

<div id="music" class="tab-content"> 
    <div class="min-h-screen flex flex-col items-center justify-center pt-20 pb-20"> 
        <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-6xl px-4"> 
            <div class="glass-card p-6 w-full md:w-72 h-80 overflow-y-auto"> <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-indigo-400 border-b border-white/10 pb-2">V-Pop Hits</h3> 
                <div id="v-list" class="space-y-2"></div> 
            </div> 
            <div class="w-full max-w-md flex flex-col items-center"> 
                <h4 class="text-4xl font-black text-white tracking-tighter uppercase mb-4 drop-shadow-lg">Music Pod</h4> 
                <div class="relative w-full h-[250px]"> <model-viewer src="./airpods.glb" alt="My Airpods" auto-rotate camera-controls shadow-intensity="1" exposure="0.8" style="width: 100%; height: 100%; --poster-color: transparent;"></model-viewer> 
                </div> 
                <div class="w-full aspect-video bg-black rounded-2xl overflow-hidden border-2 border-white/20 shadow-2xl mt-[-20px] relative z-10"> 
                    <div id="player"></div> <video id="mp4-player" controls playsinline class="hidden w-full h-full object-cover"></video> 
                </div> 
            </div> 
            <div class="glass-card p-6 w-full md:w-72 h-80 overflow-y-auto"> <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-pink-400 border-b border-white/10 pb-2">Chinese Hits</h3> 
                <div id="c-list" class="space-y-2"></div> 
            </div> 
        </div> 
    </div> 
</div>

<script>
    // --- 1. CORE DATA & LEARNING LOGIC ---
    let userCoins = parseInt(localStorage.getItem('skyCoins')) || 0;
    let myMobs = JSON.parse(localStorage.getItem('skyMobs')) || [];
    const coinDisplay = document.getElementById('coin-display');
    const coinSfx = document.getElementById('sfx-coin');
    const clickSfx = document.getElementById('sfx-click');
    
    // FIX COIN DISPLAY INIT
    if(coinDisplay) coinDisplay.innerText = userCoins;

    function updateCoins(amount) {
        userCoins += amount;
        localStorage.setItem('skyCoins', userCoins);
        if(coinDisplay) {
            coinDisplay.innerText = userCoins;
            coinDisplay.classList.remove('coin-pop-green', 'coin-pop-red');
            void coinDisplay.offsetWidth;
            if(amount > 0) { coinDisplay.classList.add('coin-pop-green'); coinSfx.currentTime = 0; coinSfx.play().catch(e=>{}); } 
            else { coinDisplay.classList.add('coin-pop-red'); }
        }
    }

    // --- 2. VOCAB & READING DATA (FULL) ---
    const vocabData = [
        { hz: "Êàë", py: "w«í", mn: "t√¥i" }, { hz: "‰Ω†", py: "n«ê", mn: "b·∫°n" }, { hz: "‰ªñ", py: "tƒÅ", mn: "anh ·∫•y" },
        { hz: "ÊòØ", py: "sh√¨", mn: "l√†" }, { hz: "‰∏ç", py: "b√π", mn: "kh√¥ng" }, { hz: "Âêó", py: "ma", mn: "kh√¥ng (h·ªèi)" }
        // (Th√™m ƒë·ªß 150 t·ª´ c·ªßa b·∫°n v√†o ƒë√¢y n·∫øu mu·ªën, code s·∫Ω t·ª± ch·∫°y)
    ];
    const readingData = [
        { id: 1, zh: "‰Ω†Â•ΩÔºÅÊàëÂè´ÂàòÈìÅËä±...", key: "xin ch√†o t√¥i t√™n l∆∞u thi·∫øt hoa", vi_display: "Xin ch√†o! T√¥i t√™n L∆∞u Thi·∫øt Hoa..." }
    ];
    const grammarBank = [{zh:"ÊàëÊòØÂ≠¶Áîü„ÄÇ",vi:"t√¥i l√† h·ªçc sinh",note:"C√¢u ch·ªØ ÊòØ"}];

    // --- 3. LOGIC KH·ªûI T·∫†O (QUAN TR·ªåNG) ---
    let vMode=0, vIdx=0, rIdx=0, isShowingAnswer=false, remainingIndices=[];
    
    function initVocabSystem() {
        const saved = localStorage.getItem('skyVocabProgress');
        if (saved) {
            try { remainingIndices = JSON.parse(saved); if (!Array.isArray(remainingIndices) || remainingIndices.length === 0) resetVocabProgress(); } catch (e) { resetVocabProgress(); }
        } else { resetVocabProgress(); }
        // LOAD DATA NGAY L·∫¨P T·ª®C
        if(vocabData.length > 0) nextVocab(true);
        if(readingData.length > 0) nextParagraph();
    }
    
    function resetVocabProgress() { remainingIndices = Array.from({length: vocabData.length}, (_, i) => i); localStorage.setItem('skyVocabProgress', JSON.stringify(remainingIndices)); }

    // --- 4. C√ÅC H√ÄM X·ª¨ L√ù H·ªåC T·∫¨P (GI·ªÆ NGUY√äN) ---
    function nextVocab(random=true) {
        if(remainingIndices.length===0) { resetVocabProgress(); }
        if(random && remainingIndices.length > 0) vIdx = remainingIndices[Math.floor(Math.random() * remainingIndices.length)];
        const item = vocabData[vIdx];
        if(!item) return;
        document.getElementById('v-question').innerText = vMode===0 ? item.hz : (vMode===1 ? item.mn.toUpperCase() : item.hz);
    }
    function checkVocab() { /* Logic c≈©... */ updateCoins(1); nextVocab(true); } 
    
    // ƒê·ªçc hi·ªÉu
    function nextParagraph() {
        if(readingData.length === 0) return;
        let newIdx; do { newIdx = Math.floor(Math.random() * readingData.length); } while (newIdx === rIdx && readingData.length > 1);
        rIdx = newIdx;
        const item = readingData[rIdx];
        document.getElementById('r-text').innerText = item.zh;
    }
    function toggleReadingRef() {
        const item = readingData[rIdx];
        isShowingAnswer = !isShowingAnswer;
        document.getElementById('r-text').innerText = isShowingAnswer ? item.vi_display : item.zh;
    }

    // --- 5. MUSIC LOGIC (FIX) ---
    const vPop = [{name:"H√¥n v√†o ƒë√¢y",type:"mp4",id:"https://files.catbox.moe/kos9gw.mp4",thumb:"https://img.youtube.com/vi/vs-hsW6I63I/mqdefault.jpg"}];
    const cPop = [{name:"Mang Ch·ªßng",type:"mp4",id:"https://files.catbox.moe/g2tdte.mp4",thumb:"https://img.youtube.com/vi/vgbrIy08e2w/mqdefault.jpg"}];
    function renderMusic() {
        const tpl = (s) => `<div class="song-item" onclick="playMedia('${s.id}')"><img src="${s.thumb}"><div><h4 class="text-[10px] font-bold uppercase">${s.name}</h4></div></div>`;
        document.getElementById('v-list').innerHTML = vPop.map(tpl).join('');
        document.getElementById('c-list').innerHTML = cPop.map(tpl).join('');
    }
    function playMedia(src) {
        const v = document.getElementById('mp4-player');
        v.src = src; v.style.display='block'; v.play();
    }

    // --- 6. GAME WORLD (FIX HUD SCALE & ANIMATION) ---
    let gameInited = false, scene, camera, renderer, playerModel, mixer;
    let keys = { w: false, a: false, s: false, d: false, shift: false };
    let clock = new THREE.Clock(), actions = {}, activeAction;

    function enterGameWorld() { document.getElementById('game-container').style.display='block'; if(!gameInited) initGame(); }
    function exitGameWorld() { document.getElementById('game-container').style.display='none'; }

    function initGame() {
        gameInited = true;
        const container = document.getElementById('game-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky blue
        scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5); scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(10, 20, 10); dirLight.castShadow = true; scene.add(dirLight);

        const loader = new THREE.GLTFLoader();
        
        // HUD (M√îI TR∆Ø·ªúNG) - SCALE 5 NH∆Ø V32
        loader.load('./hud.glb', function(gltf) {
            const map = gltf.scene;
            map.scale.set(5, 5, 5); // FIX: Tr·∫£ v·ªÅ 5 (kh√¥ng ph·∫£i 10)
            map.position.y = -0.5;
            map.traverse(c => { if(c.isMesh) c.receiveShadow = true; });
            scene.add(map);
        });

        // PLAYER (MEN.GLB)
        loader.load('./men.glb', function(gltf) {
            playerModel = gltf.scene;
            scene.add(playerModel);
            
            mixer = new THREE.AnimationMixer(playerModel);
            const clips = gltf.animations;
            
            // LOGIC L·ªåC ANIMATION (Fix l·ªói t∆∞·ª£ng)
            const getClip = (name, exclude) => clips.find(c => {
                const n = c.name.toLowerCase();
                if(!n.includes(name.toLowerCase())) return false;
                for(let ex of exclude) if(n.includes(ex.toLowerCase())) return false;
                return true;
            });

            const idle = getClip('Idle', ['to','Walk']) || clips[0];
            const walk = getClip('Walk', ['to','Idle','Run']);
            const run = getClip('Run', ['to','Walk']);

            if(idle) { actions['Idle'] = mixer.clipAction(idle); actions['Idle'].play(); }
            if(walk) actions['Walk'] = mixer.clipAction(walk);
            if(run) actions['Run'] = mixer.clipAction(run);
            activeAction = actions['Idle'];
            
            animate();
        });

        // INPUTS
        document.addEventListener('keydown', (e) => {
            if(e.key==='w') keys.w=true; if(e.key==='a') keys.a=true;
            if(e.key==='s') keys.s=true; if(e.key==='d') keys.d=true;
            if(e.key==='Shift') keys.shift=true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key==='w') keys.w=false; if(e.key==='a') keys.a=false;
            if(e.key==='s') keys.s=false; if(e.key==='d') keys.d=false;
            if(e.key==='Shift') keys.shift=false;
        });
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if(playerModel && mixer) {
            let speed = 0, move = 'Idle';
            if(keys.w || keys.s || keys.a || keys.d) {
                speed = keys.shift ? 8 : 4;
                move = keys.shift ? 'Run' : 'Walk';
                if(keys.w) playerModel.position.z -= speed * delta;
                if(keys.s) playerModel.position.z += speed * delta;
                if(keys.a) playerModel.position.x -= speed * delta;
                if(keys.d) playerModel.position.x += speed * delta;
                
                let angle = 0;
                if(keys.w) angle = Math.PI; if(keys.s) angle = 0;
                if(keys.a) angle = -Math.PI/2; if(keys.d) angle = Math.PI/2;
                playerModel.rotation.y = angle;
            }
            if(activeAction !== actions[move] && actions[move]) {
                activeAction.fadeOut(0.2); activeAction = actions[move]; activeAction.reset().fadeIn(0.2).play();
            }
            mixer.update(delta);
            camera.position.set(playerModel.position.x, playerModel.position.y + 7, playerModel.position.z + 10);
            camera.lookAt(playerModel.position);
        }
        renderer.render(scene, camera);
    }

    // MAIN INIT
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-'+id).classList.add('active');
        if(id==='vocab') initVocabSystem(); 
        if(id==='reading') nextParagraph();
    }

    window.onload = () => { 
        renderMusic(); 
        switchTab('home'); 
        initVocabSystem(); // Load data ngay t·ª´ ƒë·∫ßu ƒë·ªÉ tr√°nh undefined
    };
</script>
</body>
</html>
