<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chinese Master - Nicksoler Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); }
        .glass-morphism { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        
        /* Hiệu ứng sóng âm khi nói */
        .recording-pulse { animation: pulse 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div class="glass-morphism p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md transition-all">
    <div class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">AI Pronunciation</h1>
            <p class="text-xs text-gray-400 uppercase tracking-widest">Master Chinese</p>
        </div>
        <div id="connection-status" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase">
            </div>
    </div>

    <div class="text-center mb-12">
        <div id="display-hz" class="text-8xl font-bold text-blue-600 mb-4 drop-shadow-sm">你好</div>
        <div id="display-py" class="text-2xl text-gray-400 font-light mb-2">nǐ hǎo</div>
        <div id="display-mn" class="inline-block px-4 py-1 rounded-lg bg-blue-50 text-blue-500 text-sm italic">Xin chào</div>
    </div>

    <div class="h-20 flex flex-col items-center justify-center mb-8">
        <div id="feedback-text" class="text-center text-lg font-medium transition-all duration-300">
            Sẵn sàng để bắt đầu?
        </div>
    </div>

    <div class="flex items-center justify-between gap-4 mb-8">
        <button onclick="changeWord(-1)" class="w-12 h-12 rounded-2xl bg-gray-100 hover:bg-gray-200 text-gray-500 transition">
            <i class="fas fa-arrow-left"></i>
        </button>

        <button id="mic-btn" class="w-24 h-24 rounded-full bg-blue-600 text-white shadow-xl flex items-center justify-center text-3xl hover:bg-blue-700 transition-all active:scale-95">
            <i class="fas fa-microphone"></i>
        </button>

        <button onclick="changeWord(1)" class="w-12 h-12 rounded-2xl bg-gray-100 hover:bg-gray-200 text-gray-500 transition">
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <button onclick="speakTarget()" class="w-full py-4 rounded-2xl bg-white border-2 border-blue-500 text-blue-600 font-bold hover:bg-blue-50 transition flex items-center justify-center gap-3">
        <i class="fas fa-volume-up text-xl"></i> Nghe phát âm chuẩn
    </button>
</div>

<script>
    // 1. Dữ liệu từ vựng
    const vocabulary = [
        { hz: "你好", py: "nǐ hǎo", mn: "Xin chào" },
        { hz: "谢谢", py: "xiè xiè", mn: "Cảm ơn" },
        { hz: "对不起", py: "duì bù qǐ", mn: "Xin lỗi" },
        { hz: "再见", py: "zài jiàn", mn: "Tạm biệt" },
        { hz: "我想吃饭", py: "wǒ xiǎng chī fàn", mn: "Tôi muốn ăn cơm" }
    ];

    let currentIndex = 0;
    const micBtn = document.getElementById('mic-btn');
    const feedback = document.getElementById('feedback-text');
    const statusLabel = document.getElementById('connection-status');

    // 2. Kiểm tra môi trường & Khởi tạo Recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    function initSystem() {
        // Kiểm tra Protocol
        if (location.protocol === 'file:') {
            statusLabel.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Lỗi: Local File`;
            statusLabel.className = "flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-orange-100 text-orange-600";
            feedback.innerHTML = "Vui lòng dùng <b>Live Server</b> hoặc chạy qua <b>https</b> để dùng Mic!";
        } else {
            statusLabel.innerHTML = `<i class="fas fa-check-circle"></i> Online / Secure`;
            statusLabel.className = "flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-green-100 text-green-600";
        }

        if (!SpeechRecognition) {
            feedback.innerHTML = "Trình duyệt của bạn không hỗ trợ nhận diện giọng nói.";
            return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.interimResults = false;

        recognition.onstart = () => {
            micBtn.classList.add('recording-pulse');
            feedback.innerHTML = `<span class="text-blue-500">Đang nghe... Mời bạn nói!</span>`;
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            processResult(transcript);
        };

        recognition.onerror = (event) => {
            micBtn.classList.remove('recording-pulse');
            if (event.error === 'not-allowed') {
                feedback.innerHTML = `<span class="text-red-500 font-bold">LỖI: Trình duyệt chặn Mic. Hãy bấm biểu tượng Khóa trên thanh địa chỉ và chọn 'Allow'.</span>`;
            } else {
                feedback.innerHTML = `<span class="text-gray-400 text-sm">Lỗi: ${event.error}</span>`;
            }
        };

        recognition.onend = () => {
            micBtn.classList.remove('recording-pulse');
        };
    }

    // 3. Logic xử lý kết quả
    function processResult(spoken) {
        const target = vocabulary[currentIndex].hz;
        // Loại bỏ dấu câu để so sánh chính xác
        const cleanTarget = target.replace(/[^\u4e00-\u9fa5]/g, "");
        const cleanSpoken = spoken.replace(/[^\u4e00-\u9fa5]/g, "");

        if (cleanSpoken === cleanTarget) {
            feedback.innerHTML = `<div class="text-green-500 animate-bounce"><i class="fas fa-check-circle"></i> Tuyệt vời!</div><div class="text-sm text-gray-500">Bạn đã nói: ${spoken}</div>`;
            // Tự động phát âm chuẩn lại khi nói đúng để củng cố
            setTimeout(speakTarget, 500);
        } else {
            feedback.innerHTML = `<div class="text-red-500"><i class="fas fa-times-circle"></i> Chưa chính xác</div><div class="text-sm text-gray-500">Kết quả nhận diện: "${spoken}"</div>`;
        }
    }

    // 4. Các hàm điều khiển
    micBtn.onclick = () => {
        if (!recognition) return;
        try {
            recognition.start();
        } catch (e) {
            // Nếu đang chạy thì stop để có thể bấm lại
            recognition.stop();
        }
    };

    function speakTarget() {
        const msg = new SpeechSynthesisUtterance(vocabulary[currentIndex].hz);
        msg.lang = 'zh-CN';
        msg.rate = 0.8;
        window.speechSynthesis.speak(msg);
    }

    function changeWord(direction) {
        currentIndex = (currentIndex + direction + vocabulary.length) % vocabulary.length;
        document.getElementById('display-hz').innerText = vocabulary[currentIndex].hz;
        document.getElementById('display-py').innerText = vocabulary[currentIndex].py;
        document.getElementById('display-mn').innerText = vocabulary[currentIndex].mn;
        feedback.innerHTML = "Sẵn sàng!";
    }

    // Khởi chạy hệ thống
    window.onload = initSystem;
</script>

</body>
</html>