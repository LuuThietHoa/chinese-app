<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreign Hub | V35.0 FINAL DEBUG FIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        :root { --primary: #6366f1; --accent: #f472b6; }
        body { font-family: 'Space Grotesk', sans-serif; background: #000; color: #fff; overflow-x: hidden; }
        #game-container { position: fixed; inset: 0; z-index: 5000; background: black; display: none; }
        #game-ui { position: absolute; top: 20px; left: 20px; color: white; z-index: 5001; pointer-events: none; }
        .key-hint { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; font-size: 10px; font-weight: bold; margin-right: 5px; }
        /* Debug Box để bạn nhìn thấy tên Animation ngay trên màn hình */
        #debug-console { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid lime; color: lime; font-family: monospace; font-size: 10px; z-index: 6000; max-height: 200px; overflow-y: auto; pointer-events: none;}
    </style>
</head>
<body>

<div id="debug-console" style="display:none;">Loading...</div>

<div class="fixed top-32 right-6 z-[2000] cursor-pointer" onclick="enterGameWorld()">
    <div class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">VÀO GAME (TEST FIX)</div>
</div>

<div id="game-container">
    <div id="game-ui">
        <h2 class="text-xl font-black uppercase text-yellow-400">DEBUG MODE</h2>
        <div class="mt-2 text-xs text-gray-300">
            <p class="mb-1"><span class="key-hint">W A S D</span> Di chuyển</p>
            <p><span class="key-hint">SHIFT + W</span> Chạy</p>
        </div>
    </div>
    <div id="debug-console-ingame" style="position: absolute; top: 100px; left: 20px; color: lime; font-family: monospace; background: rgba(0,0,0,0.7); padding: 10px;"></div>
    <button onclick="exitGameWorld()" class="absolute top-6 right-6 z-[5002] text-white font-black text-xl">✕</button>
</div>

<script>
    // --- GAME LOGIC ---
    let gameInited = false;
    let scene, camera, renderer, playerModel, mixer;
    let keys = { w: false, a: false, s: false, d: false, shift: false };
    let clock = new THREE.Clock();
    let actions = {};
    let activeAction, lastAction;

    function enterGameWorld() {
        document.getElementById('game-container').style.display = 'block';
        if (!gameInited) initGame();
    }
    function exitGameWorld() { document.getElementById('game-container').style.display = 'none'; }

    function initGame() {
        gameInited = true;
        const container = document.getElementById('game-container');
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        
        // Đèn sáng trưng để nhìn rõ model
        const ambientLight = new THREE.AmbientLight(0xffffff, 2); 
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 5, 10);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // Load Environment nền
        const loader = new THREE.GLTFLoader();
        loader.load('./hud.glb', (gltf) => {
            gltf.scene.scale.set(5,5,5);
            scene.add(gltf.scene);
        }, undefined, (e) => {});

        // --- LOAD PLAYER ---
        loader.load('./men.glb', function (gltf) {
            playerModel = gltf.scene;
            scene.add(playerModel);

            // Xử lý Material để không bị đen
            playerModel.traverse((child) => {
                if (child.isMesh) {
                    child.material.metalness = 0;
                    child.material.roughness = 1;
                }
            });

            mixer = new THREE.AnimationMixer(playerModel);
            const clips = gltf.animations;

            // === PHẦN QUAN TRỌNG NHẤT: IN DANH SÁCH ANIMATION ===
            let debugHTML = "<b>DANH SÁCH ANIMATION TÌM THẤY:</b><br>";
            clips.forEach((clip, index) => {
                debugHTML += `Index [${index}]: ${clip.name} (Time: ${clip.duration.toFixed(2)}s)<br>`;
            });
            document.getElementById('debug-console-ingame').innerHTML = debugHTML;
            console.log("Danh sách Animation:", clips); // Xem chi tiết ở F12

            // === SỬA THỦ CÔNG TẠI ĐÂY NẾU CẦN ===
            // Dựa trên ảnh Sketchfab bạn gửi, thứ tự thường là:
            // clips[0] = T-Pose hoặc Idle
            // clips[1] = Idle To Walk (Cái gây lỗi!)
            // clips[2] = Walk (Cái chúng ta cần)
            // clips[3] = Walk To Run
            // clips[4] = Run
            
            // Tôi sẽ lấy theo INDEX thay vì tên để tránh nhầm lẫn
            const idleClip = clips[0]; // Thường là cái đầu tiên
            
            // LƯU Ý: Nếu vào game nhân vật vẫn đi sai, bạn hãy đổi số 2 thành số khác (ví dụ 1, 3) dựa vào bảng tên hiện trên màn hình
            const walkClip = clips[2]; 
            
            const runClip = clips[4];  // Thường là cái cuối hoặc số 4

            if(idleClip) { actions['Idle'] = mixer.clipAction(idleClip); actions['Idle'].play(); }
            if(walkClip) { actions['Walk'] = mixer.clipAction(walkClip); }
            if(runClip)  { actions['Run']  = mixer.clipAction(runClip); }

            activeAction = actions['Idle'];
            animate();

        }, undefined, function (error) { console.error(error); });

        // Input
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 'w') keys.w = true;
            if(e.key.toLowerCase() === 'shift') keys.shift = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key.toLowerCase() === 'w') keys.w = false;
            if(e.key.toLowerCase() === 'shift') keys.shift = false;
        });
    }

    function fadeToAction(name, duration) {
        if (activeAction !== actions[name] && actions[name]) {
            lastAction = activeAction;
            activeAction = actions[name];
            lastAction.fadeOut(duration);
            activeAction.reset().fadeIn(duration).play();
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if (playerModel && mixer) {
            let moveState = 'Idle';
            if (keys.w) {
                moveState = keys.shift ? 'Run' : 'Walk';
                playerModel.position.z -= (keys.shift ? 8 : 4) * delta;
            }
            fadeToAction(moveState, 0.2);
            mixer.update(delta);
            
            // Camera follow đơn giản
            camera.position.x = playerModel.position.x;
            camera.position.z = playerModel.position.z + 5;
            camera.position.y = playerModel.position.y + 5;
            camera.lookAt(playerModel.position);
        }
        renderer.render(scene, camera);
    }
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
